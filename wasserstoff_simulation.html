<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wasserstoff-Kostenrechner Simulation "Gruppe 2"</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-page: #ffffff;
            --text-primary: #212529;
            --text-secondary: #495057;
            --border-color: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark theme */
        body.dark-theme {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-page: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
        }

        /* Black theme */
        body.black-theme {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-page: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #333333;
        }

        /* In dunklen Themes: Schrift in den Seiten wei√ü darstellen */
        body.dark-theme .page-section,
        body.dark-theme .page-section * {
            color: #ffffff !important;
        }

        body.black-theme .page-section,
        body.black-theme .page-section * {
            color: #ffffff !important;
        }

        body.dark-theme .results-section,
        body.dark-theme .results-section * {
            color: #ffffff !important;
        }

        body.black-theme .results-section,
        body.black-theme .results-section * {
            color: #ffffff !important;
        }

        /* Light gray theme */
        body.light-gray-theme {
            --bg-primary: #e9ecef;
            --bg-secondary: #f8f9fa;
            --bg-page: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #495057;
            --border-color: #dee2e6;
        }

        /* Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
            color: #1a1a1a;
            padding: 18px 0 20px 0;
            box-shadow: 0 4px 12px rgba(135, 206, 235, 0.3);
            z-index: 1000;
            border-bottom: none;
            transition: padding 0.3s ease, box-shadow 0.3s ease;
        }

        .navbar .nav-container {
            position: relative;
        }

        /* Shrinking header when scrolled - hide logo, keep only tabs */
        .navbar.scrolled {
            padding: 8px 0 10px 0;
            box-shadow: 0 2px 8px rgba(135, 206, 235, 0.2);
        }

        .navbar.scrolled .nav-container {
            gap: 0;
        }

        .navbar.scrolled .nav-logo {
            height: 0;
            overflow: hidden;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .navbar.scrolled .nav-menu a {
            padding: 10px 18px;
            font-size: 1.4em;
        }

        .navbar.scrolled .theme-selector {
            height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0;
            margin: 0;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0 20px;
            gap: 15px;
            transition: gap 0.3s ease;
        }

        .nav-right-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            position: relative;
        }

        .theme-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .theme-selector label {
            font-size: 0.9em;
            font-weight: 600;
            color: #1a1a1a;
        }

        .theme-selector select {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            outline: none;
        }

        .theme-selector select:hover {
            background: rgba(255, 255, 255, 1);
        }

        .nav-logo {
            font-size: 1.4em;
            font-weight: 800;
            letter-spacing: 0.5px;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            transition: height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            height: auto;
            opacity: 1;
        }
        
        .nav-logo .h2-symbol {
            font-size: 1.6em;
            font-weight: 700;
            color: #1a237e;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 15px;
            flex-wrap: wrap;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .nav-menu a {
            color: #1a1a1a;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 5px;
            transition: background 0.3s, padding 0.3s ease, font-size 0.3s ease;
            font-size: 1.5em;
            font-weight: 400;
        }

        .nav-menu a:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-1px);
        }

        .nav-menu a.active {
            background: rgba(255,255,255,0.6);
            font-weight: 600;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .nav-prognose {
            color: #DC143C !important;
            font-weight: 700 !important;
        }

        .prognose-title {
            color: #DC143C !important;
            font-weight: 700 !important;
        }

        /* Main Content */
        .main-content {
            margin-top: 230px;
            display: flex;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            gap: 20px;
            padding: 20px;
            transition: margin-top 0.3s ease;
        }

        /* Reduced margin when header is scrolled - only tabs visible */
        body.scrolled .main-content {
            margin-top: 75px;
        }

        body.scrolled .results-section {
            top: 85px;
            max-height: calc(100vh - 95px);
        }

        .input-section {
            flex: 1;
            min-width: 600px;
        }

        .results-section {
            flex: 1;
            min-width: 500px;
            position: sticky;
            top: 270px;
            height: fit-content;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
            z-index: 1;
            transition: top 0.3s ease, max-height 0.3s ease;
        }

        /* Optimization results should be above results-section */
        #optimization_results {
            position: relative;
            z-index: 200;
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        /* Optimization results: smaller font + right-aligned values */
        #optimization_results .page-result-label {
            font-size: 0.9em;
        }
        
        #optimization_results .page-result-value {
            font-size: 0.95em;
            text-align: right;
            width: 100%;
        }

        /* Ensure page-section content is above results-section */
        .page-section {
            position: relative;
            z-index: 50;
        }

        /* When optimization results are shown, reduce z-index of results-section */
        .page-section.active #optimization_results {
            z-index: 200;
        }

        .page-section.active ~ .results-section {
            z-index: 1;
        }

        .results-section::-webkit-scrollbar {
            width: 8px;
        }

        .results-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .results-section::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
        }

        .results-section::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        /* Page Sections */
        .page-section {
            display: none;
            background: var(--bg-page);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .page-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.15;
            z-index: 0;
            pointer-events: none;
        }

        .page-section > * {
            position: relative;
            z-index: 1;
        }

        /* Background images for each page */
        #page0::before {
            background-image: url('https://images.unsplash.com/photo-1635070041078-e363dbe005cb?w=1920&q=80');
        }

        #page1::before {
            background-image: url('https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?w=1920&q=80');
        }

        #page2::before {
            background-image: url('https://images.unsplash.com/photo-1621905251918-48416bd8575a?w=1920&q=80');
        }

        #page3::before {
            background-image: url('https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=1920&q=80');
        }

        #page4::before {
            background-image: url('https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=1920&q=80');
        }

        #page5::before {
            background-image: url('https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=1920&q=80');
        }

        #page6::before {
            background-image: url('https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=1920&q=80');
        }

        #page7::before {
            background-image: url('https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=1920&q=80');
        }

        #page8::before {
            background-image: url('https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=1920&q=80');
        }

        #page9::before {
            background-image: url('https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=1920&q=80');
        }

        .page-section.active {
            display: block;
        }

        .page-header {
            background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
            color: white;
            padding: 28px 32px;
            border-radius: 12px;
            margin-top: 0;
            margin-bottom: 28px;
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.3);
            border: none;
            position: relative;
            z-index: 2;
        }

        .page-header h2 {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 0;
            font-size: 1.75em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .h2-symbol {
            font-size: 1.3em;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .page-header h2 {
            font-size: 1.75em;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .page-header .page-number {
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Parameter Groups */
        .parameter-group {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .parameter-group-title {
            font-size: 1.3em;
            color: #4A90E2;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #4A90E2;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .parameter-item {
            display: grid;
            grid-template-columns: 120px 1fr 200px;
            gap: 15px;
            align-items: center;
            padding: 16px 20px;
            margin-bottom: 12px;
            background: var(--bg-primary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            border-left: 4px solid #4A90E2;
            transition: all 0.2s ease;
        }

        .parameter-item:hover {
            background: var(--bg-secondary);
            border-color: var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateX(2px);
        }

        .parameter-number {
            font-weight: 600;
            color: #000000;
            font-size: 1.0em;
            font-family: 'Courier New', monospace;
        }

        .parameter-label {
            font-weight: 500;
            color: #000000;
            font-size: 1.1em;
        }

        .parameter-input {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.1em;
            transition: all 0.2s ease;
            background: var(--bg-page);
            color: #000000;
        }

        .parameter-input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);
        }

        .parameter-input:read-only {
            background-color: var(--bg-primary);
            cursor: not-allowed;
            border-color: var(--border-color);
        }

        .parameter-unit {
            color: #95a5a6;
            font-size: 0.85em;
            margin-left: 5px;
        }


        .parameter-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: #fff;
            transition: all 0.3s ease;
        }

        .parameter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Project toolbar */
        .project-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid var(--border-color);
        }

        .project-toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .project-toolbar label {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .project-toolbar input[type="text"],
        .project-toolbar select {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            min-width: 180px;
            font-size: 0.9em;
        }

        .project-toolbar button {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            background: #4A90E2;
            color: #fff;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .project-toolbar button:hover {
            background: #357ABD;
            transform: translateY(-1px);
        }

        .project-toolbar button:active {
            transform: translateY(0);
        }

        .project-toolbar-nav {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .project-toolbar-nav select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.85em;
            max-width: 180px;
        }

        .project-toolbar-nav button {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            background: #4A90E2;
            color: #fff;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .project-toolbar-nav button:hover {
            background: #357ABD;
            transform: translateY(-1px);
        }

        .project-toolbar-nav button:active {
            transform: translateY(0);
        }

        .export-button {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            background: #2e7d32;
            color: #fff;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .export-button:hover {
            background: #1b5e20;
            transform: translateY(-1px);
        }

        .export-button:active {
            transform: translateY(0);
        }

        .plausibility-badge {
            margin-top: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .plausibility-ok {
            background: #e8f5e9;
            border: 1px solid #2e7d32;
            color: #1b5e20;
        }

        .plausibility-low {
            background: #fff3e0;
            border: 1px solid #fb8c00;
            color: #e65100;
        }

        .plausibility-high {
            background: #ffebee;
            border: 1px solid #c62828;
            color: #b71c1c;
        }

        @media (max-width: 900px) {
            .project-toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Calculate Button */
        .calculate-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .calculate-btn {
            background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.1em;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .calculate-btn:hover {
            background: linear-gradient(135deg, #5BA3F5 0%, #4A90E2 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        /* Results */
        .results-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .results-title {
            font-size: 1.5em;
            color: #4A90E2;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #4A90E2;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            margin-bottom: 12px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .result-item:hover {
            background: var(--bg-primary);
            border-color: var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .result-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .result-value {
            font-weight: 700;
            color: #4A90E2;
            font-size: 1.15em;
            font-family: 'Courier New', monospace;
        }

        .result-main {
            background: linear-gradient(135deg, #4A90E2 0%, #5BA3F5 100%);
            color: white;
            padding: 28px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.3);
            border: none;
        }

        .result-main .result-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95em;
            font-weight: 500;
        }

        .result-main .result-value {
            color: #ffffff;
            font-size: 1.8em;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .cost-breakdown {
            margin-top: 28px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            margin-bottom: 10px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            border-left: 4px solid #4A90E2;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .cost-item:hover {
            background: var(--bg-primary);
            border-color: var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateX(2px);
        }

        .chart-container {
            margin-top: 20px;
            height: 300px;
        }

        /* Page Results */
        .page-results {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 28px;
            margin-top: 28px;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .page-results-title {
            font-size: 1.3em;
            color: #4A90E2;
            margin-bottom: 20px;
            font-weight: 700;
            padding-bottom: 16px;
            border-bottom: 2px solid #4A90E2;
            letter-spacing: -0.3px;
        }

        .page-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            margin-bottom: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            border-left: 4px solid #4A90E2;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            transition: all 0.2s ease;
        }

        .page-result-item:hover {
            background: var(--bg-primary);
            border-color: var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateX(2px);
        }

        .page-result-label {
            font-weight: 500;
            color: #212529;
            font-size: 0.95em;
        }

        .page-result-value {
            font-weight: 700;
            color: #4A90E2;
            font-size: 1.15em;
            font-family: 'Courier New', monospace;
        }

        .page-result-main {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 24px 28px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .page-result-main .page-result-label {
            color: #212529;
            opacity: 1;
        }

        .page-result-main .page-result-value {
            color: #000000;
            font-size: 1.3em;
        }

        /* Navigation Buttons */
        .page-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .nav-button {
            padding: 12px 28px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(74, 144, 226, 0.25);
        }

        .nav-button:hover {
            background: #5BA3F5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.35);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }

            .results-section {
                position: static;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .parameter-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .nav-menu {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="h2-symbol">H‚ÇÇ</span>
                <span>Wasserstoff-Kostenrechner Simulation "Gruppe 2"</span>
            </div>
            <div style="display: flex; width: 100%; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <ul class="nav-menu">
                    <li><a href="#" onclick="showPage(0); return false;" class="nav-link active" data-page="0">1. System</a></li>
                    <li><a href="#" onclick="showPage(1); return false;" class="nav-link" data-page="1">2. Wind</a></li>
                    <li><a href="#" onclick="showPage(2); return false;" class="nav-link" data-page="2">3. Elektrolyse</a></li>
                    <li><a href="#" onclick="showPage(3); return false;" class="nav-link" data-page="3">4. Wasser</a></li>
                    <li><a href="#" onclick="showPage(4); return false;" class="nav-link" data-page="4">5. Stickstoff</a></li>
                    <li><a href="#" onclick="showPage(5); return false;" class="nav-link" data-page="5">6. Ammoniak</a></li>
                    <li><a href="#" onclick="showPage(6); return false;" class="nav-link" data-page="6">7. Speicher</a></li>
                    <li><a href="#" onclick="showPage(7); return false;" class="nav-link" data-page="7">8. Transport</a></li>
                    <li><a href="#" onclick="showPage(8); return false;" class="nav-link" data-page="8">9. Cracking</a></li>
                    <li><a href="#" onclick="showPage(9); return false;" class="nav-link nav-prognose" data-page="9">Prognose</a></li>
                </ul>
                <div class="nav-right-controls">
                    <div class="theme-selector">
                        <label for="theme-select">üé® Hintergrund:</label>
                        <select id="theme-select" onchange="changeTheme(this.value)">
                            <option value="light">Wei√ü (Hell)</option>
                            <option value="light-gray">Hellgrau</option>
                            <option value="dark">Dunkel</option>
                            <option value="black">Schwarz</option>
                        </select>
                    </div>
                    <div class="project-toolbar-nav">
                        <select id="project_select">
                            <option value="">Projekt ausw√§hlen‚Ä¶</option>
                        </select>
                        <button type="button" onclick="saveProjectConfig()" title="Aktuelles Projekt speichern">Speichern</button>
                        <button type="button" onclick="loadSelectedProject()" title="Gespeichertes Projekt laden">√ñffnen</button>
                        <button type="button" onclick="deleteSelectedProject()" title="Gespeichertes Projekt l√∂schen">‚úï</button>
                        <button type="button" class="export-button" onclick="exportProjectPdf()" title="Bericht als PDF speichern">PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Input Section -->
        <div class="input-section">
            <!-- Page 0: System Boundary and Target -->
            <section class="page-section active" id="page0">
                <div class="page-header">
                    <div class="page-number">Page 1</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>1. Systemgrenze und Ziel</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">1.1 Zieldefinition</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">1.1.1</div>
                        <div class="parameter-label">Wasserstoff-Importziel <span class="parameter-unit">(t H‚ÇÇ/Jahr)</span></div>
                        <input type="number" class="parameter-input" id="h2_import_target" value="110000" step="1000">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">1.1.2</div>
                        <div class="parameter-label">Stahlwerksbedarf <span class="parameter-unit">(kt H‚ÇÇ/Jahr)</span></div>
                        <input type="number" class="parameter-input" id="h2_steel_demand" value="110" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">1.1.3</div>
                        <div class="parameter-label">Diskontrate <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="discount_rate" value="5" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">1.1.4</div>
                        <div class="parameter-label">Projektlebensdauer (Betrachtungszeitraum T) <span class="parameter-unit">(Jahre)</span></div>
                        <input type="number" class="parameter-input" id="project_lifetime" value="20" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">1.1.5a</div>
                        <div class="parameter-label">LHV H‚ÇÇ <span class="parameter-unit">(kWh/t)</span></div>
                        <input type="number" class="parameter-input" id="lhv_h2" value="33300" step="100">
                    </div>
                    <div class="parameter-item">
                        <div class="parameter-number">1.1.5b</div>
                        <div class="parameter-label">LHV NH‚ÇÉ <span class="parameter-unit">(kWh/t)</span></div>
                        <input type="number" class="parameter-input" id="lhv_nh3" value="5200" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">1.1.6</div>
                        <div class="parameter-label">Referenz H‚ÇÇ-Menge <span class="parameter-unit">(f√ºr Berechnungen verwenden)</span></div>
                        <select class="parameter-input" id="h2_reference_choice" style="padding: 12px 16px;">
                            <option value="import">Importziel</option>
                            <option value="steel" selected>Stahlwerksbedarf</option>
                        </select>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" disabled>‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(1)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 1: Renewable Electricity Generation -->
            <section class="page-section" id="page1">
                <div class="page-header">
                    <div class="page-number">Page 2</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>2. Erneuerbare Stromerzeugung (Offshore-Wind)</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">2.1 Ressourcen- und Standortparameter</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">2.1.1</div>
                        <div class="parameter-label">Kapazit√§tsfaktor <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="wind_capacity_factor" value="51" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">2.1.2</div>
                        <div class="parameter-label">Anzahl Windkraftanlagen</div>
                        <input type="number" class="parameter-input" id="wind_num_turbines" value="260" step="1">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">2.2 Installierte Kapazit√§t und Kostenparameter</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">2.2.1</div>
                        <div class="parameter-label">Installierte Windkapazit√§t <span class="parameter-unit">(GW)</span></div>
                        <input type="number" class="parameter-input" id="wind_capacity" value="2.47" step="0.01">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">2.2.2</div>
                        <div class="parameter-label">Windpark CAPEX <span class="parameter-unit">(Mrd. ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="wind_capex" value="4.94" step="0.01">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">2.2.3</div>
                        <div class="parameter-label">Windpark OPEX <span class="parameter-unit">(Mio. ‚Ç¨/Jahr)</span></div>
                        <input type="number" class="parameter-input" id="wind_opex" value="148.2" step="0.01">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">2.2.4</div>
                        <div class="parameter-label">R√ºckbau (Depex) <span class="parameter-unit">(Mio. ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="wind_depex" value="53.24" step="0.01">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">2.3 Stromkosten-Methode</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">2.3.1</div>
                        <div class="parameter-label">Stromkosten-Methode</div>
                        <select class="parameter-input" id="electricity_cost_method" style="padding: 12px 16px;">
                            <option value="internal_LCOE" selected>Interner LCOE (vom Windpark)</option>
                            <option value="external_price">Externer Preis</option>
                        </select>
                    </div>

                    <div class="parameter-item" id="external_price_input" style="display: none;">
                        <div class="parameter-number">2.3.2</div>
                        <div class="parameter-label">Externer Strompreis <span class="parameter-unit">(‚Ç¨/MWh)</span></div>
                        <input type="number" class="parameter-input" id="external_electricity_price" value="50" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">2.3.3</div>
                        <div class="parameter-label">Windkosten in Gesamtkosten einbeziehen</div>
                        <select class="parameter-input" id="include_wind_cost_in_total" style="padding: 12px 16px;">
                            <option value="false" selected>Nein (Windkosten nur √ºber Strompreis)</option>
                            <option value="true">Ja (Windkosten separat addieren)</option>
                        </select>
                    </div>
                </div>

                <div class="page-results" id="page1_results">
                    <div class="page-results-title">Windpark-Kostenberechnung</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">J√§hrliche Windkosten</div>
                            <div class="page-result-value" id="wind_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">CAPEX (annualisiert)</div>
                        <div class="page-result-value" id="wind_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">OPEX</div>
                        <div class="page-result-value" id="wind_opex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Depex (annualisiert)</div>
                        <div class="page-result-value" id="wind_depex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">J√§hrliche Stromerzeugung</div>
                        <div class="page-result-value" id="wind_electricity_output">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Interner Strompreis</div>
                        <div class="page-result-value" id="wind_electricity_price">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(0)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(2)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 2: Electrolysis -->
            <section class="page-section" id="page2">
                <div class="page-header">
                    <div class="page-number">Page 3</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>3. Elektrolyse (Wasserstoffproduktion)</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">3.1 Wasserstoffproduktionsziel</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">3.1.1</div>
                        <div class="parameter-label">Elektrolyseur-Technologie <span class="parameter-unit">(-)</span></div>
                        <select class="parameter-input" id="electrolyzer_technology">
                            <option value="AEL">AEL (Alkaline Electrolyzer)</option>
                            <option value="PEM" selected>PEM (Proton Exchange Membrane)</option>
                        </select>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">3.1.2</div>
                        <div class="parameter-label">Wasserstoffproduktion <span class="parameter-unit">(kt H‚ÇÇ/Jahr)</span></div>
                        <input type="number" class="parameter-input" id="h2_production" value="120.799" step="0.01">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">3.2 Energiebedarf</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">3.2.1</div>
                        <div class="parameter-label">Spezifischer Strombedarf <span class="parameter-unit">(kWh/kg H‚ÇÇ)</span></div>
                        <input type="number" class="parameter-input" id="electrolysis_specific_energy" value="48.52" step="0.01">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">3.3 Betriebsparameter</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">3.3.1</div>
                        <div class="parameter-label">Elektrolyseur-Verf√ºgbarkeit <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="electrolysis_availability" value="95" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">3.3.2</div>
                        <div class="parameter-label">Betriebsstunden <span class="parameter-unit">(h/Jahr)</span></div>
                        <input type="number" class="parameter-input" id="electrolysis_operating_hours" value="8300" step="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">3.3.3</div>
                        <div class="parameter-label">Effektive Betriebsstunden <span class="parameter-unit">(h/Jahr)</span></div>
                        <input type="number" class="parameter-input" id="electrolysis_effective_hours" value="8322" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">3.3.4</div>
                        <div class="parameter-label">Mindestlastanteil <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="min_load_fraction" value="0.20" step="0.05" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">3.3.5</div>
                        <div class="parameter-label">Vollaststunden-√Ñquivalent <span class="parameter-unit">(h/a)</span></div>
                        <input type="number" class="parameter-input" id="full_load_hours_equivalent" value="5094" step="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">3.3.6</div>
                        <div class="parameter-label">Rampenrate Elektrolyseur <span class="parameter-unit">(-, Anteil pro Stunde)</span></div>
                        <input type="number" class="parameter-input" id="el_ramp_frac_per_h" value="0.80" step="0.05" min="0" max="1">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">3.4 Kostenparameter</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">3.4.1</div>
                        <div class="parameter-label">Elektrolyseur CAPEX <span class="parameter-unit">(‚Ç¨/kW)</span></div>
                        <input type="number" class="parameter-input" id="electrolysis_capex_per_kw" value="464" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">3.4.2</div>
                        <div class="parameter-label">Elektrolyseur OPEX <span class="parameter-unit">(Mio. ‚Ç¨/Jahr)</span></div>
                        <input type="number" class="parameter-input" id="electrolysis_opex" value="0" step="0.1">
                    </div>
                </div>

                <div class="page-results" id="page2_results">
                    <div class="page-results-title">Elektrolyse-Kostenberechnung</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">J√§hrliche Elektrolysekosten</div>
                            <div class="page-result-value" id="electrolysis_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">CAPEX (annualisiert)</div>
                        <div class="page-result-value" id="electrolysis_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">OPEX</div>
                        <div class="page-result-value" id="electrolysis_opex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Stromkosten</div>
                        <div class="page-result-value" id="electrolysis_electricity_cost">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Ben√∂tigte Leistung</div>
                        <div class="page-result-value" id="electrolysis_power">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Strombedarf</div>
                        <div class="page-result-value" id="electrolysis_electricity_demand">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(1)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(3)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 3: Water Supply -->
            <section class="page-section" id="page3">
                <div class="page-header">
                    <div class="page-number">Page 4</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>4. Water Supply and Desalination</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">4.1 Water demand</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">4.1.1</div>
                        <div class="parameter-label">Seawater demand <span class="parameter-unit">(L/kg H‚ÇÇ)</span></div>
                        <input type="number" class="parameter-input" id="seawater_demand" value="15" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.1.2</div>
                        <div class="parameter-label">Deionised water demand <span class="parameter-unit">(L/kg H‚ÇÇ)</span></div>
                        <input type="number" class="parameter-input" id="deionised_water_demand" value="10" step="0.1">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">4.2 Desalination system</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">4.2.1</div>
                        <div class="parameter-label">Specific electricity demand <span class="parameter-unit">(kWh/m¬≥)</span></div>
                        <input type="number" class="parameter-input" id="desalination_specific_energy" value="4" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.2.2</div>
                        <div class="parameter-label">RO CAPEX per m¬≥/day <span class="parameter-unit">(‚Ç¨/m¬≥/day)</span></div>
                        <input type="number" class="parameter-input" id="ro_capex_per_m3_per_day" value="1500" step="50">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.2.3</div>
                        <div class="parameter-label">RO OPEX fraction per year <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="ro_opex_fraction_per_year" value="0" step="0.01" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.2.4</div>
                        <div class="parameter-label">RO OPEX per m¬≥ <span class="parameter-unit">(‚Ç¨/m¬≥)</span></div>
                        <input type="number" class="parameter-input" id="ro_opex_per_m3" value="0.3825" step="0.01">
                    </div>
                    <div class="parameter-item">
                        <div class="parameter-number">4.2.5</div>
                        <div class="parameter-label">E_RO (Wasseraufbereitung Strom) <span class="parameter-unit">(GWh/a)</span></div>
                        <input type="number" class="parameter-input" id="desalination_electricity_gwh_year" value="4.94" step="0.01" min="0" placeholder="0 = aus Bedarf berechnen">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">4.3 Infrastructure</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">4.3.1</div>
                        <div class="parameter-label">Desalination CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="desalination_capex" value="4" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.3.2</div>
                        <div class="parameter-label">Desalination OPEX <span class="parameter-unit">(million ‚Ç¨/year)</span></div>
                        <input type="number" class="parameter-input" id="desalination_opex" value="0.5" step="0.1">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">4.4 Water Storage</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">4.4.1</div>
                        <div class="parameter-label">Water storage CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="water_storage_capex" value="5" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.4.2</div>
                        <div class="parameter-label">Water storage capacity <span class="parameter-unit">(m¬≥)</span></div>
                        <input type="number" class="parameter-input" id="water_storage_capacity" value="2500" step="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.4.3</div>
                        <div class="parameter-label">Water tank CAPEX per m¬≥ <span class="parameter-unit">(‚Ç¨/m¬≥)</span></div>
                        <input type="number" class="parameter-input" id="water_tank_capex_per_m3" value="200" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.4.4</div>
                        <div class="parameter-label">Water tank OPEX fraction per year <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="water_tank_opex_fraction_per_year" value="0.02" step="0.01" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">4.4.5</div>
                        <div class="parameter-label">Water tank loss fraction per hour <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="water_tank_loss_frac_per_hour" value="0.001" step="0.0001" min="0" max="0.1">
                    </div>
                </div>

                <div class="page-results" id="page3_results">
                    <div class="page-results-title">Desalination Cost Calculation</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">Annual Desalination Cost</div>
                            <div class="page-result-value" id="desalination_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">CAPEX (annualized)</div>
                        <div class="page-result-value" id="desalination_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">OPEX</div>
                        <div class="page-result-value" id="desalination_opex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Electricity Cost</div>
                        <div class="page-result-value" id="desalination_electricity_cost">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Water Demand (annual)</div>
                        <div class="page-result-value" id="desalination_water_demand">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(2)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(4)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 4: Nitrogen Supply -->
            <section class="page-section" id="page4">
                <div class="page-header">
                    <div class="page-number">Page 5</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>5. Nitrogen Supply (ASU)</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">5.1 Nitrogen Supply Parameters</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">5.1.1</div>
                        <div class="parameter-label">Nitrogen demand <span class="parameter-unit">(t N‚ÇÇ/day)</span></div>
                        <input type="number" class="parameter-input" id="nitrogen_demand" value="1545" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">5.1.2</div>
                        <div class="parameter-label">ASU CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="asu_capex" value="200" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">5.1.3</div>
                        <div class="parameter-label">ASU OPEX <span class="parameter-unit">(million ‚Ç¨/year)</span></div>
                        <input type="number" class="parameter-input" id="asu_opex" value="10" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">5.1.4</div>
                        <div class="parameter-label">ASU electricity demand <span class="parameter-unit">(GWh/year)</span></div>
                        <input type="number" class="parameter-input" id="asu_electricity" value="186.04" step="0.01">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">5.1.5</div>
                        <div class="parameter-label">ASU capacity <span class="parameter-unit">(t N‚ÇÇ/day)</span></div>
                        <input type="number" class="parameter-input" id="asu_capacity" value="1545" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">5.1.6</div>
                        <div class="parameter-label">ASU CAPEX per unit capacity <span class="parameter-unit">(‚Ç¨/t N‚ÇÇ/day)</span></div>
                        <input type="number" class="parameter-input" id="asu_capex_per_unit" value="1700" step="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">5.1.7</div>
                        <div class="parameter-label">ASU OPEX share <span class="parameter-unit">(-, fraction of CAPEX)</span></div>
                        <input type="number" class="parameter-input" id="asu_opex_share" value="0.03" step="0.01" min="0" max="1">
                    </div>
                </div>

                <div class="page-results" id="page4_results">
                    <div class="page-results-title">ASU Cost Calculation</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">Annual ASU Cost</div>
                            <div class="page-result-value" id="asu_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">CAPEX (annualized)</div>
                        <div class="page-result-value" id="asu_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">OPEX</div>
                        <div class="page-result-value" id="asu_opex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Electricity Cost</div>
                        <div class="page-result-value" id="asu_electricity_cost">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Nitrogen Demand (annual)</div>
                        <div class="page-result-value" id="asu_nitrogen_demand">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(3)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(5)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 5: Ammonia Synthesis -->
            <section class="page-section" id="page5">
                <div class="page-header">
                    <div class="page-number">Page 6</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>6. Ammonia Synthesis (Haber‚ÄìBosch)</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">6.1 Production rates</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">6.1.1</div>
                        <div class="parameter-label">Ammonia production <span class="parameter-unit">(t NH‚ÇÉ/day)</span></div>
                        <input type="number" class="parameter-input" id="ammonia_production" value="1876" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.1.2</div>
                        <div class="parameter-label">Annual ammonia demand <span class="parameter-unit">(kt NH‚ÇÉ/year)</span></div>
                        <input type="number" class="parameter-input" id="ammonia_annual_demand" value="684.694" step="0.01">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">6.2 Cost parameters</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">6.2.1</div>
                        <div class="parameter-label">Haber-Bosch CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_capex" value="125" step="5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.2</div>
                        <div class="parameter-label">Haber-Bosch OPEX <span class="parameter-unit">(million ‚Ç¨/year)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_opex" value="16.8" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.3</div>
                        <div class="parameter-label">Haber-Bosch electricity <span class="parameter-unit">(GWh/year)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_electricity" value="376.50" step="0.01">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.4</div>
                        <div class="parameter-label">Haber-Bosch capacity <span class="parameter-unit">(t NH‚ÇÉ/day)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_capacity" value="1876" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.5</div>
                        <div class="parameter-label">Haber-Bosch CAPEX per unit <span class="parameter-unit">(‚Ç¨/t NH‚ÇÉ/day)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_capex_per_unit" value="491.4" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.6</div>
                        <div class="parameter-label">Haber-Bosch OPEX share <span class="parameter-unit">(-, fraction of CAPEX)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_opex_share" value="0" step="0.01" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.7</div>
                        <div class="parameter-label">Haber-Bosch efficiency/loss <span class="parameter-unit">(%, loss)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_loss" value="5" step="0.1" min="0" max="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.8</div>
                        <div class="parameter-label">Haber-Bosch availability <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="haber_bosch_availability" value="0.94" step="0.01" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">6.2.9</div>
                        <div class="parameter-label">Rampenrate Haber-Bosch <span class="parameter-unit">(-, Anteil pro Stunde)</span></div>
                        <input type="number" class="parameter-input" id="hb_ramp_frac_per_h" value="0.10" step="0.01" min="0" max="1">
                    </div>
                </div>

                <div class="page-results" id="page5_results">
                    <div class="page-results-title">Haber-Bosch Cost Calculation</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">Annual Haber-Bosch Cost</div>
                            <div class="page-result-value" id="haber_bosch_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">CAPEX (annualized)</div>
                        <div class="page-result-value" id="haber_bosch_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">OPEX</div>
                        <div class="page-result-value" id="haber_bosch_opex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Electricity Cost</div>
                        <div class="page-result-value" id="haber_bosch_electricity_cost">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Ammonia Production (annual)</div>
                        <div class="page-result-value" id="haber_bosch_ammonia_production">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(4)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(6)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 6: Storage -->
            <section class="page-section" id="page6">
                <div class="page-header">
                    <div class="page-number">Page 7</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>7. Storage</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">7.1 Storage Capacities</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">7.1.1</div>
                        <div class="parameter-label">H‚ÇÇ storage CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="storage_h2_capex" value="21.85" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.2</div>
                        <div class="parameter-label">NH‚ÇÉ storage CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="storage_nh3_capex" value="55.5" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.3</div>
                        <div class="parameter-label">Storage OPEX <span class="parameter-unit">(million ‚Ç¨/year)</span></div>
                        <input type="number" class="parameter-input" id="storage_opex" value="5" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.4</div>
                        <div class="parameter-label">Water storage CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="water_storage_capex_storage" value="5" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.5</div>
                        <div class="parameter-label">Water storage capacity <span class="parameter-unit">(m¬≥)</span></div>
                        <input type="number" class="parameter-input" id="water_storage_capacity_storage" value="2500" step="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.6</div>
                        <div class="parameter-label">NH‚ÇÉ storage capacity <span class="parameter-unit">(t NH‚ÇÉ)</span></div>
                        <input type="number" class="parameter-input" id="nh3_storage_capacity" value="68527" step="1000">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.7</div>
                        <div class="parameter-label">H‚ÇÇ storage capacity <span class="parameter-unit">(t H‚ÇÇ)</span></div>
                        <input type="number" class="parameter-input" id="h2_storage_capacity" value="662" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.8</div>
                        <div class="parameter-label">NH‚ÇÉ storage CAPEX per t <span class="parameter-unit">(‚Ç¨/t NH‚ÇÉ)</span></div>
                        <input type="number" class="parameter-input" id="capex_per_t_nh3_storage" value="810" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.9</div>
                        <div class="parameter-label">Storage OPEX share <span class="parameter-unit">(-, fraction of CAPEX)</span></div>
                        <input type="number" class="parameter-input" id="storage_opex_share" value="0.03" step="0.01" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.1.10</div>
                        <div class="parameter-label">Storage loss rate <span class="parameter-unit">(%/year)</span></div>
                        <input type="number" class="parameter-input" id="storage_loss_rate" value="0.5" step="0.1" min="0" max="10">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">7.2 H‚ÇÇ Storage Parameters (LH‚ÇÇ)</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">7.2.1</div>
                        <div class="parameter-label">H‚ÇÇ storage efficiency in (Œ∑_in) <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="h2_storage_eta_in" value="0.995" step="0.001" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.2.2</div>
                        <div class="parameter-label">H‚ÇÇ storage efficiency out (Œ∑_out) <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="h2_storage_eta_out" value="0.995" step="0.001" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.2.3</div>
                        <div class="parameter-label">H‚ÇÇ spec. energy in (liquefaction) <span class="parameter-unit">(kWh/kg H‚ÇÇ)</span></div>
                        <input type="number" class="parameter-input" id="h2_spec_kwh_per_kg_in" value="11.0" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.2.4</div>
                        <div class="parameter-label">H‚ÇÇ spec. energy out (regasification) <span class="parameter-unit">(kWh/kg H‚ÇÇ)</span></div>
                        <input type="number" class="parameter-input" id="h2_spec_kwh_per_kg_out" value="0.06" step="0.01">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.2.5</div>
                        <div class="parameter-label">H‚ÇÇ boil-off loss fraction per hour <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="h2_boil_off_loss_frac_per_hour" value="0.0000208" step="0.000001" min="0" max="0.001">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.2.6</div>
                        <div class="parameter-label">H‚ÇÇ re-liquefaction energy <span class="parameter-unit">(kWh/kg BOG)</span></div>
                        <input type="number" class="parameter-input" id="h2_reliq_kwh_per_kg_bog" value="11.0" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.2.7</div>
                        <div class="parameter-label">H‚ÇÇ re-liquefaction fraction <span class="parameter-unit">(-, Anteil BOG)</span></div>
                        <input type="number" class="parameter-input" id="h2_reliq_frac" value="1.0" step="0.1" min="0" max="1">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">7.3 NH‚ÇÉ Storage Parameters</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">7.3.1</div>
                        <div class="parameter-label">NH‚ÇÉ spec. energy in <span class="parameter-unit">(kWh/t NH‚ÇÉ)</span></div>
                        <input type="number" class="parameter-input" id="nh3_spec_kwh_per_t_in" value="1.0" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.3.2</div>
                        <div class="parameter-label">NH‚ÇÉ spec. energy out <span class="parameter-unit">(kWh/t NH‚ÇÉ)</span></div>
                        <input type="number" class="parameter-input" id="nh3_spec_kwh_per_t_out" value="1.0" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.3.3</div>
                        <div class="parameter-label">NH‚ÇÉ cooling energy <span class="parameter-unit">(kWh/t NH‚ÇÉ/day)</span></div>
                        <input type="number" class="parameter-input" id="nh3_cooling_kwh_per_t_per_day" value="40.0" step="1">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">7.4 SOC Control Parameters</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">7.4.1</div>
                        <div class="parameter-label">H‚ÇÇ SOC low fraction (EL priorisieren) <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="h2_soc_low_frac" value="0.3" step="0.05" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.4.2</div>
                        <div class="parameter-label">H‚ÇÇ SOC high fraction (HB priorisieren) <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="h2_soc_high_frac" value="0.60" step="0.05" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.4.3</div>
                        <div class="parameter-label">H‚ÇÇ EL stop fraction <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="h2_el_stop_frac" value="0.95" step="0.05" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.4.4</div>
                        <div class="parameter-label">H‚ÇÇ EL start fraction <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="h2_el_start_frac" value="0.30" step="0.05" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.4.5</div>
                        <div class="parameter-label">NH‚ÇÉ target level (ships) <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="nh3_target_level_ships" value="1.2" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.4.6</div>
                        <div class="parameter-label">NH‚ÇÉ deadband (ships) <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="nh3_deadband_ships" value="1.1" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">7.4.7</div>
                        <div class="parameter-label">HB min fraction when on <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="hb_min_frac_when_on" value="0.40" step="0.05" min="0" max="1">
                    </div>
                </div>

                <div class="page-results" id="page6_results">
                    <div class="page-results-title">Storage Cost Calculation</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">Annual Storage Cost</div>
                            <div class="page-result-value" id="storage_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">CAPEX (annualized)</div>
                        <div class="page-result-value" id="storage_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">OPEX</div>
                        <div class="page-result-value" id="storage_opex_annual">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(5)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(7)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 7: Transport -->
            <section class="page-section" id="page7">
                <div class="page-header">
                    <div class="page-number">Page 8</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>8. Transport</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">8.1 Logistics</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">8.1.1</div>
                        <div class="parameter-label">NH‚ÇÉ density <span class="parameter-unit">(t/m¬≥, at -33¬∞C/9 bar)</span></div>
                        <input type="number" class="parameter-input" id="nh3_density" value="0.682" step="0.001">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.1.2</div>
                        <div class="parameter-label">Sea transport distance <span class="parameter-unit">(km)</span></div>
                        <input type="number" class="parameter-input" id="transport_distance" value="13000" step="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.1.3</div>
                        <div class="parameter-label">One-way transport time <span class="parameter-unit">(days)</span></div>
                        <input type="number" class="parameter-input" id="transport_time" value="26" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.1.4</div>
                        <div class="parameter-label">Port time (loading/unloading) <span class="parameter-unit">(days)</span></div>
                        <input type="number" class="parameter-input" id="port_time" value="2" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.1.5</div>
                        <div class="parameter-label">Ship speed <span class="parameter-unit">(knots)</span></div>
                        <input type="number" class="parameter-input" id="ship_speed" value="14" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.1.6</div>
                        <div class="parameter-label">Tank fill factor <span class="parameter-unit">(-)</span></div>
                        <input type="number" class="parameter-input" id="fill_factor" value="0.95" step="0.01" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.1.7</div>
                        <div class="parameter-label">NH‚ÇÉ shipping loss rate <span class="parameter-unit">(%/trip)</span></div>
                        <input type="number" class="parameter-input" id="nh3_shipping_loss" value="0.1" step="0.05" min="0" max="5">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">8.2 Transport costs</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">8.2.1</div>
                        <div class="parameter-label">Shipping cost per t NH‚ÇÉ <span class="parameter-unit">(‚Ç¨/t)</span></div>
                        <input type="number" class="parameter-input" id="shipping_cost_per_t_nh3" value="0" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.2.2</div>
                        <div class="parameter-label">Shipping cost per t¬∑km <span class="parameter-unit">(‚Ç¨/t¬∑km)</span></div>
                        <input type="number" class="parameter-input" id="shipping_cost_per_tkm" value="0" step="0.001">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.2.3</div>
                        <div class="parameter-label">Fuel cost per trip <span class="parameter-unit">(‚Ç¨/trip)</span></div>
                        <input type="number" class="parameter-input" id="fuel_cost_per_trip" value="0" step="1000">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.2.4</div>
                        <div class="parameter-label">Harbor fees per trip <span class="parameter-unit">(‚Ç¨/trip)</span></div>
                        <input type="number" class="parameter-input" id="harbor_fees_per_trip" value="0" step="1000">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.2.5</div>
                        <div class="parameter-label">Insurance rate <span class="parameter-unit">(% of CAPEX/year)</span></div>
                        <input type="number" class="parameter-input" id="insurance_rate" value="1" step="0.1" min="0" max="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.2.6</div>
                        <div class="parameter-label">Taxes and customs <span class="parameter-unit">(million ‚Ç¨/year)</span></div>
                        <input type="number" class="parameter-input" id="taxes_customs" value="75.69" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.2.7</div>
                        <div class="parameter-label">Customs rate <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="customs_rate" value="0" step="0.1" min="0" max="100">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.2.8</div>
                        <div class="parameter-label">VAT rate <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="vat_rate" value="0" step="0.1" min="0" max="100">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">8.3 Vessel parameters</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">8.3.0</div>
                        <div class="parameter-label">Schiffstyp f√ºr NH‚ÇÉ-Transport</div>
                        <select class="parameter-select" id="vessel_type" onchange="onVesselTypeChange(this.value)">
                            <option value="">Benutzerdefiniert (eigene Tankgr√∂√üe)</option>
                            <option value="handysize">Handysize Gas Carrier (~20.000 m¬≥)</option>
                            <option value="mgc" selected>Midsize Gas Carrier (MGC, ~35.000‚Äì50.000 m¬≥)</option>
                            <option value="lgc">Large Gas Carrier (LGC, ~50.000 m¬≥)</option>
                            <option value="vlgc">Very Large Gas Carrier (VLGC, ~80.000 m¬≥)</option>
                        </select>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.3.1</div>
                        <div class="parameter-label">Tank volume <span class="parameter-unit">(m¬≥)</span></div>
                        <input type="number" class="parameter-input" id="vessel_tank_volume" value="48000" step="1000">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.3.2</div>
                        <div class="parameter-label">Investment cost per vessel <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="vessel_capex" value="61.5" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.3.3</div>
                        <div class="parameter-label">Number of vessels <span class="parameter-unit">(calculated)</span></div>
                        <input type="number" class="parameter-input" id="num_vessels" value="4" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.3.4</div>
                        <div class="parameter-label">Cycle time <span class="parameter-unit">(days, calculated)</span></div>
                        <input type="number" class="parameter-input" id="cycle_time_days" value="0" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.3.5</div>
                        <div class="parameter-label">Trips per ship per year <span class="parameter-unit">(calculated)</span></div>
                        <input type="number" class="parameter-input" id="trips_per_ship_a" value="0" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.3.6</div>
                        <div class="parameter-label">Ship payload NH‚ÇÉ <span class="parameter-unit">(t, calculated)</span></div>
                        <input type="number" class="parameter-input" id="ship_payload_nh3" value="0" step="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">8.3.7</div>
                        <div class="parameter-label">Vessel OPEX <span class="parameter-unit">(million ‚Ç¨/year per vessel)</span></div>
                        <input type="number" class="parameter-input" id="vessel_opex" value="5" step="0.5">
                    </div>
                </div>

                <div class="page-results" id="page7_results">
                    <div class="page-results-title">Transport Cost Calculation</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">Annual Transport Cost</div>
                            <div class="page-result-value" id="transport_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Vessel CAPEX (annualized)</div>
                        <div class="page-result-value" id="transport_vessel_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Vessel OPEX</div>
                        <div class="page-result-value" id="transport_vessel_opex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Taxes & Customs</div>
                        <div class="page-result-value" id="transport_taxes_customs">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(6)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(8)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 8: Ammonia Cracking -->
            <section class="page-section" id="page8">
                <div class="page-header">
                    <div class="page-number">Page 9</div>
                    <h2><span class="h2-symbol">H‚ÇÇ</span>9. Ammonia Cracking</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">9.1 Cracking process</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">9.1.1</div>
                        <div class="parameter-label">Cracking efficiency <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="cracking_efficiency" value="95" step="0.1">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">9.2 Cost parameters</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number">9.2.1</div>
                        <div class="parameter-label">Cracking CAPEX <span class="parameter-unit">(million ‚Ç¨)</span></div>
                        <input type="number" class="parameter-input" id="cracking_capex" value="500" step="10">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">9.2.2</div>
                        <div class="parameter-label">Cracking OPEX <span class="parameter-unit">(million ‚Ç¨/year)</span></div>
                        <input type="number" class="parameter-input" id="cracking_opex" value="10" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">9.2.3</div>
                        <div class="parameter-label">H‚ÇÇ purity loss <span class="parameter-unit">(-, fraction)</span></div>
                        <input type="number" class="parameter-input" id="h2_purity_loss" value="0.02" step="0.01" min="0" max="1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number">9.2.4</div>
                        <div class="parameter-label">H‚ÇÇ recovery fraction <span class="parameter-unit">(-, fraction)</span></div>
                        <input type="number" class="parameter-input" id="h2_recovery_fraction" value="0.98" step="0.01" min="0" max="1">
                    </div>
                    <div class="parameter-item">
                        <div class="parameter-number">9.2.5</div>
                        <div class="parameter-label">E_CRACK (Cracking Strom) <span class="parameter-unit">(GWh/a)</span></div>
                        <input type="number" class="parameter-input" id="cracking_electricity_gwh_year" value="20.90" step="0.01" min="0" placeholder="0 = aus therm. Energie berechnen">
                    </div>
                </div>

                <div class="page-results" id="page8_results">
                    <div class="page-results-title">Cracking Cost Calculation</div>
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">Annual Cracking Cost</div>
                            <div class="page-result-value" id="cracking_cost_annual">-</div>
                        </div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">CAPEX (annualized)</div>
                        <div class="page-result-value" id="cracking_capex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">OPEX</div>
                        <div class="page-result-value" id="cracking_opex_annual">-</div>
                    </div>
                    <div class="page-result-item">
                        <div class="page-result-label">Cracking Efficiency</div>
                        <div class="page-result-value" id="cracking_efficiency_display">-</div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(7)">‚Üê Zur√ºck</button>
                    <button class="nav-button" onclick="showPage(9)">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Page 9: Price Prediction -->
            <section class="page-section" id="page9">
                <div class="page-header">
                    <h2 class="prognose-title"><span class="h2-symbol">H‚ÇÇ</span>Prognose</h2>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">Current Base Cost</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Current cost per kg H‚ÇÇ <span class="parameter-unit">(‚Ç¨/kg)</span></div>
                        <input type="number" class="parameter-input" id="current_cost_per_kg" value="0" step="0.01" readonly>
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">Cost Reduction Scenarios</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Annual CAPEX reduction <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="capex_reduction_rate" value="5" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Annual OPEX reduction <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="opex_reduction_rate" value="2" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Technology learning rate <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="learning_rate" value="10" step="0.5">
                    </div>
                </div>

                <div class="parameter-group">
                    <div class="parameter-group-title">Market Factors</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Annual inflation rate <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="inflation_rate" value="2" step="0.1">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Market demand growth <span class="parameter-unit">(%/year)</span></div>
                        <input type="number" class="parameter-input" id="demand_growth" value="15" step="0.5">
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Scale-up efficiency gain <span class="parameter-unit">(%)</span></div>
                        <input type="number" class="parameter-input" id="scale_efficiency" value="3" step="0.1">
                    </div>
                </div>

                <!-- Optimization Section -->
                <div class="parameter-group" style="margin-top: 32px; border-top: 2px solid #e0e0e0; padding-top: 24px;">
                    <div class="parameter-group-title" style="color: #DC143C; font-weight: 700; font-size: 1.2em;">Optimierung</div>
                    
                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Optimierungsbereich Elektrolyseur-Leistung <span class="parameter-unit">(MW)</span></div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                            <input type="number" class="parameter-input" id="opt_pel_min" value="800" step="50">
                            <div style="text-align: center; color: #666; font-weight: 500;">bis</div>
                            <input type="number" class="parameter-input" id="opt_pel_max" value="1500" step="50">
                            <div style="margin-top: 8px; color: #666; font-weight: 500;">Schritt:</div>
                            <input type="number" class="parameter-input" id="opt_pel_step" value="50" step="10">
                        </div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Optimierungsbereich H‚ÇÇ-Speicher <span class="parameter-unit">(Tage)</span></div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                            <input type="number" class="parameter-input" id="opt_h2_days_min" value="1" step="0.5">
                            <div style="text-align: center; color: #666; font-weight: 500;">bis</div>
                            <input type="number" class="parameter-input" id="opt_h2_days_max" value="7" step="0.5">
                            <div style="margin-top: 8px; color: #666; font-weight: 500;">Schritt:</div>
                            <input type="number" class="parameter-input" id="opt_h2_days_step" value="1" step="0.5">
                        </div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Optimierungsbereich NH‚ÇÉ-Speicher <span class="parameter-unit">(Schiffe)</span></div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                            <input type="number" class="parameter-input" id="opt_nh3_ships_min" value="3" step="0.25">
                            <div style="text-align: center; color: #666; font-weight: 500;">bis</div>
                            <input type="number" class="parameter-input" id="opt_nh3_ships_max" value="8" step="0.25">
                            <div style="margin-top: 8px; color: #666; font-weight: 500;">Schritt:</div>
                            <input type="number" class="parameter-input" id="opt_nh3_ships_step" value="1" step="1">
                        </div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Optimierungsbereich Water Tank <span class="parameter-unit">(m¬≥)</span></div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                            <input type="number" class="parameter-input" id="opt_water_tank_min" value="500" step="500">
                            <div style="text-align: center; color: #666; font-weight: 500;">bis</div>
                            <input type="number" class="parameter-input" id="opt_water_tank_max" value="4500" step="500">
                            <div style="margin-top: 8px; color: #666; font-weight: 500;">Schritt:</div>
                            <input type="number" class="parameter-input" id="opt_water_tank_step" value="2000" step="500">
                        </div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-number"></div>
                        <div class="parameter-label">Optimierungsbereich Wind-Skalierung <span class="parameter-unit">(s)</span></div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                            <input type="number" class="parameter-input" id="opt_s_min" value="0.95" step="0.01" min="0.9" max="1.0">
                            <div style="text-align: center; color: #666; font-weight: 500;">bis</div>
                            <input type="number" class="parameter-input" id="opt_s_max" value="1.00" step="0.01" min="0.9" max="1.0">
                            <div style="margin-top: 8px; color: #666; font-weight: 500;">Schritt:</div>
                            <input type="number" class="parameter-input" id="opt_s_step" value="0.01" step="0.01" min="0.01" max="0.1">
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                            <strong>Hinweis:</strong> s skaliert die Windkapazit√§t (1.0 = 100%, 0.95 = 95%)
                        </div>
                    </div>

                    <div class="calculate-section" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                        <button class="calculate-btn" onclick="runOptimization()" style="background: linear-gradient(135deg, #DC143C 0%, #FF6347 100%);">
                            OPTIMIERUNG (INTERNES RASTER)
                        </button>
                        <button class="calculate-btn" onclick="runGurobiOptimization()" style="background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);">
                            OPTIMIERUNG (GUROBI-SERVER)
                        </button>
                        <div style="font-size: 0.85em; color: #555; text-align: left;">
                            Hinweis: F√ºr die Gurobi-Optimierung muss der Python-Server <code>gurobi_server.py</code> lokal laufen
                            (<code>python gurobi_server.py</code> im Projektordner).
                        </div>
                    </div>
                </div>

                <!-- Optimization Results -->
                <div class="page-results" id="optimization_results" style="display: none; margin-top: 32px; position: relative; z-index: 200; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                    <div class="page-results-title" style="color: #DC143C;">Optimierungsergebnisse</div>
                    
                    <!-- Progress Bar -->
                    <div id="optimization_progress" style="display: none; margin-top: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #DC143C; font-weight: 600;">Fortschritt:</span>
                            <span id="optimization_progress_text" style="color: #DC143C; font-weight: 600;">0%</span>
                        </div>
                        <div style="width: 100%; height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden;">
                            <div id="optimization_progress_bar" style="height: 100%; background: linear-gradient(90deg, #DC143C 0%, #FF6347 100%); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="optimization_status" style="margin-top: 8px; color: #666; font-size: 0.9em;">Berechne...</div>
                    </div>
                    
                    <div class="page-result-main">
                        <div class="page-result-item">
                            <div class="page-result-label">Optimale Wind-Skalierung (s)</div>
                            <div class="page-result-value" id="opt_result_s">-</div>
                        </div>
                        <div class="page-result-item">
                            <div class="page-result-label">Optimale Elektrolyseur-Leistung</div>
                            <div class="page-result-value" id="opt_result_pel">-</div>
                        </div>
                        <div class="page-result-item">
                            <div class="page-result-label">Optimaler H‚ÇÇ-Speicher</div>
                            <div class="page-result-value" id="opt_result_h2_storage">-</div>
                        </div>
                        <div class="page-result-item">
                            <div class="page-result-label">Optimaler NH‚ÇÉ-Speicher</div>
                            <div class="page-result-value" id="opt_result_nh3_storage">-</div>
                        </div>
                        <div class="page-result-item">
                            <div class="page-result-label">Optimaler Water Tank</div>
                            <div class="page-result-value" id="opt_result_water_tank">-</div>
                        </div>
                        <div class="page-result-item" style="background: #f0f8ff; border-left: 4px solid #DC143C;">
                            <div class="page-result-label" style="font-weight: 700;">Optimale Kosten</div>
                            <div class="page-result-value" id="opt_result_cost" style="color: #DC143C; font-weight: 700;">-</div>
                        </div>
                    </div>

                    <!-- Comparison Section -->
                    <div style="margin-top: 32px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                        <h3 style="color: #DC143C; margin-bottom: 8px; font-size: 1.2em;">Vergleich der Konfigurationen</h3>
                        <p style="font-size: 0.85em; color: #555; margin-bottom: 16px;">
                            Hier werden die aktuellen Einstellungen der Anlage den optimierten Ergebnissen
                            aus der internen Raster-Suche und der Gurobi-Optimierung gegen√ºbergestellt.
                            Alle Werte sind absolute Kennzahlen (z.&nbsp;B. ‚Ç¨/kg, MW, t, m¬≥); es wird
                            keine prozentuale Einsparung ausgewiesen.
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #4A90E2;">
                                <div style="font-weight: 600; color: #4A90E2; margin-bottom: 10px;">Aktuelle Konfiguration</div>
                                <div style="font-size: 0.9em; margin-bottom: 5px;">Kosten: <span id="comparison_current_cost" style="font-weight: 600;">-</span></div>
                                <div style="font-size: 0.9em; margin-bottom: 5px;">P_el: <span id="comparison_current_pel">-</span> MW</div>
                                <div style="font-size: 0.9em; margin-bottom: 5px;">H‚ÇÇ Storage: <span id="comparison_current_h2">-</span></div>
                                <div style="font-size: 0.9em;">NH‚ÇÉ Storage: <span id="comparison_current_nh3">-</span></div>
                            </div>
                            <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #DC143C;">
                                <div style="font-weight: 600; color: #DC143C; margin-bottom: 10px;">Optimiert (internes Raster)</div>
                                <div style="font-size: 0.9em; margin-bottom: 5px;">Kosten: <span id="comparison_internal_cost" style="font-weight: 600; color: #DC143C;">-</span></div>
                                <div style="font-size: 0.9em; margin-bottom: 5px;">P_el: <span id="comparison_internal_pel">-</span> MW</div>
                                <div style="font-size: 0.9em; margin-bottom: 5px;">H‚ÇÇ Storage: <span id="comparison_internal_h2">-</span></div>
                                <div style="font-size: 0.9em;">NH‚ÇÉ Storage: <span id="comparison_internal_nh3">-</span></div>
                            </div>
                            <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #2E7D32;">
                                <div style="font-weight: 600; color: #2E7D32; margin-bottom: 10px;">Optimiert (Gurobi-Server)</div>
                                <div style="font-size: 0.9em; margin-bottom: 5px;">Kosten: <span id="comparison_gurobi_cost" style="font-weight: 600; color: #2E7D32;">-</span></div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">P_el: <span id="comparison_gurobi_pel">-</span> MW</div>
                        <div style="font-size: 0.9em; margin-bottom: 5px;">H‚ÇÇ Storage: <span id="comparison_gurobi_h2">-</span></div>
                        <div style="font-size: 0.9em;">NH‚ÇÉ Storage: <span id="comparison_gurobi_nh3">-</span></div>
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px dashed #999;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 1em; color: #333;">Automatische Design-Empfehlungen</h4>
                                <button type="button" onclick="generateDesignRecommendations()" style="padding: 6px 12px; border-radius: 16px; border: none; background: #2E7D32; color: white; font-size: 0.8em; cursor: pointer;">
                                    Empfehlungen aktualisieren
                                </button>
                            </div>
                            <ul id="design_recommendations_list" style="margin: 0; padding-left: 18px; font-size: 0.85em; color: #444;">
                                <li>Nach der Kostenberechnung und mind. einer Optimierung werden hier konkrete Vorschl√§ge f√ºr P_el, H‚ÇÇ- und NH‚ÇÉ-Speicher angezeigt.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Optimization Chart -->
                    <div style="margin-top: 32px;">
                        <h3 style="color: #DC143C; margin-bottom: 20px; font-size: 1.2em;">Optimierungsergebnisse (Top 10 Konfigurationen)</h3>
                        <canvas id="optimizationChart" style="max-height: 400px;"></canvas>
                    </div>

                    <!-- Top 10 Configuration Details Table -->
                    <div style="margin-top: 32px;">
                        <h3 style="color: #DC143C; margin-bottom: 20px; font-size: 1.2em;">Detaillierte Konfigurationen</h3>
                        <div style="overflow-x: auto;">
                            <table id="optimizationTable" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background: #DC143C; color: white;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">Rang</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Wind (s)</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">P_el (MW)</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">H‚ÇÇ-Speicher</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">NH‚ÇÉ-Speicher</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Water (m¬≥)</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Kosten (‚Ç¨/kg)</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Œî zu Rang 1</th>
                                    </tr>
                                </thead>
                                <tbody id="optimizationTableBody">
                                    <!-- Will be filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>


                <div class="page-navigation">
                    <button class="nav-button" onclick="showPage(8)">‚Üê Zur√ºck</button>
                    <button class="nav-button" disabled>Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Calculate Button -->
            <div class="calculate-section">
                <button class="calculate-btn" onclick="calculateCosts()">CALCULATE TOTAL COSTS</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-card">
                <div class="results-title">Cost Results</div>
                
                <div class="result-main">
                    <div class="result-item" style="background: transparent; border: none; padding: 0; margin: 0;">
                        <div class="result-label">Cost per kg H‚ÇÇ delivered</div>
                        <div class="result-value" id="result_cost_per_kg" style="color: #ffffff;">-</div>
                    </div>
                </div>

                <div id="plausibility_badge" class="plausibility-badge plausibility-low" style="display:none;">
                    <!-- Wird per JavaScript bef√ºllt -->
                </div>

                <div class="result-item">
                    <div class="result-label">Total annual cost</div>
                    <div class="result-value" id="result_total_annual">-</div>
                </div>

                <div class="result-item">
                    <div class="result-label">Annual H‚ÇÇ delivered</div>
                    <div class="result-value" id="result_h2_delivered">-</div>
                </div>

                <div class="cost-breakdown">
                    <div class="results-title" style="margin-top: 20px;">Cost Breakdown</div>
                    <div id="cost_breakdown_list"></div>
                </div>

                <div class="chart-container">
                    <canvas id="costChart"></canvas>
                </div>
                
                <div class="chart-container" style="margin-top: 40px;">
                    <canvas id="costTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Shrinking header on scroll
        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
                document.body.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
                document.body.classList.remove('scrolled');
            }
        });

        // Page Navigation - Define early to ensure it's available
        // Theme management
        function changeTheme(theme) {
            const body = document.body;
            // Remove all theme classes
            body.classList.remove('light-theme', 'dark-theme', 'black-theme', 'light-gray-theme');
            
            // Add selected theme class
            if (theme === 'dark') {
                body.classList.add('dark-theme');
            } else if (theme === 'black') {
                body.classList.add('black-theme');
            } else if (theme === 'light-gray') {
                body.classList.add('light-gray-theme');
            }
            // 'light' is the default, no class needed
            
            // Save to localStorage
            localStorage.setItem('selectedTheme', theme);
            
            // Update select dropdown
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = theme;
            }
        }

        // Load saved theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'light';
            changeTheme(savedTheme);
        }

        function showPage(pageIndex) {
            try {
                const pages = document.querySelectorAll('.page-section');
                if (pages.length === 0) {
                    // DOM not ready yet, wait a bit
                    setTimeout(function() { showPage(pageIndex); }, 100);
                    return;
                }
                pages.forEach(page => page.classList.remove('active'));
                if (pages[pageIndex]) {
                    pages[pageIndex].classList.add('active');
                }
                
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach((link, index) => {
                    if (index === pageIndex) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                
                // Calculate costs for the current page (if function exists)
                if (typeof calculatePageCosts === 'function') {
                    try {
                        calculatePageCosts(pageIndex);
                    } catch (e) {
                        console.warn('calculatePageCosts error:', e);
                    }
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error in showPage:', error);
            }
        }

        // Calculate costs for specific page
        function calculatePageCosts(pageIndex) {
            switch(pageIndex) {
                case 1: calculateWindCosts(); break;
                case 2: calculateElectrolysisCosts(); break;
                case 3: calculateDesalinationCosts(); break;
                case 4: calculateASUCosts(); break;
                case 5: calculateHaberBoschCosts(); break;
                case 6: calculateStorageCosts(); break;
                case 7: calculateTransportCosts(); break;
                case 8: calculateCrackingCosts(); break;
                case 9: 
                    // Don't auto-calculate, wait for button click
                    // Just update current cost if available
                    const currentCost = getInput('current_cost_per_kg');
                    if (currentCost === 0) {
                        const costElement = document.getElementById('result_cost_per_kg');
                        if (costElement && costElement.textContent !== '-') {
                            const costText = costElement.textContent.replace(' ‚Ç¨/kg', '').trim();
                            const cost = parseFloat(costText) || 0;
                            if (cost > 0) {
                                document.getElementById('current_cost_per_kg').value = cost.toFixed(4);
                            }
                        }
                    }
                    break;
            }
        }

        // Capital Recovery Factor
        function CRF(i, n) {
            if (i === 0) return 1 / n;
            return (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1);
        }

        // Annualize CAPEX
        function annualizeCAPEX(capex, discountRate, lifetime) {
            const crf = CRF(discountRate / 100, lifetime);
            return capex * crf;
        }

        // Annualize Depex (R√ºckbaukosten am Ende der Lebensdauer)
        function annualizeDepex(depex, discountRate, lifetime) {
            // Barwert des R√ºckbaus am Ende der Lebensdauer
            const pv = depex / Math.pow(1 + discountRate / 100, lifetime);
            const crf = CRF(discountRate / 100, lifetime);
            return pv * crf;
        }

        // Get input value
        function getInput(id) {
            const element = document.getElementById(id);
            return element ? parseFloat(element.value) || 0 : 0;
        }

        // Get common parameters
        function getCommonParams() {
            return {
                discountRate: getInput('discount_rate'),
                lifetime: getInput('project_lifetime')
            };
        }

        // Automatische Design-Empfehlungen (auf Basis der Optimierungsergebnisse)
        function generateDesignRecommendations() {
            const listEl = document.getElementById('design_recommendations_list');
            if (!listEl) return;
            listEl.innerHTML = '';

            // aktuelle Konfiguration aus Vergleichs-Box lesen
            const currCostText = document.getElementById('comparison_current_cost')?.textContent || '';
            const currPelText = document.getElementById('comparison_current_pel')?.textContent || '';
            const currH2Text = document.getElementById('comparison_current_h2')?.textContent || '';
            const currNh3Text = document.getElementById('comparison_current_nh3')?.textContent || '';

            const currentCost = parseFloat(currCostText.replace(' ‚Ç¨/kg', '').trim());
            const currentPel = parseFloat(currPelText);
            const currentH2 = parseFloat(currH2Text) || 0;
            const currentNh3 = parseFloat(currNh3Text) || 0;

            const internal = window.internalOptBest || null;
            const gurobi = window.gurobiOptBest || null;

            if (!isFinite(currentCost) || currentCost <= 0 || (!internal && !gurobi)) {
                const li = document.createElement('li');
                li.textContent = 'Noch keine vollst√§ndigen Ergebnisse verf√ºgbar. Bitte zun√§chst Kosten berechnen und mindestens eine Optimierung ausf√ºhren.';
                listEl.appendChild(li);
                return;
            }

            // Bester Optimierer (niedrigste Kosten) ausw√§hlen
            let bestSource = null;
            let best = null;
            if (internal && gurobi) {
                bestSource = internal.costPerKg <= gurobi.costPerKg ? 'Raster-Optimierung' : 'Gurobi-Optimierung';
                best = internal.costPerKg <= gurobi.costPerKg ? internal : gurobi;
            } else if (internal) {
                bestSource = 'Raster-Optimierung';
                best = internal;
            } else if (gurobi) {
                bestSource = 'Gurobi-Optimierung';
                best = gurobi;
            }

            if (!best || !isFinite(best.costPerKg)) {
                const li = document.createElement('li');
                li.textContent = 'Optimierung konnte keine sinnvolle Kostensch√§tzung liefern.';
                listEl.appendChild(li);
                return;
            }

            // 1) Gesamtkosten-Vergleich
            const liCost = document.createElement('li');
            liCost.textContent = `Wechsle von der aktuellen Konfiguration (${currentCost.toFixed(4)} ‚Ç¨/kg) auf die beste gefundene Konfiguration (${best.costPerKg.toFixed(4)} ‚Ç¨/kg, ${bestSource}), um die spezifischen H‚ÇÇ-Kosten zu senken.`;
            listEl.appendChild(liCost);

            // Hilfsfunktion f√ºr relative √Ñnderung
            function relDiff(oldVal, newVal) {
                if (!isFinite(oldVal) || oldVal <= 0) return 0;
                return (newVal - oldVal) / oldVal;
            }

            // 2) Elektrolyseur-Leistung
            if (isFinite(currentPel) && isFinite(best.pel)) {
                const dRel = relDiff(currentPel, best.pel);
                if (Math.abs(dRel) > 0.05) { // nur relevante √Ñnderungen >5 %
                    const li = document.createElement('li');
                    if (best.pel > currentPel) {
                        li.textContent = `Erh√∂he die Elektrolyseur-Leistung von ${currentPel.toFixed(0)} MW auf etwa ${best.pel.toFixed(0)} MW, um mehr g√ºnstigen Windstrom nutzen zu k√∂nnen und die Fixkosten pro kg H‚ÇÇ zu reduzieren.`;
                    } else {
                        li.textContent = `Reduziere die Elektrolyseur-Leistung von ${currentPel.toFixed(0)} MW auf etwa ${best.pel.toFixed(0)} MW, um √ºberdimensionierte Kapazit√§ten und unn√∂tigen CAPEX zu vermeiden.`;
                    }
                    listEl.appendChild(li);
                }
            }

            // 3) H2-Speicher
            if (isFinite(currentH2) && isFinite(best.h2Storage)) {
                const dRel = relDiff(currentH2, best.h2Storage);
                if (Math.abs(dRel) > 0.05) {
                    const li = document.createElement('li');
                    if (best.h2Storage > currentH2) {
                        li.textContent = `Vergr√∂√üere den H‚ÇÇ-Speicher von ca. ${currentH2.toFixed(0)} t auf etwa ${best.h2Storage.toFixed(0)} t, um Windschwankungen besser abzufedern und Schiffsausf√§lle zu vermeiden.`;
                    } else {
                        li.textContent = `Reduziere den H‚ÇÇ-Speicher von ca. ${currentH2.toFixed(0)} t auf etwa ${best.h2Storage.toFixed(0)} t, um unn√∂tige Speicher-CAPEX zu sparen, ohne die Versorgungssicherheit zu gef√§hrden.`;
                    }
                    listEl.appendChild(li);
                }
            }

            // 4) NH3-Speicher / Schiffe
            if (isFinite(currentNh3) && isFinite(best.nh3Storage)) {
                const dRel = relDiff(currentNh3, best.nh3Storage);
                if (Math.abs(dRel) > 0.05) {
                    const li = document.createElement('li');
                    if (best.nh3Storage > currentNh3) {
                        li.textContent = `Erh√∂he die effektive NH‚ÇÉ-Speicher- bzw. Schiffs-Kapazit√§t von ca. ${currentNh3.toFixed(0)} t auf etwa ${best.nh3Storage.toFixed(0)} t, damit alle geplanten Schiffsabfahrten ohne Ausf√§lle bedient werden k√∂nnen.`;
                    } else {
                        li.textContent = `Reduziere die NH‚ÇÉ-Speicher- bzw. Schiffs-Kapazit√§t von ca. ${currentNh3.toFixed(0)} t auf etwa ${best.nh3Storage.toFixed(0)} t, um CAPEX der NH‚ÇÉ-Speicher zu senken, solange keine Schiffsausf√§lle auftreten.`;
                    }
                    listEl.appendChild(li);
                }
            }

            // 5) Detaillierte Empfehlungen je nach Kostenanteil der Komponenten
            if (Array.isArray(currentCostBreakdown) && currentCostBreakdown.length > 0) {
                const totals = currentCostBreakdown.map(item => ({
                    name: item.name,
                    total: (item.capex || 0) + (item.opex || 0) + (item.variable || 0)
                }));
                const grandTotal = totals.reduce((sum, t) => sum + t.total, 0);
                if (grandTotal > 0) {
                    totals.sort((a, b) => b.total - a.total);
                    const top = totals.slice(0, 3);

                    top.forEach(t => {
                        const share = (t.total / grandTotal) * 100;
                        const li = document.createElement('li');
                        if (t.name === 'Storage') {
                            li.textContent = `Der Block ‚Äû${t.name}‚Äú tr√§gt etwa ${share.toFixed(1)} % zu den H‚ÇÇ-Kosten bei. Pr√ºfe insbesondere, ob H‚ÇÇ- und NH‚ÇÉ-Speicher (Tage, Schiffe) n√§her an den durch die Optimierung vorgeschlagenen Werten dimensioniert werden k√∂nnen, um CAPEX zu reduzieren.`;
                        } else if (t.name === 'Transport') {
                            li.textContent = `Der Block ‚Äû${t.name}‚Äú verursacht rund ${share.toFixed(1)} % der Gesamtkosten. Weitere Kostensenkung w√§re vor allem √ºber effizientere Logistik (z.‚ÄØB. gr√∂√üere Schiffe, weniger Fahrten, g√ºnstigere Treibstoff- oder Hafen-Konditionen) m√∂glich ‚Äì diese Parameter liegen teilweise au√üerhalb des Optimierungsraums des Modells.`;
                        } else if (t.name === 'Electrolysis') {
                            li.textContent = `‚Äû${t.name}‚Äú macht etwa ${share.toFixed(1)} % der Kosten aus. Hier wirken sich Wahl der Technologie (AEL vs. PEM), Elektrolyseur-Leistung und Volllaststunden besonders stark auf ‚Ç¨/kg aus ‚Äì die Optimierungsergebnisse geben eine gute Zielgr√∂√üe f√ºr die erforderliche Leistung vor.`;
                        } else if (t.name === 'Wind Farm') {
                            li.textContent = `‚Äû${t.name}‚Äú tr√§gt ca. ${share.toFixed(1)} % bei. Zus√§tzliche Kostensenkung w√§re vor allem √ºber niedrigere Stromgestehungskosten (LCOE) m√∂glich, z.‚ÄØB. durch g√ºnstigere Windprojekte oder h√∂here Auslastung ‚Äì das wird in diesem Modell √ºber die Skalierung s und P_el nur teilweise abgebildet.`;
                        } else {
                            li.textContent = `Die Komponente ‚Äû${t.name}‚Äú liegt bei etwa ${share.toFixed(1)} % der H‚ÇÇ-Kosten. Eine detaillierte technische Optimierung dieser Anlage (z.‚ÄØB. effizientere Technologie, verbesserte Betriebsf√ºhrung) k√∂nnte die Gesamtkosten weiter senken.`;
                        }
                        listEl.appendChild(li);
                    });
                }
            }

            if (!listEl.children.length) {
                const li = document.createElement('li');
                li.textContent = 'Die aktuelle Konfiguration liegt bereits sehr nahe an der kosteng√ºnstigsten L√∂sung; gr√∂√üere Designanpassungen sind aus Sicht des Modells nicht erforderlich.';
                listEl.appendChild(li);
            }
        }

        // Get H‚ÇÇ reference quantity based on user choice
        function getH2Reference() {
            const referenceChoice = document.getElementById('h2_reference_choice');
            if (!referenceChoice) {
                // Fallback: use steel plant demand if selector doesn't exist
                return getInput('h2_steel_demand') * 1000000; // kt to kg
            }
            
            const choice = referenceChoice.value;
            if (choice === 'import') {
                return getInput('h2_import_target') * 1000; // t to kg
            } else {
                return getInput('h2_steel_demand') * 1000000; // kt to kg
            }
        }

        // -----------------------------
        // Projekt-Speicherfunktion
        // -----------------------------
        const PROJECT_STORAGE_KEY = 'h2_projects_v1';

        function getStoredProjects() {
            try {
                const raw = localStorage.getItem(PROJECT_STORAGE_KEY);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (e) {
                console.warn('Projekt-Daten konnten nicht gelesen werden:', e);
                return {};
            }
        }

        function saveStoredProjects(projects) {
            try {
                localStorage.setItem(PROJECT_STORAGE_KEY, JSON.stringify(projects));
            } catch (e) {
                alert('Projekt konnte nicht gespeichert werden (localStorage voll oder blockiert).');
                console.error(e);
            }
        }

        function collectProjectData() {
            const data = {};
            const elements = document.querySelectorAll('.input-section input, .input-section select, .input-section textarea');
            elements.forEach(el => {
                if (!el.id) return;
                if (el.type === 'checkbox' || el.type === 'radio') {
                    data[el.id] = el.checked;
                } else {
                    data[el.id] = el.value;
                }
            });
            return data;
        }

        function applyProjectData(data) {
            if (!data) return;
            Object.keys(data).forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.type === 'checkbox' || el.type === 'radio') {
                    el.checked = !!data[id];
                } else {
                    el.value = data[id];
                }
            });

            // Nach dem Laden neu berechnen
            try {
                const pages = document.querySelectorAll('.page-section');
                const currentPage = Array.from(pages).findIndex(page => page.classList.contains('active'));
                if (currentPage >= 0) {
                    calculatePageCosts(currentPage);
                }
                if (typeof calculateCosts === 'function') {
                    calculateCosts();
                }
            } catch (e) {
                console.warn('Fehler beim Neuberechnen nach Projekt-Laden:', e);
            }
        }

        function refreshProjectSelect() {
            const select = document.getElementById('project_select');
            if (!select) return;
            const projects = getStoredProjects();
            const names = Object.keys(projects).sort((a, b) => a.localeCompare(b, 'de-DE'));
            select.innerHTML = '<option value=\"\">Projekt ausw√§hlen‚Ä¶</option>';
            names.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }

        function saveProjectConfig() {
            let nameInput = document.getElementById('project_name_input');
            let name = nameInput ? nameInput.value.trim() : '';
            if (!name) {
                const select = document.getElementById('project_select');
                const prefill = select && select.value ? select.value : '';
                name = prompt('Bitte Projektnamen eingeben:', prefill || '');
                if (!name) {
                    return;
                }
            }
            const projects = getStoredProjects();
            projects[name] = {
                data: collectProjectData(),
                savedAt: new Date().toISOString()
            };
            saveStoredProjects(projects);
            refreshProjectSelect();
            alert('Projekt "' + name + '" wurde gespeichert.');
            if (nameInput) {
                nameInput.value = name;
            }
            const select = document.getElementById('project_select');
            if (select) {
                select.value = name;
            }
        }

        function loadSelectedProject() {
            const select = document.getElementById('project_select');
            if (!select) return;
            const name = select.value;
            if (!name) {
                alert('Bitte ein gespeichertes Projekt ausw√§hlen.');
                return;
            }
            const projects = getStoredProjects();
            if (!projects[name]) {
                alert('Projekt "' + name + '" wurde nicht gefunden.');
                refreshProjectSelect();
                return;
            }
            applyProjectData(projects[name].data);
            const nameInput = document.getElementById('project_name_input');
            if (nameInput) {
                nameInput.value = name;
            }
        }

        function deleteSelectedProject() {
            const select = document.getElementById('project_select');
            if (!select) return;
            const name = select.value;
            if (!name) {
                alert('Bitte ein gespeichertes Projekt ausw√§hlen, das gel√∂scht werden soll.');
                return;
            }
            if (!confirm('Projekt "' + name + '" wirklich l√∂schen?')) {
                return;
            }
            const projects = getStoredProjects();
            if (projects[name]) {
                delete projects[name];
                saveStoredProjects(projects);
                refreshProjectSelect();
                alert('Projekt "' + name + '" wurde gel√∂scht.');
            }
        }

        // Typische NH‚ÇÉ-Schiffsklassen (vereinfachte Annahmen, gerundete Werte)
        const VESSEL_TYPES = {
            handysize: {
                name: 'Handysize Gas Carrier',
                tankVolume: 20000, // m¬≥
                // CAPEX/OPEX werden aus Referenz (48.000 m¬≥, 61.5 M‚Ç¨ / 5 M‚Ç¨/a) skaliert
            },
            mgc: {
                name: 'Midsize Gas Carrier (MGC)',
                tankVolume: 48000 // m¬≥ ‚Äì orientiert an typischer MGC-Gr√∂√üe
            },
            lgc: {
                name: 'Large Gas Carrier (LGC)',
                tankVolume: 55000 // m¬≥
            },
            vlgc: {
                name: 'Very Large Gas Carrier (VLGC)',
                tankVolume: 80000 // m¬≥
            }
        };

        function onVesselTypeChange(type) {
            const tankInput = document.getElementById('vessel_tank_volume');
            const capexInput = document.getElementById('vessel_capex');
            const opexInput = document.getElementById('vessel_opex');
            if (!tankInput || !capexInput || !opexInput) return;

            // Referenz f√ºr Skalierung: 48.000 m¬≥, 61.5 M‚Ç¨, 5 M‚Ç¨/a
            const refVolume = 48000;
            const refCapex = 61.5;
            const refOpex = 5.0;

            if (!type || !VESSEL_TYPES[type]) {
                // Benutzerdefiniert ‚Äì nichts automatisch √ºberschreiben
                return;
            }

            const cfg = VESSEL_TYPES[type];
            const vol = cfg.tankVolume;
            tankInput.value = vol.toFixed(0);

            const factor = vol / refVolume;
            const newCapex = refCapex * factor;
            const newOpex = refOpex * factor;

            capexInput.value = newCapex.toFixed(1);
            opexInput.value = newOpex.toFixed(2);

            // Nach √Ñnderung direkt Transportkosten neu berechnen, falls Seite aktiv
            try {
                calculateTransportCosts();
            } catch (e) {
                console.warn('Fehler bei automatischer Transport-Neuberechnung nach Schiffstyp-√Ñnderung:', e);
            }
        }

        // Export current configuration and results as printable HTML (for PDF export)
        function exportProjectPdf() {
            const projectSelect = document.getElementById('project_select');
            const projectName = projectSelect && projectSelect.value ? projectSelect.value : 'Unbenanntes Projekt';

            // Sammle zentrale Ergebnisse
            const costPerKg = document.getElementById('result_cost_per_kg')?.textContent || '-';
            const totalAnnual = document.getElementById('result_total_annual')?.textContent || '-';
            const h2Delivered = document.getElementById('result_h2_delivered')?.textContent || '-';

            // Einige wichtige Eingaben (System-Seite)
            const h2Target = document.getElementById('h2_import_target')?.value || '';
            const h2Steel = document.getElementById('h2_steel_demand')?.value || '';
            const discountRate = document.getElementById('discount_rate')?.value || '';
            const lifetime = document.getElementById('project_lifetime')?.value || '';

            // Parameter + Ergebnisse pro Seite einsammeln
            let perPageSectionsHtml = '';
            const pageSections = document.querySelectorAll('.page-section');
            pageSections.forEach((section, index) => {
                const headerEl = section.querySelector('.page-header h2');
                const pageTitle = headerEl ? headerEl.innerText.replace(/\s+/g, ' ').trim() : `Seite ${index + 1}`;

                // Parameter-Tabelle f√ºr diese Seite
                let rows = '';
                const paramItems = section.querySelectorAll('.parameter-item');
                paramItems.forEach(item => {
                    const labelEl = item.querySelector('.parameter-label');
                    const valueEl = item.querySelector('input, select, textarea');
                    if (!labelEl || !valueEl) return;
                    let value;
                    if (valueEl.type === 'checkbox') {
                        value = valueEl.checked ? 'Ja' : 'Nein';
                    } else {
                        value = valueEl.value;
                    }
                    const label = labelEl.innerText.replace(/\s+/g, ' ').trim();
                    rows += `<tr><td>${label}</td><td>${value}</td></tr>`;
                });

                // Ergebnisse dieser Seite (falls vorhanden)
                let pageResultsHtml = '';
                const pageResultsId = `page${index}_results`;
                const pageResultsDiv = document.getElementById(pageResultsId);
                if (pageResultsDiv) {
                    pageResultsHtml = pageResultsDiv.innerHTML;
                }

                perPageSectionsHtml += `
  <div class="section">
    <h2>Seite ${index + 1}: ${pageTitle}</h2>
    <p class="small">Eingabeparameter und berechnete Ergebnisse f√ºr diese Seite.</p>
    <table>
      <tr><th>Parameter</th><th>Wert</th></tr>
      ${rows}
    </table>
    ${pageResultsHtml ? `<div style="margin-top:16px;">${pageResultsHtml}</div>` : ''}
  </div>`;
            });

            // Optimierungsergebnisse (falls vorhanden)
            let optimizationHtml = '<p>Noch keine Optimierung berechnet.</p>';
            const optDiv = document.getElementById('optimization_results');
            if (optDiv && optDiv.innerText.trim() !== '' && optDiv.style.display !== 'none') {
                optimizationHtml = optDiv.innerHTML;
            }

            // Canvas-Diagramme als Bilder exportieren
            function canvasToImg(id) {
                const canvas = document.getElementById(id);
                if (!canvas) return '';
                try {
                    const url = canvas.toDataURL('image/png');
                    return `<img src="${url}" alt="${id}" style="max-width:100%; margin-top:10px; border:1px solid #ccc;" />`;
                } catch (e) {
                    console.warn('Konnte Canvas nicht exportieren:', id, e);
                    return '';
                }
            }

            const costChartImg = canvasToImg('costChart');
            const costTypeChartImg = canvasToImg('costTypeChart');

            const win = window.open('', '_blank', 'width=900,height=1000');
            if (!win) {
                alert('Popup wurde vom Browser blockiert. Bitte Popups f√ºr diese Seite erlauben.');
                return;
            }

            const html = `
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>H‚ÇÇ Kostenrechner Bericht - ${projectName}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 20px; color: #222; }
    h1, h2, h3 { color: #1a237e; }
    .header { border-bottom: 2px solid #1a237e; margin-bottom: 16px; padding-bottom: 8px; }
    .section { margin-top: 24px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 0.9em; }
    th { background: #e3f2fd; text-align: left; }
    .explanation { font-size: 0.9em; line-height: 1.5; }
    .small { font-size: 0.8em; color: #555; }
  </style>
</head>
<body>
  <div class="header">
    <h1>H‚ÇÇ Kostenrechner ‚Äì Projektbericht</h1>
    <div><strong>Projektname:</strong> ${projectName}</div>
    <div><strong>Datum:</strong> ${new Date().toLocaleString('de-DE')}</div>
  </div>

  <div class="section">
    <h2>1. Zentrale Ergebnisse</h2>
    <table>
      <tr><th>Kennzahl</th><th>Wert</th></tr>
      <tr><td>Kosten pro kg H‚ÇÇ (delivered)</td><td>${costPerKg}</td></tr>
      <tr><td>Gesamtkosten pro Jahr</td><td>${totalAnnual}</td></tr>
      <tr><td>J√§hrlich gelieferter H‚ÇÇ</td><td>${h2Delivered}</td></tr>
    </table>
    <p class="explanation">
      Die Kennzahl <strong>Kosten pro kg H‚ÇÇ delivered</strong> fasst alle Investitions-, Betriebs-,
      Transport- und Speicher¬≠kosten entlang der gesamten Kette zusammen und teilt sie durch die
      gelieferte H‚ÇÇ-Menge. Sie ist die wichtigste Gr√∂√üe f√ºr den Vergleich verschiedener Szenarien.
    </p>
    <p class="explanation">
      Zum Vergleich: Ver√∂ffentlichte Studien f√ºr importierten erneuerbaren Wasserstoff (via Ammoniak)
      nach Europa liegen typischerweise bei etwa <strong>4,8‚Äì6,2&nbsp;‚Ç¨/kg H‚ÇÇ</strong> im Jahr 2030.
      Werte deutlich darunter deuten auf sehr optimistische Annahmen hin, Werte deutlich dar√ºber auf
      eher konservative oder ung√ºnstige Randbedingungen.
    </p>
  </div>

  <div class="section">
    <h2>2. Zentrale Eingabeparameter</h2>
    <table>
      <tr><th>Parameter</th><th>Wert</th></tr>
      <tr><td>Importziel H‚ÇÇ (t/Jahr)</td><td>${h2Target}</td></tr>
      <tr><td>Stahlwerksbedarf (kt/Jahr)</td><td>${h2Steel}</td></tr>
      <tr><td>Diskontrate (%)</td><td>${discountRate}</td></tr>
      <tr><td>Projektlebensdauer (Jahre)</td><td>${lifetime}</td></tr>
    </table>
    <p class="explanation">
      Diese Parameter steuern die Skalierung des gesamten Systems. Die Diskontrate und
      Projektlebensdauer bestimmen, wie Investitionskosten √ºber die Zeit auf Jahreskosten
      umgelegt werden.
    </p>
  </div>

  <div class="section">
    <h2>3. Interpretation der Ergebnisse</h2>
    <p class="explanation">
      <strong>Hohe Werte</strong> bei den Kosten pro kg H‚ÇÇ weisen auf teure Teilbereiche der
      Kette hin (z.&nbsp;B. Windstrom, Elektrolyse, Speicher oder Transport). Durch Variation
      der Eingaben auf den einzelnen Seiten (Wind, Elektrolyse, Wasser, Stickstoff,
      Ammoniak, Speicher, Transport, Cracking) k√∂nnen Sie Szenarien vergleichen und
      Kostentreiber identifizieren.
    </p>
    <p class="explanation">
      F√ºr Dokumentation und Berichte empfiehlt es sich, mehrere Projekte mit
      unterschiedlichen Annahmen zu speichern und jeweils einen PDF-Bericht zu erzeugen.
    </p>
  </div>

  ${perPageSectionsHtml}

  <div class="section">
    <h2>Optimierungsergebnisse</h2>
    <p class="small">
      Dieser Abschnitt zeigt die aktuell angezeigten Optimierungsergebnisse aus der Benutzeroberfl√§che.
    </p>
    <div>
      ${optimizationHtml}
    </div>
  </div>

  <div class="section">
    <h2>Diagramme</h2>
    <p class="small">
      Export der wichtigsten Kosten¬≠diagramme aus der Simulation.
    </p>
    ${costChartImg ? `<h3>Gesamtkosten-Verteilung</h3>${costChartImg}` : '<p class="small">Diagramm "costChart" ist noch nicht berechnet.</p>'}
    ${costTypeChartImg ? `<h3>Kostentypen</h3>${costTypeChartImg}` : '<p class="small">Diagramm "costTypeChart" ist noch nicht berechnet.</p>'}
  </div>
</body>
</html>
`;

            win.document.open();
            win.document.write(html);
            win.document.close();

            // Warten, bis das neue Dokument geladen ist, dann Druckdialog √∂ffnen
            win.onload = function() {
                win.focus();
                win.print();
            };
        }

        // Calculate Wind Costs (Page 1)
        function calculateWindCosts() {
            const params = getCommonParams();
            const windCapacity = getInput('wind_capacity') * 1000; // GW to MW
            const windCapacityFactor = getInput('wind_capacity_factor') / 100;
            const windCAPEX = getInput('wind_capex') * 1000000000; // billion to ‚Ç¨
            const windOPEX = getInput('wind_opex') * 1000000; // million to ‚Ç¨
            const windDepex = getInput('wind_depex') * 1000000; // million to ‚Ç¨

            const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor; // MWh
            const windCAPEXannual = annualizeCAPEX(windCAPEX, params.discountRate, params.lifetime);
            const windDepexAnnual = annualizeDepex(windDepex, params.discountRate, params.lifetime);
            const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
            const electricityPriceWind = windCostAnnual / (windElectricityAnnual * 1000); // ‚Ç¨/kWh

            document.getElementById('wind_cost_annual').textContent = (windCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('wind_capex_annual').textContent = (windCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('wind_opex_annual').textContent = (windOPEX / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('wind_depex_annual').textContent = (windDepexAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('wind_electricity_output').textContent = (windElectricityAnnual / 1000).toFixed(2) + ' GWh/year';
            document.getElementById('wind_electricity_price').textContent = (electricityPriceWind * 1000).toFixed(4) + ' ‚Ç¨/MWh';
        }

        // Calculate Electrolysis Costs (Page 2)
        function calculateElectrolysisCosts() {
            const params = getCommonParams();
            const h2Production = getInput('h2_production') * 1000000; // kt to kg
            const electrolysisSpecificEnergy = getInput('electrolysis_specific_energy'); // kWh/kg
            const electrolysisAvailability = getInput('electrolysis_availability') / 100;
            // Effektive Stunden: Wenn Input vorhanden, verwende diesen, sonst berechne aus Verf√ºgbarkeit
            let hOpEffectiveLocal = getInput('electrolysis_effective_hours');
            if (hOpEffectiveLocal <= 0) {
                hOpEffectiveLocal = 8760 * electrolysisAvailability;
            }
            const electrolysisCAPEXperkW = getInput('electrolysis_capex_per_kw');
            const electrolysisOPEX = getInput('electrolysis_opex') * 1000000; // million to ‚Ç¨

            // Get internal electricity price from wind calculation
            const windCapacity = getInput('wind_capacity') * 1000;
            const windCapacityFactor = getInput('wind_capacity_factor') / 100;
            const windCAPEX = getInput('wind_capex') * 1000000000;
            const windOPEX = getInput('wind_opex') * 1000000;
            const windDepex = getInput('wind_depex') * 1000000;
            const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor;
            const windCAPEXannual = annualizeCAPEX(windCAPEX, params.discountRate, params.lifetime);
            const windDepexAnnual = annualizeDepex(windDepex, params.discountRate, params.lifetime);
            const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
            const electricityPriceElectrolysis = windCostAnnual / (windElectricityAnnual * 1000);

            const electrolysisElectricityDemand = h2Production * electrolysisSpecificEnergy; // kWh
            const electrolysisPower = electrolysisElectricityDemand / hOpEffectiveLocal; // kW
            const electrolysisCAPEX = electrolysisPower * electrolysisCAPEXperkW;
            const electrolysisCAPEXannual = annualizeCAPEX(electrolysisCAPEX, params.discountRate, params.lifetime);
            const electrolysisElectricityCost = electricityPriceElectrolysis * electrolysisElectricityDemand;
            const electrolysisCostAnnual = electrolysisCAPEXannual + electrolysisOPEX + electrolysisElectricityCost;

            document.getElementById('electrolysis_cost_annual').textContent = (electrolysisCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('electrolysis_capex_annual').textContent = (electrolysisCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('electrolysis_opex_annual').textContent = (electrolysisOPEX / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('electrolysis_electricity_cost').textContent = (electrolysisElectricityCost / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('electrolysis_power').textContent = (electrolysisPower / 1000).toFixed(2) + ' MW';
            document.getElementById('electrolysis_electricity_demand').textContent = (electrolysisElectricityDemand / 1000000).toFixed(2) + ' GWh/year';
        }

        // Calculate Desalination Costs (Page 3)
        function calculateDesalinationCosts() {
            const params = getCommonParams();
            const h2Production = getInput('h2_production') * 1000000; // kt to kg
            const deionisedWaterDemand = getInput('deionised_water_demand'); // L/kg
            const desalinationSpecificEnergy = getInput('desalination_specific_energy'); // kWh/m¬≥
            const desalinationCAPEX = getInput('desalination_capex') * 1000000; // million to ‚Ç¨
            const desalinationOPEX = getInput('desalination_opex') * 1000000; // million to ‚Ç¨

            // Get internal electricity price
            const windCapacity = getInput('wind_capacity') * 1000;
            const windCapacityFactor = getInput('wind_capacity_factor') / 100;
            const windCAPEX = getInput('wind_capex') * 1000000000;
            const windOPEX = getInput('wind_opex') * 1000000;
            const windDepex = getInput('wind_depex') * 1000000;
            const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor;
            const windCAPEXannual = annualizeCAPEX(windCAPEX, params.discountRate, params.lifetime);
            const windDepexAnnual = annualizeDepex(windDepex, params.discountRate, params.lifetime);
            const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
            const electricityPriceDesalination = windCostAnnual / (windElectricityAnnual * 1000);

            const waterDemandAnnual = h2Production * (deionisedWaterDemand / 1000); // m¬≥
            const eRoGwh = getInput('desalination_electricity_gwh_year') || 0;
            const desalinationElectricityDemand = (eRoGwh > 0) ? (eRoGwh * 1e6) : (waterDemandAnnual * desalinationSpecificEnergy); // kWh (E_RO)
            const desalinationCAPEXannual = annualizeCAPEX(desalinationCAPEX, params.discountRate, params.lifetime);
            const desalinationElectricityCost = electricityPriceDesalination * desalinationElectricityDemand;
            const desalinationCostAnnual = desalinationCAPEXannual + desalinationOPEX + desalinationElectricityCost;

            document.getElementById('desalination_cost_annual').textContent = (desalinationCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('desalination_capex_annual').textContent = (desalinationCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('desalination_opex_annual').textContent = (desalinationOPEX / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('desalination_electricity_cost').textContent = (desalinationElectricityCost / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('desalination_water_demand').textContent = (waterDemandAnnual / 1000).toFixed(2) + ' thousand m¬≥/year';

            // Sync water storage values to Page 6
            const waterStorageCAPEXValue = getInput('water_storage_capex');
            const waterStorageCapacityValue = getInput('water_storage_capacity');
            const waterStorageCAPEXStorage = document.getElementById('water_storage_capex_storage');
            const waterStorageCapacityStorage = document.getElementById('water_storage_capacity_storage');
            if (waterStorageCAPEXStorage) waterStorageCAPEXStorage.value = waterStorageCAPEXValue;
            if (waterStorageCapacityStorage) waterStorageCapacityStorage.value = waterStorageCapacityValue;
            
            // Recalculate storage costs if on storage page
            const pages = document.querySelectorAll('.page-section');
            const currentPage = Array.from(pages).findIndex(page => page.classList.contains('active'));
            if (currentPage === 6) { // Page 7 (index 6)
                calculateStorageCosts();
            }
        }

        // Calculate ASU Costs (Page 4)
        function calculateASUCosts() {
            const params = getCommonParams();
            const nitrogenDemand = getInput('nitrogen_demand'); // t/day
            let asuCAPEX = getInput('asu_capex') * 1000000; // million to ‚Ç¨
            let asuOPEX = getInput('asu_opex') * 1000000; // million to ‚Ç¨
            const asuElectricity = getInput('asu_electricity') * 1000000; // GWh to kWh
            const asuCapacity = getInput('asu_capacity'); // t N‚ÇÇ/day
            const asuCAPEXperUnit = getInput('asu_capex_per_unit');
            const asuOPEXshare = getInput('asu_opex_share');
            
            // If CAPEX per unit is provided, calculate from capacity
            if (asuCAPEXperUnit > 0) {
                asuCAPEX = asuCapacity * asuCAPEXperUnit;
            }
            // If OPEX share is provided, calculate from CAPEX
            if (asuOPEXshare > 0 && asuOPEX === 0) {
                asuOPEX = asuCAPEX * asuOPEXshare;
            }

            // Get electricity price (internal or external)
            const electricityCostMethod = document.getElementById('electricity_cost_method').value;
            let electricityPrice = 0;
            
            if (electricityCostMethod === 'internal_LCOE') {
                const windCapacity = getInput('wind_capacity') * 1000;
                const windCapacityFactor = getInput('wind_capacity_factor') / 100;
                const windCAPEX = getInput('wind_capex') * 1000000000;
                const windOPEX = getInput('wind_opex') * 1000000;
                const windDepex = getInput('wind_depex') * 1000000;
                const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor;
                const windCAPEXannual = annualizeCAPEX(windCAPEX, params.discountRate, params.lifetime);
                const windDepexAnnual = annualizeDepex(windDepex, params.discountRate, params.lifetime);
                const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
                electricityPrice = windCostAnnual / (windElectricityAnnual * 1000);
            } else {
                electricityPrice = getInput('external_electricity_price') / 1000; // MWh to kWh
            }

            const asuCAPEXannual = annualizeCAPEX(asuCAPEX, params.discountRate, params.lifetime);
            const asuElectricityCost = electricityPrice * asuElectricity;
            const asuCostAnnual = asuCAPEXannual + asuOPEX + asuElectricityCost;
            const nitrogenDemandAnnual = nitrogenDemand * 365; // t/year

            document.getElementById('asu_cost_annual').textContent = (asuCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('asu_capex_annual').textContent = (asuCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('asu_opex_annual').textContent = (asuOPEX / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('asu_electricity_cost').textContent = (asuElectricityCost / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('asu_nitrogen_demand').textContent = nitrogenDemandAnnual.toFixed(0) + ' t/year';
        }

        // Calculate Haber-Bosch Costs (Page 5)
        function calculateHaberBoschCosts() {
            const params = getCommonParams();
            const ammoniaProduction = getInput('ammonia_production'); // t/day
            let haberBoschCAPEX = getInput('haber_bosch_capex') * 1000000; // million to ‚Ç¨
            let haberBoschOPEX = getInput('haber_bosch_opex') * 1000000; // million to ‚Ç¨
            const haberBoschElectricity = getInput('haber_bosch_electricity') * 1000000; // GWh to kWh
            const haberBoschCapacity = getInput('haber_bosch_capacity'); // t NH‚ÇÉ/day
            const haberBoschCAPEXperUnit = getInput('haber_bosch_capex_per_unit');
            const haberBoschOPEXshare = getInput('haber_bosch_opex_share');
            
            // If CAPEX per unit is provided, calculate from capacity
            if (haberBoschCAPEXperUnit > 0) {
                haberBoschCAPEX = haberBoschCapacity * haberBoschCAPEXperUnit;
            }
            // If OPEX share is provided, calculate from CAPEX
            if (haberBoschOPEXshare > 0 && haberBoschOPEX === 0) {
                haberBoschOPEX = haberBoschCAPEX * haberBoschOPEXshare;
            }

            // Get electricity price (internal or external)
            const electricityCostMethod = document.getElementById('electricity_cost_method').value;
            let electricityPrice = 0;
            
            if (electricityCostMethod === 'internal_LCOE') {
                const windCapacity = getInput('wind_capacity') * 1000;
                const windCapacityFactor = getInput('wind_capacity_factor') / 100;
                const windCAPEX = getInput('wind_capex') * 1000000000;
                const windOPEX = getInput('wind_opex') * 1000000;
                const windDepex = getInput('wind_depex') * 1000000;
                const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor;
                const windCAPEXannual = annualizeCAPEX(windCAPEX, params.discountRate, params.lifetime);
                const windDepexAnnual = annualizeDepex(windDepex, params.discountRate, params.lifetime);
                const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
                electricityPrice = windCostAnnual / (windElectricityAnnual * 1000);
            } else {
                electricityPrice = getInput('external_electricity_price') / 1000; // MWh to kWh
            }

            const haberBoschCAPEXannual = annualizeCAPEX(haberBoschCAPEX, params.discountRate, params.lifetime);
            const haberBoschElectricityCost = electricityPrice * haberBoschElectricity;
            const haberBoschCostAnnual = haberBoschCAPEXannual + haberBoschOPEX + haberBoschElectricityCost;
            const ammoniaProductionAnnual = ammoniaProduction * 365; // t/year

            document.getElementById('haber_bosch_cost_annual').textContent = (haberBoschCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('haber_bosch_capex_annual').textContent = (haberBoschCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('haber_bosch_opex_annual').textContent = (haberBoschOPEX / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('haber_bosch_electricity_cost').textContent = (haberBoschElectricityCost / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('haber_bosch_ammonia_production').textContent = (ammoniaProductionAnnual / 1000).toFixed(2) + ' kt/year';
        }

        // Calculate Storage Costs (Page 6)
        function calculateStorageCosts() {
            const params = getCommonParams();
            const storageH2CAPEX = getInput('storage_h2_capex') * 1000000; // million to ‚Ç¨
            const storageNH3CAPEX = getInput('storage_nh3_capex') * 1000000; // million to ‚Ç¨
            const storageOPEX = getInput('storage_opex') * 1000000; // million to ‚Ç¨
            // Get water storage from Page 6 (can be edited there) or fallback to Page 3
            let waterStorageCAPEX = getInput('water_storage_capex_storage') * 1000000; // million to ‚Ç¨
            if (waterStorageCAPEX === 0) {
                waterStorageCAPEX = getInput('water_storage_capex') * 1000000; // fallback to Page 3
            }

            // Get water storage from Page 6 (can be edited there) or fallback to Page 3
            let waterStorageCAPEXValue = getInput('water_storage_capex_storage');
            let waterStorageCapacityValue = getInput('water_storage_capacity_storage');
            
            // If Page 6 fields are empty, sync from Page 3
            if (waterStorageCAPEXValue === 0) {
                waterStorageCAPEXValue = getInput('water_storage_capex');
                const waterStorageCAPEXStorage = document.getElementById('water_storage_capex_storage');
                if (waterStorageCAPEXStorage) waterStorageCAPEXStorage.value = waterStorageCAPEXValue;
            }
            if (waterStorageCapacityValue === 0) {
                waterStorageCapacityValue = getInput('water_storage_capacity');
                const waterStorageCapacityStorage = document.getElementById('water_storage_capacity_storage');
                if (waterStorageCapacityStorage) waterStorageCapacityStorage.value = waterStorageCapacityValue;
            }
            
            // Sync back to Page 3 for consistency
            const waterStorageCAPEXPage3 = document.getElementById('water_storage_capex');
            const waterStorageCapacityPage3 = document.getElementById('water_storage_capacity');
            if (waterStorageCAPEXPage3 && waterStorageCAPEXValue > 0) waterStorageCAPEXPage3.value = waterStorageCAPEXValue;
            if (waterStorageCapacityPage3 && waterStorageCapacityValue > 0) waterStorageCapacityPage3.value = waterStorageCapacityValue;

            const storageTotalCAPEX = storageH2CAPEX + storageNH3CAPEX + waterStorageCAPEX;
            const storageCAPEXannual = annualizeCAPEX(storageTotalCAPEX, params.discountRate, params.lifetime);
            const storageCostAnnual = storageCAPEXannual + storageOPEX;

            document.getElementById('storage_cost_annual').textContent = (storageCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('storage_capex_annual').textContent = (storageCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('storage_opex_annual').textContent = (storageOPEX / 1000000).toFixed(2) + ' M‚Ç¨/year';
        }

        // Calculate Transport Costs (Page 7)
        function calculateTransportCosts() {
            const params = getCommonParams();
            
            // Get NH‚ÇÉ transport requirements
            const h2Reference = getH2Reference();
            const haberBoschLoss = getInput('haber_bosch_loss') / 100;
            const nh3ShippingLoss = getInput('nh3_shipping_loss') / 100;
            
            // H‚ÇÇ to NH‚ÇÉ conversion (stoichiometric: 3 H‚ÇÇ + N‚ÇÇ ‚Üí 2 NH‚ÇÉ)
            // Mass ratio: 17 kg NH‚ÇÉ per 3 kg H‚ÇÇ = 5.67 kg NH‚ÇÉ per kg H‚ÇÇ
            const nh3PerH2Ratio = 17 / 3; // t NH‚ÇÉ / t H‚ÇÇ
            
            // Calculate required NH‚ÇÉ considering losses
            const h2ForNH3 = h2Reference / 1000; // kg to t
            const nh3Needed = h2ForNH3 * nh3PerH2Ratio / (1 - haberBoschLoss);
            const nh3TransportRequired = nh3Needed / (1 - nh3ShippingLoss); // t/a
            
            // Transport logistics
            const transportDistance = getInput('transport_distance'); // km
            const onewayTime = getInput('transport_time'); // days
            const portTime = getInput('port_time'); // days
            
            // Manual overrides (if user entered values > 0)
            const cycleTimeManual = getInput('cycle_time_days');
            const tripsPerShipManual = getInput('trips_per_ship_a');
            const shipPayloadManual = getInput('ship_payload_nh3');
            const numVesselsManual = getInput('num_vessels');
            
            // Cycle time / trips per ship
            let cycleTime = cycleTimeManual;
            let tripsPerShip = tripsPerShipManual;
            if (!(tripsPerShip > 0 && isFinite(tripsPerShip))) {
                if (!(cycleTime > 0 && isFinite(cycleTime))) {
                    cycleTime = 2 * onewayTime + portTime; // days
                    if (cycleTime > 0 && isFinite(cycleTime)) {
                        document.getElementById('cycle_time_days').value = cycleTime.toFixed(1);
                    }
                }
                tripsPerShip = (cycleTime > 0 && isFinite(cycleTime)) ? (365 / cycleTime) : 0;
                if (tripsPerShip > 0 && isFinite(tripsPerShip)) {
                    document.getElementById('trips_per_ship_a').value = tripsPerShip.toFixed(1);
                }
            }
            
            // Ship capacity
            const vesselTankVolume = getInput('vessel_tank_volume'); // m¬≥
            const nh3Density = getInput('nh3_density'); // t/m¬≥
            const fillFactor = getInput('fill_factor');
            
            let shipPayload = shipPayloadManual;
            if (!(shipPayload > 0 && isFinite(shipPayload))) {
                shipPayload = vesselTankVolume * nh3Density * fillFactor; // t
                if (shipPayload > 0 && isFinite(shipPayload)) {
                    document.getElementById('ship_payload_nh3').value = shipPayload.toFixed(0);
                }
            }
            
            // Calculate required number of vessels
            let numVessels = Math.ceil(numVesselsManual);
            if (!(numVessels > 0 && isFinite(numVessels))) {
                numVessels = Math.ceil(nh3TransportRequired / (shipPayload * tripsPerShip));
                if (numVessels > 0 && isFinite(numVessels)) {
                    document.getElementById('num_vessels').value = numVessels;
                }
            }
            
            // Transport costs
            const vesselCAPEX = getInput('vessel_capex') * 1000000; // million to ‚Ç¨
            const vesselTotalCAPEX = vesselCAPEX * numVessels;
            const vesselCAPEXannual = annualizeCAPEX(vesselTotalCAPEX, params.discountRate, params.lifetime);
            const vesselOPEX = getInput('vessel_opex') * 1000000; // million to ‚Ç¨ per vessel
            const vesselOPEXtotal = vesselOPEX * numVessels;
            
            // Variable transport costs
            const shippingCostPerT = getInput('shipping_cost_per_t_nh3');
            const shippingCostPerTkm = getInput('shipping_cost_per_tkm');
            const fuelCostPerTrip = getInput('fuel_cost_per_trip');
            const harborFeesPerTrip = getInput('harbor_fees_per_trip');
            const insuranceRate = getInput('insurance_rate') / 100;
            
            let variableShippingCost = 0;
            if (shippingCostPerT > 0) {
                variableShippingCost = nh3TransportRequired * shippingCostPerT;
            } else if (shippingCostPerTkm > 0) {
                variableShippingCost = nh3TransportRequired * transportDistance * shippingCostPerTkm;
            }
            
            const totalTrips = numVessels * tripsPerShip;
            const fuelCostTotal = fuelCostPerTrip * totalTrips;
            const harborFeesTotal = harborFeesPerTrip * totalTrips;
            const insuranceCost = vesselTotalCAPEX * insuranceRate;
            
            // Taxes and customs
            let taxesCustoms = getInput('taxes_customs') * 1000000; // million to ‚Ç¨
            const customsRate = getInput('customs_rate') / 100;
            const vatRate = getInput('vat_rate') / 100;
            
            // If customs/VAT rates are provided, calculate from NH‚ÇÉ value
            if (customsRate > 0 || vatRate > 0) {
                // Estimate NH‚ÇÉ price (could be input parameter)
                const nh3PricePerT = 500; // ‚Ç¨/t (placeholder, could be input)
                const nh3Value = nh3TransportRequired * nh3PricePerT;
                taxesCustoms = nh3Value * (customsRate + vatRate);
            }
            
            const transportCostAnnual = vesselCAPEXannual + vesselOPEXtotal + variableShippingCost + 
                                       fuelCostTotal + harborFeesTotal + insuranceCost + taxesCustoms;

            document.getElementById('transport_cost_annual').textContent = (transportCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('transport_vessel_capex_annual').textContent = (vesselCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('transport_vessel_opex_annual').textContent = (vesselOPEXtotal / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('transport_taxes_customs').textContent = (taxesCustoms / 1000000).toFixed(2) + ' M‚Ç¨/year';
        }

        // Calculate Cracking Costs (Page 8)
        function calculateCrackingCosts() {
            const params = getCommonParams();
            const crackingEfficiency = getInput('cracking_efficiency');
            const crackingCAPEX = getInput('cracking_capex') * 1000000; // million to ‚Ç¨
            const crackingOPEX = getInput('cracking_opex') * 1000000; // million to ‚Ç¨

            const crackingCAPEXannual = annualizeCAPEX(crackingCAPEX, params.discountRate, params.lifetime);
            const crackingCostAnnual = crackingCAPEXannual + crackingOPEX;

            document.getElementById('cracking_cost_annual').textContent = (crackingCostAnnual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('cracking_capex_annual').textContent = (crackingCAPEXannual / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('cracking_opex_annual').textContent = (crackingOPEX / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('cracking_efficiency_display').textContent = crackingEfficiency.toFixed(1) + ' %';
        }

        // Calculate Price Prediction (Page 9)
        let predictionChart = null;
        let gurobiPredictionChart = null;

        function calculatePrediction() {
            // Get current cost from main calculation
            const currentCostElement = document.getElementById('result_cost_per_kg');
            let currentCost = 0;
            
            if (currentCostElement && currentCostElement.textContent !== '-') {
                const costText = currentCostElement.textContent.replace(' ‚Ç¨/kg', '').trim();
                currentCost = parseFloat(costText) || 0;
            } else {
                // Try to get from input field
                currentCost = getInput('current_cost_per_kg');
            }

            // Check if current cost is valid
            if (currentCost === 0 || isNaN(currentCost)) {
                alert('Please calculate the total costs first (click "CALCULATE TOTAL COSTS" button) or enter a current cost value.');
                return;
            }

            // Update current cost input
            document.getElementById('current_cost_per_kg').value = currentCost.toFixed(4);

            // Get input values (use custom values directly, no scenario selection)
            let capexReduction = getInput('capex_reduction_rate');
            let opexReduction = getInput('opex_reduction_rate');
            let learningRate = getInput('learning_rate');
            const inflationRate = getInput('inflation_rate');
            const demandGrowth = getInput('demand_growth');
            const scaleEfficiency = getInput('scale_efficiency');

            // Calculate 10-year prediction
            const years = [];
            const costs = [];
            const reductions = [];
            
            let yearCost = currentCost;
            const baseCost = currentCost;

            for (let year = 0; year <= 10; year++) {
                years.push(year);
                
                if (year === 0) {
                    costs.push(yearCost);
                    reductions.push(0);
                } else {
                    // Calculate cost reduction factors
                    const capexFactor = Math.pow(1 - capexReduction / 100, year);
                    const opexFactor = Math.pow(1 - opexReduction / 100, year);
                    const learningFactor = Math.pow(1 - learningRate / 100, year);
                    const scaleFactor = Math.pow(1 - scaleEfficiency / 100, year);
                    const inflationFactor = Math.pow(1 + inflationRate / 100, year);
                    const demandFactor = Math.pow(1 - demandGrowth / 100, year); // Higher demand = lower cost per unit

                    // Apply reductions (assuming 60% CAPEX, 30% OPEX, 10% other factors)
                    const costReduction = 0.6 * (1 - capexFactor) + 0.3 * (1 - opexFactor) + 0.1 * (1 - learningFactor * scaleFactor);
                    const netReduction = costReduction * (1 / demandFactor);
                    
                    yearCost = baseCost * (1 - netReduction) * inflationFactor;
                    costs.push(yearCost);
                    reductions.push(((baseCost - yearCost) / baseCost * 100));
                }
            }

            // Display results
            document.getElementById('prediction_current_cost').textContent = currentCost.toFixed(4) + ' ‚Ç¨/kg';
            document.getElementById('prediction_year10_cost').textContent = costs[10].toFixed(4) + ' ‚Ç¨/kg';
            
            const totalReduction = ((currentCost - costs[10]) / currentCost * 100);
            document.getElementById('prediction_total_reduction').textContent = totalReduction.toFixed(2) + ' %';
            document.getElementById('prediction_avg_reduction').textContent = (totalReduction / 10).toFixed(2) + ' %/year';

            // Update table
            let tableHTML = '';
            for (let i = 0; i <= 10; i++) {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e8e8e8;">
                        <td style="padding: 10px; color: #4A90E2;">Year ${i}</td>
                        <td style="padding: 10px; text-align: right; color: #4A90E2; font-weight: 600; font-family: 'Courier New', monospace;">${costs[i].toFixed(4)}</td>
                        <td style="padding: 10px; text-align: right; color: #4A90E2;">${reductions[i].toFixed(2)}%</td>
                    </tr>
                `;
            }
            document.getElementById('prediction_table_body').innerHTML = tableHTML;

            // Update chart
            if (predictionChart) {
                predictionChart.destroy();
            }

            const ctx = document.getElementById('predictionChart').getContext('2d');
            predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => `Year ${y}`),
                    datasets: [{
                        label: 'Cost per kg H‚ÇÇ (‚Ç¨/kg)',
                        data: costs,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: '10-Year Hydrogen Cost Prediction',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Cost (‚Ç¨/kg H‚ÇÇ)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });
        }

        function calculateGurobiPrediction() {
            // Pr√ºfe, ob Gurobi-Optimierung bereits durchgef√ºhrt wurde
            if (!window.gurobiOptBest || !window.gurobiOptBest.costPerKg) {
                alert('Bitte zuerst die OPTIMIERUNG (GUROBI-SERVER) ausf√ºhren.');
                return;
            }

            const currentCost = window.gurobiOptBest.costPerKg;

            // Zeige Gurobi-Ergebnisse an
            const gurobiResultsDiv = document.getElementById('page9_gurobi_results');
            gurobiResultsDiv.style.display = 'block';

            // Get input values (use custom values directly, no scenario selection)
            let capexReduction = getInput('capex_reduction_rate');
            let opexReduction = getInput('opex_reduction_rate');
            let learningRate = getInput('learning_rate');
            const inflationRate = getInput('inflation_rate');
            const demandGrowth = getInput('demand_growth');
            const scaleEfficiency = getInput('scale_efficiency');

            // Calculate 10-year prediction
            const years = [];
            const costs = [];
            const reductions = [];
            
            let yearCost = currentCost;
            const baseCost = currentCost;

            for (let year = 0; year <= 10; year++) {
                years.push(year);
                
                if (year === 0) {
                    costs.push(yearCost);
                    reductions.push(0);
                } else {
                    // Calculate cost reduction factors
                    const capexFactor = Math.pow(1 - capexReduction / 100, year);
                    const opexFactor = Math.pow(1 - opexReduction / 100, year);
                    const learningFactor = Math.pow(1 - learningRate / 100, year);
                    const scaleFactor = Math.pow(1 - scaleEfficiency / 100, year);
                    const inflationFactor = Math.pow(1 + inflationRate / 100, year);
                    const demandFactor = Math.pow(1 - demandGrowth / 100, year); // Higher demand = lower cost per unit

                    // Apply reductions (assuming 60% CAPEX, 30% OPEX, 10% other factors)
                    const costReduction = 0.6 * (1 - capexFactor) + 0.3 * (1 - opexFactor) + 0.1 * (1 - learningFactor * scaleFactor);
                    const netReduction = costReduction * (1 / demandFactor);
                    
                    yearCost = baseCost * (1 - netReduction) * inflationFactor;
                    costs.push(yearCost);
                    reductions.push(((baseCost - yearCost) / baseCost * 100));
                }
            }

            // Display results
            document.getElementById('gurobi_prediction_current_cost').textContent = currentCost.toFixed(4) + ' ‚Ç¨/kg';
            document.getElementById('gurobi_prediction_year10_cost').textContent = costs[10].toFixed(4) + ' ‚Ç¨/kg';
            
            const totalReduction = ((currentCost - costs[10]) / currentCost * 100);
            document.getElementById('gurobi_prediction_total_reduction').textContent = totalReduction.toFixed(2) + ' %';
            document.getElementById('gurobi_prediction_avg_reduction').textContent = (totalReduction / 10).toFixed(2) + ' %/year';

            // Update table
            let tableHTML = '';
            for (let i = 0; i <= 10; i++) {
                tableHTML += `
                    <tr style="border-bottom: 1px solid #e8e8e8;">
                        <td style="padding: 10px; color: #2E7D32;">Year ${i}</td>
                        <td style="padding: 10px; text-align: right; color: #2E7D32; font-weight: 600; font-family: 'Courier New', monospace;">${costs[i].toFixed(4)}</td>
                        <td style="padding: 10px; text-align: right; color: #2E7D32;">${reductions[i].toFixed(2)}%</td>
                    </tr>
                `;
            }
            document.getElementById('gurobi_prediction_table_body').innerHTML = tableHTML;

            // Update chart
            if (gurobiPredictionChart) {
                gurobiPredictionChart.destroy();
            }

            const ctx = document.getElementById('gurobiPredictionChart').getContext('2d');
            gurobiPredictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => `Year ${y}`),
                    datasets: [{
                        label: 'Cost per kg H‚ÇÇ (‚Ç¨/kg) - Gurobi-Optimiert',
                        data: costs,
                        borderColor: '#2E7D32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#2E7D32',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: '10-Year Hydrogen Cost Prediction (Gurobi-Optimiert)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#2E7D32'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Cost (‚Ç¨/kg H‚ÇÇ)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });
        }

        /**
         * Bewertet eine Konfiguration { s, pel, h2Days, nh3Ships, waterTank } mit derselben
         * Kostenlogik wie die interne Raster-Optimierung (JS). Gibt { costPerKg, h2Storage, nh3Storage }
         * zur√ºck oder null bei ung√ºltiger Konfiguration.
         */
        function evaluateOptimizationComboJS(combo) {
            const annualH2ProdKt = getInput('h2_production') || 120.799;
            if (!annualH2ProdKt || annualH2ProdKt <= 0) return null;
            const annualH2ProdT = annualH2ProdKt * 1000;
            const h2StorageCapacity = (annualH2ProdT / 365.0) * combo.h2Days;

            const optVesselTankVolume = getInput('vessel_tank_volume');
            const optNh3Density = getInput('nh3_density');
            const optFillFactor = getInput('fill_factor');
            const optOneWayTime = getInput('transport_time');
            const optPortTime = getInput('port_time');
            const optNh3ShippingLoss = Math.min(Math.max(getInput('nh3_shipping_loss') / 100, 0), 0.95);
            if (optVesselTankVolume > 0 && optNh3Density > 0 && optFillFactor > 0 && optOneWayTime > 0 && optPortTime >= 0) {
                const payloadPerShipT = optVesselTankVolume * optNh3Density * optFillFactor;
                const cycleTimeDays = 2 * optOneWayTime + optPortTime;
                const tripsPerShipPerYear = 365 / cycleTimeDays;
                const annualPerShipT = payloadPerShipT * tripsPerShipPerYear;
                const annualNh3ProdT = annualH2ProdT * (17/3);
                const nh3RequiredTransportT = annualNh3ProdT / (1 - optNh3ShippingLoss);
                if (annualPerShipT > 0) {
                    const minShipsPhysical = nh3RequiredTransportT / annualPerShipT;
                    if (combo.nh3Ships + 1e-6 < minShipsPhysical) return null;
                }
            }

            const params = getCommonParams();
            const discountRate = (params.discountRate || 7) / 100;
            const lifetime = params.lifetime || 20;
            const usdToEur = 0.92;
            if (!isFinite(discountRate) || discountRate <= 0 || discountRate >= 1 || !isFinite(lifetime) || lifetime <= 0) return null;

            const windCapacityMW = getInput('wind_capacity');
            const windCapacityKW = windCapacityMW * 1000;
            const windCAPEXperMW = 2000000;
            const windOPEXperKWperYear = 60;
            const windCAPEX = windCAPEXperMW * windCapacityMW;
            const windOPEX = windOPEXperKWperYear * windCapacityKW * lifetime;
            const windCAPEXannual = annualizeCAPEX(windCAPEX, discountRate, lifetime);
            const windOPEXannual = windOPEX / lifetime;
            const windCostAnnual = windCAPEXannual + windOPEXannual;

            const electrolyzerTech = getInput('electrolyzer_technology') || 'AEL';
            const elParams = electrolyzerTech === 'AEL' ? { capex: 464, opex: 40.6, spec_kwh: 48.0 } : { capex: 580, opex: 24.36, spec_kwh: 48.0 };
            const electrolysisPowerMW = combo.pel;
            const electrolysisPowerKW = electrolysisPowerMW * 1000;
            const electrolysisCAPEX = elParams.capex * electrolysisPowerKW * usdToEur;
            const electrolysisCAPEXannual = annualizeCAPEX(electrolysisCAPEX, discountRate, lifetime);
            const electrolysisOPEX = elParams.opex * electrolysisPowerKW * lifetime * usdToEur;
            const electrolysisOPEXannual = electrolysisOPEX / lifetime;
            const electrolysisCostAnnual = electrolysisCAPEXannual + electrolysisOPEXannual;

            const h2StorageCAPEXperT = 33000 * usdToEur;
            const h2StorageCAPEX = h2StorageCapacity * h2StorageCAPEXperT;
            const h2StorageCAPEXannual = annualizeCAPEX(h2StorageCAPEX, discountRate, lifetime);
            const h2StorageOPEX = h2StorageCAPEX * 0.03 * lifetime;
            const h2StorageOPEXannual = h2StorageOPEX / lifetime;

            const nh3TargetPerShipT = (annualH2ProdT * 17/3) / 12;
            const nh3StorageCapacity = combo.nh3Ships * nh3TargetPerShipT;
            const nh3StorageCAPEXperT = 810 * usdToEur;
            const nh3StorageCAPEX = nh3StorageCapacity * nh3StorageCAPEXperT;
            const nh3StorageCAPEXannual = annualizeCAPEX(nh3StorageCAPEX, discountRate, lifetime);
            const nh3StorageOPEX = nh3StorageCAPEX * 0.02 * lifetime;
            const nh3StorageOPEXannual = nh3StorageOPEX / lifetime;

            const waterTankCAPEXperM3 = 50 * usdToEur;
            const waterTankCAPEX = combo.waterTank * waterTankCAPEXperM3;
            const waterTankCAPEXannual = annualizeCAPEX(waterTankCAPEX, discountRate, lifetime);
            const waterTankOPEX = waterTankCAPEX * 0.02 * lifetime;
            const waterTankOPEXannual = waterTankOPEX / lifetime;

            const storageCostAnnual = h2StorageCAPEXannual + h2StorageOPEXannual + nh3StorageCAPEXannual + nh3StorageOPEXannual + waterTankCAPEXannual + waterTankOPEXannual;

            const roWaterKgPerKgH2 = 10.0;
            const roCAPEXperM3perDay = 1200 * usdToEur;
            const roOPEXfrac = 0.05;
            const roOPEXperM3 = 0;
            const h2KgPerHDesign = (electrolysisPowerMW * 1000) / elParams.spec_kwh;
            const roM3PerHDesign = (h2KgPerHDesign * roWaterKgPerKgH2) / 1000.0;
            const roM3PerDayDesign = roM3PerHDesign * 24.0;
            const roCAPEX = roCAPEXperM3perDay * roM3PerDayDesign;
            const roCAPEXannual = annualizeCAPEX(roCAPEX, discountRate, lifetime);
            const roOPEX = roCAPEX * roOPEXfrac * lifetime;
            const annualWaterM3 = (annualH2ProdT * 1000 * roWaterKgPerKgH2) / 1000;
            const roOPEXvar = roOPEXperM3 * annualWaterM3 * lifetime;
            const roOPEXannual = (roOPEX + roOPEXvar) / lifetime;
            const roCostAnnual = roCAPEXannual + roOPEXannual;

            const hbCapacityTNH3perDay = (annualH2ProdT * 17/3) / 365;
            const hbCapacityTNH3perYear = hbCapacityTNH3perDay * 365;
            const hbCAPEXperTNH3perYear = 491.4 * usdToEur;
            const hbCAPEX = hbCAPEXperTNH3perYear * hbCapacityTNH3perYear;
            const hbCAPEXannual = annualizeCAPEX(hbCAPEX, discountRate, lifetime);
            const annualNH3ProdT = annualH2ProdT * 17/3;
            const hbOPEXperTNH3 = 16.8 * 1000000 / annualNH3ProdT;
            const hbOPEX = hbOPEXperTNH3 * annualNH3ProdT * lifetime;
            const hbOPEXannual = hbOPEX / lifetime;
            const hbCostAnnual = hbCAPEXannual + hbOPEXannual;

            const n2KgPerKgNH3 = 28.0 / 34.0;
            const hbCapacityTNH3perH = hbCapacityTNH3perDay / 24.0;
            const n2CapacityKgPerH = hbCapacityTNH3perH * 1000.0 * n2KgPerKgNH3;
            const n2CAPEXperKgN2perH = 1700 * usdToEur;
            const n2CAPEX = n2CAPEXperKgN2perH * n2CapacityKgPerH;
            const n2CAPEXannual = annualizeCAPEX(n2CAPEX, discountRate, lifetime);
            const n2OPEXfrac = 0.03;
            const n2OPEX = n2CAPEX * n2OPEXfrac * lifetime;
            const n2OPEXannual = n2OPEX / lifetime;
            const n2CostAnnual = n2CAPEXannual + n2OPEXannual;

            let transportCostAnnual = 0;
            const transportEl = document.getElementById('transport_cost_annual');
            if (transportEl && transportEl.textContent) {
                const raw = String(transportEl.textContent).replace(' M‚Ç¨/year', '').replace(' M‚Ç¨/a', '').trim();
                const v = parseFloat(raw);
                if (isFinite(v)) transportCostAnnual = v * 1000000;
            }
            let crackingCostAnnual = 0;
            const crackingEl = document.getElementById('cracking_cost_annual');
            if (crackingEl && crackingEl.textContent) {
                const raw = String(crackingEl.textContent).replace(' M‚Ç¨/year', '').replace(' M‚Ç¨/a', '').trim();
                const v = parseFloat(raw);
                if (isFinite(v)) crackingCostAnnual = v * 1000000;
            }

            const totalAnnualCost = windCostAnnual + electrolysisCostAnnual + roCostAnnual + n2CostAnnual + hbCostAnnual + storageCostAnnual + transportCostAnnual + crackingCostAnnual;
            const h2ReferenceKg = annualH2ProdT * 1000;
            let haberBoschLoss = parseFloat(getInput('haber_bosch_loss'));
            if (isNaN(haberBoschLoss)) haberBoschLoss = 0;
            let storageLossRate = parseFloat(getInput('storage_loss_rate'));
            if (isNaN(storageLossRate)) storageLossRate = 0;
            let nh3ShippingLoss = parseFloat(getInput('nh3_shipping_loss'));
            if (isNaN(nh3ShippingLoss)) nh3ShippingLoss = 0;
            let crackingEff = parseFloat(getInput('cracking_efficiency'));
            if (isNaN(crackingEff) || crackingEff <= 0) crackingEff = 100;
            const chainEfficiency = (1 - haberBoschLoss / 100) * (1 - storageLossRate / 100) * (1 - nh3ShippingLoss / 100) * (crackingEff / 100);
            if (!isFinite(chainEfficiency) || chainEfficiency <= 0 || chainEfficiency > 1) return null;
            const h2DeliveredAnnual = h2ReferenceKg * chainEfficiency;
            if (!isFinite(h2DeliveredAnnual) || h2DeliveredAnnual <= 0) return null;
            if (!isFinite(totalAnnualCost) || totalAnnualCost <= 0) return null;
            const costPerKg = totalAnnualCost / h2DeliveredAnnual;
            if (!isFinite(costPerKg) || costPerKg <= 0 || costPerKg >= 1000) return null;
            return { costPerKg: costPerKg, h2Storage: h2StorageCapacity, nh3Storage: nh3StorageCapacity };
        }

        // ==============================
        // Gurobi-Optimierung √ºber Backend
        // ==============================
        async function runGurobiOptimization() {
            const resultsDiv = document.getElementById('optimization_results');
            resultsDiv.style.display = 'block';

            document.getElementById('opt_result_s').textContent = 'Berechne (Gurobi)...';
            document.getElementById('opt_result_pel').textContent = 'Berechne (Gurobi)...';
            document.getElementById('opt_result_h2_storage').textContent = 'Berechne (Gurobi)...';
            document.getElementById('opt_result_nh3_storage').textContent = 'Berechne (Gurobi)...';
            document.getElementById('opt_result_water_tank').textContent = 'Berechne (Gurobi)...';
            document.getElementById('opt_result_cost').textContent = 'Berechne (Gurobi)...';

            const progressDiv = document.getElementById('optimization_progress');
            const progressBar = document.getElementById('optimization_progress_bar');
            const progressText = document.getElementById('optimization_progress_text');
            const statusText = document.getElementById('optimization_status');
            progressDiv.style.display = 'block';
            progressBar.style.width = '15%';
            progressText.textContent = 'Gurobi-Request...';
            statusText.textContent = 'Sende Daten an Gurobi-Server...';

            // Grenzen aus dem Formular lesen
            const bounds = {
                s_min: getInput('opt_s_min') || 0.95,
                s_max: getInput('opt_s_max') || 1.0,
                s_step: getInput('opt_s_step') || 0.01,
                pel_min: getInput('opt_pel_min') || 500,
                pel_max: getInput('opt_pel_max') || 2500,
                pel_step: getInput('opt_pel_step') || 100,
                h2_min: getInput('opt_h2_days_min') || 1,
                h2_max: getInput('opt_h2_days_max') || 2,
                h2_step: getInput('opt_h2_days_step') || 1,
                nh3_min: getInput('opt_nh3_ships_min') || 3,
                nh3_max: getInput('opt_nh3_ships_max') || 8,
                nh3_step: getInput('opt_nh3_ships_step') || 1,
                water_min: getInput('opt_water_tank_min') || 500,
                water_max: getInput('opt_water_tank_max') || 4500,
                water_step: getInput('opt_water_tank_step') || 2000,
            };

            // Parameter f√ºr Gurobi (st√ºndliche Sim, Kosten, H2-Bedarf Stahlwerk)
            const h2Kt = getInput('h2_production') || 120.799;
            const common = typeof getCommonParams === 'function' ? getCommonParams() : {};
            const params = {
                h2_production_kt: h2Kt,
                annual_h2_t: h2Kt * 1000,
                project_lifetime_years: common.lifetime || getInput('project_lifetime') || 20,
                usd_to_eur: 0.92,
                h2_steel_demand_t: getInput('h2_import_target') || 110000,
                use_multiyear: true,
                base_cost_per_kg: getInput('current_cost_per_kg') || 3.0,
            };

            try {
                const response = await fetch('http://127.0.0.1:8000/optimize_gurobi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bounds, params }),
                });

                progressBar.style.width = '60%';
                progressText.textContent = 'Verarbeite Ergebnis...';

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error('HTTP ' + response.status + ': ' + text);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Gurobi-Optimierung fehlgeschlagen.');
                }

                const best = result.best || {};

                // Ergebnis anzeigen
                const h2Days = best.h2_days ?? bounds.h2_min;
                const nh3Ships = best.nh3_ships ?? bounds.nh3_min;
                const waterTank = best.water_tank ?? bounds.water_min;

                // Bewertung mit derselben JS-Kostenlogik wie ‚ÄûOptimiert (internes Raster)‚Äú,
                // damit beide Optimierungen vergleichbar und g√ºnstiger als ‚ÄûAktuell‚Äú sind.
                const combo = {
                    s: best.s ?? bounds.s_min,
                    pel: best.pel ?? bounds.pel_min,
                    h2Days: h2Days,
                    nh3Ships: nh3Ships,
                    waterTank: waterTank
                };
                const jsEval = evaluateOptimizationComboJS(combo);
                const costPerKg = (jsEval && jsEval.costPerKg > 0) ? jsEval.costPerKg : (best.costPerKg ?? params.base_cost_per_kg);
                const h2StorageDisplay = (jsEval && jsEval.h2Storage > 0) ? jsEval.h2Storage : (best.h2Storage ?? 0);
                const nh3StorageDisplay = (jsEval && jsEval.nh3Storage > 0) ? jsEval.nh3Storage : (best.nh3Storage ?? 0);

                document.getElementById('opt_result_s').textContent =
                    (best.s ?? bounds.s_min).toFixed(2) + ' (' + ((best.s ?? bounds.s_min) * 100).toFixed(0) + '% Windkapazit√§t)';
                document.getElementById('opt_result_pel').textContent =
                    (best.pel ?? bounds.pel_min).toFixed(0) + ' MW';
                document.getElementById('opt_result_h2_storage').textContent =
                    h2Days.toFixed(1) + ' Tage (' + h2StorageDisplay.toFixed(0) + ' t)';
                document.getElementById('opt_result_nh3_storage').textContent =
                    nh3Ships.toFixed(2) + ' Schiffe (' + nh3StorageDisplay.toFixed(0) + ' t)';
                document.getElementById('opt_result_water_tank').textContent =
                    waterTank.toFixed(0) + ' m¬≥';
                document.getElementById('opt_result_cost').textContent =
                    costPerKg.toFixed(4) + ' ‚Ç¨/kg';

                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                statusText.textContent = 'Gurobi-Optimierung abgeschlossen!';

                // Gurobi-Ergebnis f√ºr Vergleich speichern (Kosten aus JS-Bewertung)
                window.gurobiOptBest = {
                    costPerKg: costPerKg,
                    pel: best.pel ?? bounds.pel_min,
                    h2Storage: h2StorageDisplay,
                    nh3Ships: nh3Ships,
                    nh3Storage: nh3StorageDisplay
                };
                window.gurobiOptDecision = {
                    s: best.s ?? bounds.s_min,
                    pel: best.pel ?? bounds.pel_min,
                    h2_days: h2Days,
                    nh3_ships: nh3Ships,
                    water_tank: waterTank
                };

                document.getElementById('comparison_gurobi_cost').textContent = costPerKg.toFixed(4) + ' ‚Ç¨/kg';
                document.getElementById('comparison_gurobi_pel').textContent = (best.pel ?? bounds.pel_min).toFixed(0);
                document.getElementById('comparison_gurobi_h2').textContent = h2StorageDisplay.toFixed(0) + ' t';
                document.getElementById('comparison_gurobi_nh3').textContent = nh3StorageDisplay.toFixed(0) + ' t';

                // Design-Empfehlungen nach neuer Gurobi-Optimierung aktualisieren
                try {
                    generateDesignRecommendations();
                } catch (e) {
                    console.warn('Design-Empfehlungen konnten nicht aktualisiert werden:', e);
                }

                // Aktualisiere die Kosten-Diagramme mit Gurobi-Vergleich
                // Hole die aktuellen Kosten-Parameter f√ºr die Breakdown-Berechnung
                const currentCostElement = document.getElementById('result_cost_per_kg');
                if (currentCostElement && currentCostElement.textContent !== '-') {
                    const costText = currentCostElement.textContent.replace(' ‚Ç¨/kg', '').trim();
                    const currentCostPerKg = parseFloat(costText);
                    if (currentCostPerKg > 0 && isFinite(currentCostPerKg)) {
                        // Berechne die Parameter f√ºr die Breakdown-Berechnung
                        const discountRate = getInput('discount_rate') / 100;
                        const lifetime = getInput('project_lifetime');
                        const electricityCostMethod = document.getElementById('electricity_cost_method').value;
                        let electricityPrice = 0;
                        if (electricityCostMethod === 'internal_LCOE') {
                            const windCapacity = getInput('wind_capacity') * 1000;
                            const windCapacityFactor = getInput('wind_capacity_factor') / 100;
                            const windCAPEX = getInput('wind_capex') * 1000000000;
                            const windOPEX = getInput('wind_opex') * 1000000;
                            const windDepex = getInput('wind_depex') * 1000000;
                            const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor;
                            const windCAPEXannual = annualizeCAPEX(windCAPEX, discountRate, lifetime);
                            const windDepexAnnual = annualizeDepex(windDepex, discountRate, lifetime);
                            const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
                            electricityPrice = windCostAnnual / (windElectricityAnnual * 1000);
                        } else {
                            electricityPrice = getInput('external_electricity_price') / 1000;
                        }
                        const h2DeliveredElement = document.getElementById('result_h2_delivered');
                        let h2DeliveredAnnual = 0;
                        if (h2DeliveredElement && h2DeliveredElement.textContent !== '-') {
                            const h2Text = h2DeliveredElement.textContent.replace(' t/year', '').trim();
                            h2DeliveredAnnual = parseFloat(h2Text) * 1000000; // t to kg
                        }
                        const costPerKgFactor = h2DeliveredAnnual > 0 ? 1 / h2DeliveredAnnual : 0;

                        // Aktualisiere die Diagramme
                        updateCostChartsWithGurobi(window.gurobiOptBest, window.gurobiOptDecision, 
                            discountRate, lifetime, electricityPrice, h2DeliveredAnnual, costPerKgFactor);
                    }
                }
            } catch (error) {
                console.error('Gurobi-Optimierung Fehler:', error);
                statusText.textContent = 'Fehler bei Gurobi-Optimierung: ' + error.message;
            }
        }

        // Berechnet Kosten-Breakdown f√ºr Gurobi-optimierte Konfiguration
        function calculateGurobiBreakdown(gurobiOptBest, gurobiOptDecision, discountRate, lifetime, electricityPrice, h2DeliveredAnnual, costPerKgFactor) {
            if (!gurobiOptBest || !gurobiOptDecision) return null;

            const pel = gurobiOptBest.pel || getInput('wind_capacity') * 1000;
            const h2Storage = gurobiOptBest.h2Storage || getInput('h2_storage_capacity');
            const nh3Storage = gurobiOptBest.nh3Storage || getInput('nh3_storage_capacity');
            const s = gurobiOptDecision.s || 1.0;
            const waterTank = gurobiOptDecision.water_tank || getInput('water_storage_capacity_storage');

            // Vereinfachte Berechnung basierend auf Gurobi-Parametern
            // Wind (skaliert mit s)
            const windCapacityMW = getInput('wind_capacity') * 1000 * s;
            const windCAPEXperMW = 2000000;
            const windOPEXperKWperYear = 60;
            const windCAPEX = windCAPEXperMW * windCapacityMW;
            const windOPEX = windOPEXperKWperYear * windCapacityMW * 1000 * lifetime;
            const windCAPEXannual = annualizeCAPEX(windCAPEX, discountRate, lifetime);
            const windOPEXannual = windOPEX / lifetime;

            // Electrolysis
            const electrolyzerTech = getInput('electrolyzer_technology') || 'AEL';
            const elParams = electrolyzerTech === 'AEL' ? 
                { capex: 464, opex: 40.6, spec_kwh: 48.0 } : 
                { capex: 580, opex: 24.36, spec_kwh: 48.0 };
            const usdToEur = 0.92;
            const electrolysisCAPEX = elParams.capex * pel * 1000 * usdToEur;
            const electrolysisCAPEXannual = annualizeCAPEX(electrolysisCAPEX, discountRate, lifetime);
            const electrolysisOPEX = elParams.opex * pel * 1000 * lifetime * usdToEur;
            const electrolysisOPEXannual = electrolysisOPEX / lifetime;
            const h2Production = getInput('h2_production') * 1000000;
            const electrolysisElectricityDemand = h2Production * elParams.spec_kwh;
            const electrolysisVariableCost = electricityPrice * electrolysisElectricityDemand;

            // Desalination
            const roWaterKgPerKgH2 = 10.0;
            const roCAPEXperM3perDay = 1200 * usdToEur;
            const h2KgPerHDesign = (pel * 1000) / elParams.spec_kwh;
            const roM3PerDayDesign = (h2KgPerHDesign * roWaterKgPerKgH2 / 1000.0) * 24.0;
            const roCAPEX = roCAPEXperM3perDay * roM3PerDayDesign;
            const roCAPEXannual = annualizeCAPEX(roCAPEX, discountRate, lifetime);
            const roOPEXfrac = 0.05;
            const roOPEX = roCAPEX * roOPEXfrac * lifetime;
            const annualWaterM3 = (h2Production * roWaterKgPerKgH2) / 1000;
            const roOPEXannual = roOPEX / lifetime;
            const desalinationCAPEXannual = roCAPEXannual;
            const desalinationOPEX = roOPEXannual;
            const desalinationElectricityDemand = annualWaterM3 * 4.0; // kWh/m¬≥
            const desalinationVariableCost = electricityPrice * desalinationElectricityDemand;

            // ASU
            const n2KgPerKgNH3 = 28.0 / 34.0;
            const annualNH3ProdT = (h2Production / 1000) * (17/3);
            const hbCapacityTNH3perDay = annualNH3ProdT / 365;
            const n2CapacityKgPerH = (hbCapacityTNH3perDay / 24.0) * 1000.0 * n2KgPerKgNH3;
            const n2CAPEXperKgN2perH = 1700 * usdToEur;
            const n2CAPEX = n2CAPEXperKgN2perH * n2CapacityKgPerH;
            const n2CAPEXannual = annualizeCAPEX(n2CAPEX, discountRate, lifetime);
            const n2OPEXfrac = 0.03;
            const n2OPEX = n2CAPEX * n2OPEXfrac * lifetime;
            const n2OPEXannual = n2OPEX / lifetime;
            const asuElectricity = n2CapacityKgPerH * 0.33 * 8760 / 1000000; // GWh
            const asuVariableCost = electricityPrice * asuElectricity * 1000000;

            // Haber-Bosch
            const hbCAPEXperTNH3perYear = 491.4 * usdToEur;
            const hbCAPEX = hbCAPEXperTNH3perYear * annualNH3ProdT;
            const hbCAPEXannual = annualizeCAPEX(hbCAPEX, discountRate, lifetime);
            const hbOPEXperTNH3 = 24.57 * usdToEur;
            const hbOPEX = hbOPEXperTNH3 * annualNH3ProdT * lifetime;
            const hbOPEXannual = hbOPEX / lifetime;
            const haberBoschElectricity = annualNH3ProdT * 0.55 / 1000; // GWh
            const haberBoschVariableCost = electricityPrice * haberBoschElectricity * 1000000;

            // Storage
            const h2StorageCAPEXperT = 33000 * usdToEur;
            const h2StorageCAPEX = h2Storage * h2StorageCAPEXperT;
            const h2StorageCAPEXannual = annualizeCAPEX(h2StorageCAPEX, discountRate, lifetime);
            const h2StorageOPEX = h2StorageCAPEX * 0.03 * lifetime;
            const h2StorageOPEXannual = h2StorageOPEX / lifetime;
            const nh3StorageCAPEXperT = 810 * usdToEur;
            const nh3StorageCAPEX = nh3Storage * nh3StorageCAPEXperT;
            const nh3StorageCAPEXannual = annualizeCAPEX(nh3StorageCAPEX, discountRate, lifetime);
            const nh3StorageOPEX = nh3StorageCAPEX * 0.02 * lifetime;
            const nh3StorageOPEXannual = nh3StorageOPEX / lifetime;
            const waterTankCAPEXperM3 = 50 * usdToEur;
            const waterTankCAPEX = waterTank * waterTankCAPEXperM3;
            const waterTankCAPEXannual = annualizeCAPEX(waterTankCAPEX, discountRate, lifetime);
            const waterTankOPEX = waterTankCAPEX * 0.02 * lifetime;
            const waterTankOPEXannual = waterTankOPEX / lifetime;
            const storageCAPEXannual = h2StorageCAPEXannual + nh3StorageCAPEXannual + waterTankCAPEXannual;
            const storageOPEX = h2StorageOPEXannual + nh3StorageOPEXannual + waterTankOPEXannual;

            // Transport (vereinfacht - verwende aktuelle Werte)
            const transportCostElement = document.getElementById('transport_cost_annual');
            let transportCostAnnual = 0;
            if (transportCostElement && transportCostElement.textContent) {
                const transportCostText = transportCostElement.textContent.replace(' M‚Ç¨/year', '').replace(' M‚Ç¨/a', '').trim();
                transportCostAnnual = parseFloat(transportCostText) * 1000000;
                if (isNaN(transportCostAnnual)) transportCostAnnual = 0;
            }
            // Grobe Aufteilung Transport: 50% CAPEX, 30% OPEX, 20% Variable
            const transportCAPEXannual = transportCostAnnual * 0.5;
            const transportOPEXannual = transportCostAnnual * 0.3;
            const transportVariableCost = transportCostAnnual * 0.2;

            // Cracking
            const crackingCostElement = document.getElementById('cracking_cost_annual');
            let crackingCostAnnual = 0;
            if (crackingCostElement && crackingCostElement.textContent) {
                const crackingCostText = crackingCostElement.textContent.replace(' M‚Ç¨/year', '').replace(' M‚Ç¨/a', '').trim();
                crackingCostAnnual = parseFloat(crackingCostText) * 1000000;
                if (isNaN(crackingCostAnnual)) crackingCostAnnual = 0;
            }
            // Grobe Aufteilung Cracking: 60% CAPEX, 40% OPEX
            const crackingCAPEXannual = crackingCostAnnual * 0.6;
            const crackingOPEXannual = crackingCostAnnual * 0.4;

            return [
                { 
                    name: 'Wind Farm', 
                    capex: (windCAPEXannual) * costPerKgFactor,
                    opex: windOPEXannual * costPerKgFactor,
                    variable: 0
                },
                { 
                    name: 'Electrolysis', 
                    capex: electrolysisCAPEXannual * costPerKgFactor,
                    opex: electrolysisOPEXannual * costPerKgFactor,
                    variable: electrolysisVariableCost * costPerKgFactor
                },
                { 
                    name: 'Desalination', 
                    capex: desalinationCAPEXannual * costPerKgFactor,
                    opex: desalinationOPEX * costPerKgFactor,
                    variable: desalinationVariableCost * costPerKgFactor
                },
                { 
                    name: 'ASU (Nitrogen)', 
                    capex: n2CAPEXannual * costPerKgFactor,
                    opex: n2OPEXannual * costPerKgFactor,
                    variable: asuVariableCost * costPerKgFactor
                },
                { 
                    name: 'Haber-Bosch', 
                    capex: hbCAPEXannual * costPerKgFactor,
                    opex: hbOPEXannual * costPerKgFactor,
                    variable: haberBoschVariableCost * costPerKgFactor
                },
                { 
                    name: 'Storage', 
                    capex: storageCAPEXannual * costPerKgFactor,
                    opex: storageOPEX * costPerKgFactor,
                    variable: 0
                },
                { 
                    name: 'Transport', 
                    capex: transportCAPEXannual * costPerKgFactor,
                    opex: transportOPEXannual * costPerKgFactor,
                    variable: transportVariableCost * costPerKgFactor
                },
                { 
                    name: 'Cracking', 
                    capex: crackingCAPEXannual * costPerKgFactor,
                    opex: crackingOPEXannual * costPerKgFactor,
                    variable: 0
                }
            ];
        }

        // Main calculation function
        function calculateCosts() {
            try {
                // Get all inputs
                const discountRate = getInput('discount_rate');
                const lifetime = getInput('project_lifetime');
                
                // Get H‚ÇÇ reference quantity
                const h2Reference = getH2Reference(); // kg
                const h2Production = getInput('h2_production') * 1000000; // kt to kg

                // Electricity cost method
                const electricityCostMethod = document.getElementById('electricity_cost_method').value;
                const includeWindInTotal = document.getElementById('include_wind_cost_in_total').value === 'true';

                // Wind parameters
                const windCapacity = getInput('wind_capacity') * 1000; // GW to MW
                const windCapacityFactor = getInput('wind_capacity_factor') / 100;
                const windCAPEX = getInput('wind_capex') * 1000000000; // billion to ‚Ç¨
                const windOPEX = getInput('wind_opex') * 1000000; // million to ‚Ç¨
                const windDepex = getInput('wind_depex') * 1000000; // million to ‚Ç¨
                
                // Calculate electricity price
                let electricityPrice = 0;
                const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor; // MWh
                const windCAPEXannual = annualizeCAPEX(windCAPEX, discountRate, lifetime);
                const windDepexAnnual = annualizeDepex(windDepex, discountRate, lifetime);
                const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
                
                if (electricityCostMethod === 'internal_LCOE') {
                    if (windElectricityAnnual > 0 && isFinite(windElectricityAnnual)) {
                        electricityPrice = windCostAnnual / (windElectricityAnnual * 1000); // ‚Ç¨/kWh
                    } else {
                        alert('Ung√ºltige Wind-Stromproduktion berechnet. Bitte Wind-Parameter pr√ºfen.');
                        return;
                    }
                } else {
                    const externalPrice = getInput('external_electricity_price');
                    if (isFinite(externalPrice) && externalPrice > 0) {
                        electricityPrice = externalPrice / 1000; // MWh to kWh
                    } else {
                        alert('Ung√ºltiger externer Strompreis. Bitte external_electricity_price pr√ºfen.');
                        return;
                    }
                }
                
                // Validate electricity price
                if (!isFinite(electricityPrice) || electricityPrice <= 0) {
                    alert('Ung√ºltiger Strompreis berechnet: ' + electricityPrice + '. Bitte Strompreis-Parameter pr√ºfen.');
                    return;
                }

                // Electrolysis parameters
                const electrolyzerTechnology = document.getElementById('electrolyzer_technology')?.value || 'AEL';
                const electrolysisSpecificEnergy = getInput('electrolysis_specific_energy'); // kWh/kg
                const electrolysisAvailability = getInput('electrolysis_availability') / 100;
                // Effektive Stunden: Wenn Input vorhanden, verwende diesen, sonst berechne aus Verf√ºgbarkeit
                let hOpEffective = getInput('electrolysis_effective_hours');
                if (hOpEffective <= 0) {
                    hOpEffective = 8760 * electrolysisAvailability;
                }
                
                // Technology-specific CAPEX/OPEX (if not provided, use defaults from Code_Final.py)
                let electrolysisCAPEXperkW = getInput('electrolysis_capex_per_kw');
                let electrolysisOPEX = getInput('electrolysis_opex') * 1000000; // million to ‚Ç¨
                
                // If CAPEX/OPEX not provided, use technology defaults
                if (electrolysisCAPEXperkW === 0) {
                    if (electrolyzerTechnology === 'PEM') {
                        electrolysisCAPEXperkW = 580; // $/kW from Code_Final.py
                    } else {
                        electrolysisCAPEXperkW = 464; // $/kW for AEL from Code_Final.py
                    }
                }
                
                // Calculate OPEX from capacity if not provided (like in Code_Final.py)
                if (electrolysisOPEX === 0) {
                    let opexPerKwPerYear = 0;
                    if (electrolyzerTechnology === 'PEM') {
                        opexPerKwPerYear = 24.36; // $/kW/year from Code_Final.py
                    } else {
                        opexPerKwPerYear = 40.6; // $/kW/year for AEL from Code_Final.py
                    }
                    // Calculate power first (will be calculated later, but we need it here)
                    const electrolysisElectricityDemandTemp = h2Production * electrolysisSpecificEnergy; // kWh
                    const electrolysisPowerTemp = electrolysisElectricityDemandTemp / hOpEffective; // kW
                    electrolysisOPEX = opexPerKwPerYear * electrolysisPowerTemp; // ‚Ç¨/year (assuming 1:1 USD:EUR)
                }
                
                // Min load fraction based on technology
                const minLoadFraction = getInput('min_load_fraction');
                const elRampFracPerH = getInput('el_ramp_frac_per_h') || 0.80;

                // Water parameters
                const seawaterDemand = getInput('seawater_demand'); // L/kg
                const deionisedWaterDemand = getInput('deionised_water_demand'); // L/kg
                const desalinationSpecificEnergy = getInput('desalination_specific_energy'); // kWh/m¬≥
                const desalinationCAPEX = getInput('desalination_capex') * 1000000; // million to ‚Ç¨
                const desalinationOPEX = getInput('desalination_opex') * 1000000; // million to ‚Ç¨

                // ASU parameters
                const nitrogenDemand = getInput('nitrogen_demand'); // t/day
                let asuCAPEX = getInput('asu_capex') * 1000000; // million to ‚Ç¨
                let asuOPEX = getInput('asu_opex') * 1000000; // million to ‚Ç¨
                const asuElectricity = getInput('asu_electricity') * 1000000; // GWh to kWh
                const asuCapacity = getInput('asu_capacity'); // t N‚ÇÇ/day
                const asuCAPEXperUnit = getInput('asu_capex_per_unit');
                const asuOPEXshare = getInput('asu_opex_share');
                
                if (asuCAPEXperUnit > 0) {
                    asuCAPEX = asuCapacity * asuCAPEXperUnit;
                }
                if (asuOPEXshare > 0 && asuOPEX === 0) {
                    asuOPEX = asuCAPEX * asuOPEXshare;
                }

                // Haber-Bosch parameters
                const ammoniaProduction = getInput('ammonia_production'); // t/day
                const ammoniaAnnualDemand = getInput('ammonia_annual_demand') * 1000000; // kt to kg
                let haberBoschCAPEX = getInput('haber_bosch_capex') * 1000000; // million to ‚Ç¨
                let haberBoschOPEX = getInput('haber_bosch_opex') * 1000000; // million to ‚Ç¨
                const haberBoschElectricity = getInput('haber_bosch_electricity') * 1000000; // GWh to kWh
                const haberBoschCapacity = getInput('haber_bosch_capacity'); // t NH‚ÇÉ/day
                const haberBoschCAPEXperUnit = getInput('haber_bosch_capex_per_unit');
                const haberBoschOPEXshare = getInput('haber_bosch_opex_share');
                const haberBoschLoss = getInput('haber_bosch_loss') / 100;
                
                if (haberBoschCAPEXperUnit > 0) {
                    haberBoschCAPEX = haberBoschCapacity * haberBoschCAPEXperUnit;
                }
                if (haberBoschOPEXshare > 0 && haberBoschOPEX === 0) {
                    haberBoschOPEX = haberBoschCAPEX * haberBoschOPEXshare;
                }

                // Storage parameters
                let storageH2CAPEX = getInput('storage_h2_capex') * 1000000; // million to ‚Ç¨
                let storageNH3CAPEX = getInput('storage_nh3_capex') * 1000000; // million to ‚Ç¨
                let storageOPEX = getInput('storage_opex') * 1000000; // million to ‚Ç¨
                
                const nh3StorageCapacity = getInput('nh3_storage_capacity'); // t
                const h2StorageCapacity = getInput('h2_storage_capacity'); // t
                const capexPerTNH3 = getInput('capex_per_t_nh3_storage');
                const storageOPEXshare = getInput('storage_opex_share');
                
                if (capexPerTNH3 > 0 && storageNH3CAPEX === 0) {
                    storageNH3CAPEX = nh3StorageCapacity * capexPerTNH3;
                }
                if (storageOPEXshare > 0 && storageOPEX === 0) {
                    storageOPEX = (storageH2CAPEX + storageNH3CAPEX) * storageOPEXshare;
                }
                
                let waterStorageCAPEX = getInput('water_storage_capex_storage') * 1000000; // million to ‚Ç¨
                if (waterStorageCAPEX === 0) {
                    waterStorageCAPEX = getInput('water_storage_capex') * 1000000; // fallback
                }

                // Cracking parameters
                const crackingCAPEX = getInput('cracking_capex') * 1000000; // million to ‚Ç¨
                const crackingOPEX = getInput('cracking_opex') * 1000000; // million to ‚Ç¨

                // ========== CALCULATIONS ==========

                // Wind costs are ALWAYS calculated (from Code_Final.py logic)
                // The includeWindInTotal flag only determines if they are added separately to total costs
                // or only included via electricity price (which is already done above)
                const windCostAnnualTotal = includeWindInTotal ? (windCAPEXannual + windOPEX + windDepexAnnual) : 0;

                // Electrolysis calculation with theoretical minimum check
                // Theoretical minimum: 39.4 kWh/kg H‚ÇÇ (based on enthalpy: 285.83 kJ/mol H‚ÇÇO)
                // Practical PEM: 50-70 kWh/kg H‚ÇÇ (with system losses)
                const theoreticalEnergyPerKg = 39.4; // kWh/kg H‚ÇÇ (theoretical minimum)
                const electrolysisEfficiency = electrolysisSpecificEnergy > 0 ? 
                    (theoreticalEnergyPerKg / electrolysisSpecificEnergy) : 0.7; // default 70% if not calculated
                
                const electrolysisElectricityDemand = h2Production * electrolysisSpecificEnergy; // kWh
                const electrolysisPower = electrolysisElectricityDemand / hOpEffective; // kW
                const electrolysisCAPEX = electrolysisPower * electrolysisCAPEXperkW;
                const electrolysisCAPEXannual = annualizeCAPEX(electrolysisCAPEX, discountRate, lifetime);
                
                // Water consumption: stoichiometrically 9 L per kg H‚ÇÇ (2 H‚ÇÇO ‚Üí 2 H‚ÇÇ + O‚ÇÇ)
                const waterConsumptionLiters = h2Production * 9; // L/year
                
                const electrolysisCostAnnual = electrolysisCAPEXannual + electrolysisOPEX + (electricityPrice * electrolysisElectricityDemand);

                // Water demand calculation
                // Theoretical: 9 L water per kg H‚ÇÇ (stoichiometry: 2 H‚ÇÇO ‚Üí 2 H‚ÇÇ + O‚ÇÇ)
                // Input value should be close to 9-10 L/kg H‚ÇÇ
                const waterDemandAnnual = h2Production * (deionisedWaterDemand / 1000); // m¬≥ (L to m¬≥ conversion)
                const eRoGwh = getInput('desalination_electricity_gwh_year') || 0;
                const desalinationElectricityDemand = (eRoGwh > 0) ? (eRoGwh * 1e6) : (waterDemandAnnual * desalinationSpecificEnergy); // kWh (E_RO override)
                
                // RO detailed costs (NEW)
                const roCapexPerM3PerDay = getInput('ro_capex_per_m3_per_day') || 1500;
                const roOpexFractionPerYear = getInput('ro_opex_fraction_per_year') || 0.05;
                const roOpexPerM3 = getInput('ro_opex_per_m3') || 0.3825;
                
                // Calculate RO CAPEX from capacity if not provided
                const roCapacityM3PerDay = waterDemandAnnual / 365; // m¬≥/day
                let roCapexCalculated = desalinationCAPEX;
                if (roCapexPerM3PerDay > 0 && desalinationCAPEX === 0) {
                    roCapexCalculated = roCapacityM3PerDay * roCapexPerM3PerDay;
                }
                
                // RO OPEX from fraction and volume
                const roOpexFromFraction = roCapexCalculated * roOpexFractionPerYear;
                const roOpexFromVolume = waterDemandAnnual * roOpexPerM3;
                const roOpexTotal = roOpexFromFraction + roOpexFromVolume;
                
                // Water Tank CAPEX/OPEX (NEW)
                const waterTankCapacity = getInput('water_storage_capacity_storage') || getInput('water_storage_capacity') || 2500;
                const waterTankCapexPerM3 = getInput('water_tank_capex_per_m3') || 200;
                const waterTankOpexFractionPerYear = getInput('water_tank_opex_fraction_per_year') || 0.02;
                const waterTankLossFracPerHour = getInput('water_tank_loss_frac_per_hour') || 0.001;
                
                const waterTankCapexCalculated = waterTankCapacity * waterTankCapexPerM3;
                const waterTankOpexFromFraction = waterTankCapexCalculated * waterTankOpexFractionPerYear;
                
                // Water tank losses (replacement cost)
                const waterTankLossAnnual = waterTankCapacity * waterTankLossFracPerHour * 8760; // m¬≥/year
                const waterReplacementCost = waterTankLossAnnual * desalinationSpecificEnergy * electricityPrice; // ‚Ç¨/year
                
                // Update water storage CAPEX if calculated
                if (waterStorageCAPEX === 0) {
                    waterStorageCAPEX = waterTankCapexCalculated;
                }
                
                // Typical desalination energy: 3-5 kWh/m¬≥ for reverse osmosis
                const desalinationCAPEXannual = annualizeCAPEX(roCapexCalculated, discountRate, lifetime);
                const waterTankCAPEXannual = annualizeCAPEX(waterTankCapexCalculated, discountRate, lifetime);
                const desalinationCostAnnual = desalinationCAPEXannual + roOpexTotal + (electricityPrice * desalinationElectricityDemand) + 
                                            waterTankCAPEXannual + waterTankOpexFromFraction + waterReplacementCost;

                const asuCAPEXannual = annualizeCAPEX(asuCAPEX, discountRate, lifetime);
                const asuCostAnnual = asuCAPEXannual + asuOPEX + (electricityPrice * asuElectricity);

                // Haber-Bosch: 3 H‚ÇÇ + N‚ÇÇ ‚Üí 2 NH‚ÇÉ (400-500¬∞C, 150-300 bar)
                // Energy: 10-12 MWh per tonne NH‚ÇÉ
                // Conversion efficiency: typically 90-95%
                const haberBoschCAPEXannual = annualizeCAPEX(haberBoschCAPEX, discountRate, lifetime);
                const haberBoschCostAnnual = haberBoschCAPEXannual + haberBoschOPEX + (electricityPrice * haberBoschElectricity);

                // Storage: H‚ÇÇ (cryogenic: 0.5-2% boil-off/day), NH‚ÇÉ (refrigerated: ~0.1%/year)
                const storageTotalCAPEX = storageH2CAPEX + storageNH3CAPEX + waterStorageCAPEX;
                const storageCAPEXannual = annualizeCAPEX(storageTotalCAPEX, discountRate, lifetime);
                
                // H2 Storage Energy Costs (NEW)
                const h2StorageEtaIn = getInput('h2_storage_eta_in') || 0.995;
                const h2StorageEtaOut = getInput('h2_storage_eta_out') || 0.995;
                const h2SpecKwhPerKgIn = getInput('h2_spec_kwh_per_kg_in') || 11.0; // Liquefaction
                const h2SpecKwhPerKgOut = getInput('h2_spec_kwh_per_kg_out') || 0.06; // Regasification
                const h2BoilOffLossFracPerHour = getInput('h2_boil_off_loss_frac_per_hour') || 0.0000208;
                const h2ReliqKwhPerKgBog = getInput('h2_reliq_kwh_per_kg_bog') || 11.0;
                const h2ReliqFrac = getInput('h2_reliq_frac') || 1.0;
                
                // H2 storage energy: Liquefaction when storing
                const h2StoredAnnual = h2Production * h2StorageEtaIn; // kg (accounting for storage efficiency)
                const h2LiquefactionEnergy = h2StoredAnnual * h2SpecKwhPerKgIn; // kWh
                
                // H2 storage energy: Regasification when withdrawing (for HB process)
                // Estimate: ~50% of production goes to HB, rest stored
                const h2WithdrawnForHB = h2Production * 0.5; // kg (rough estimate)
                const h2RegasificationEnergy = h2WithdrawnForHB * h2SpecKwhPerKgOut; // kWh
                
                // H2 Boil-off and Re-liquefaction
                const h2BoilOffAnnual = h2StorageCapacity * 1000 * h2BoilOffLossFracPerHour * 8760; // kg/year
                const h2BogReliquefied = h2BoilOffAnnual * h2ReliqFrac; // kg
                const h2ReliquefactionEnergy = h2BogReliquefied * h2ReliqKwhPerKgBog; // kWh
                
                const h2StorageEnergyTotal = h2LiquefactionEnergy + h2RegasificationEnergy + h2ReliquefactionEnergy;
                const h2StorageEnergyCost = electricityPrice * h2StorageEnergyTotal;

                // Transport - logistics (MUST BE CALCULATED BEFORE NH3 STORAGE ENERGY COSTS)
                // Haber-Bosch stoichiometry: 3 H‚ÇÇ + N‚ÇÇ ‚Üí 2 NH‚ÇÉ
                // Mass ratio: 3√ó2 g H‚ÇÇ + 28 g N‚ÇÇ ‚Üí 2√ó17 g NH‚ÇÉ
                // Therefore: 6 g H‚ÇÇ ‚Üí 34 g NH‚ÇÉ, so 1 kg H‚ÇÇ ‚Üí (34/6) = 5.667 kg NH‚ÇÉ
                // Or: 1 t H‚ÇÇ ‚Üí 5.667 t NH‚ÇÉ (but typically ~5.67 t NH‚ÇÉ per t H‚ÇÇ)
                const nh3PerH2RatioTransport = 17 / 3; // t NH‚ÇÉ / t H‚ÇÇ (correct stoichiometric ratio: 34/6 = 17/3)
                const nh3ShippingLossTransport = getInput('nh3_shipping_loss') / 100;
                
                const h2ForNH3Transport = h2Reference / 1000; // kg to t
                // Account for Haber-Bosch conversion efficiency (typically 90-95%)
                const haberBoschConversionEfficiency = 1 - haberBoschLoss; // e.g., 0.95 if 5% loss
                
                // Validate to avoid division by zero
                if (haberBoschConversionEfficiency <= 0 || haberBoschConversionEfficiency > 1) {
                    alert('Haber-Bosch Conversion Efficiency muss zwischen 0 und 1 liegen. Bitte haber_bosch_loss pr√ºfen.');
                    return;
                }
                
                if (nh3ShippingLossTransport >= 1 || nh3ShippingLossTransport < 0) {
                    alert('NH‚ÇÉ Shipping Loss muss zwischen 0% und 100% liegen. Bitte nh3_shipping_loss pr√ºfen.');
                    return;
                }
                
                const nh3NeededTransport = h2ForNH3Transport * nh3PerH2RatioTransport / haberBoschConversionEfficiency;
                const nh3TransportRequiredMain = nh3NeededTransport / (1 - nh3ShippingLossTransport); // t/a
                
                // Validate result
                if (!isFinite(nh3TransportRequiredMain) || nh3TransportRequiredMain <= 0) {
                    alert('Ung√ºltige NH‚ÇÉ Transport-Menge berechnet. Bitte Eingaben pr√ºfen.');
                    return;
                }
                
                // NH3 Storage Energy Costs (NEW) - NOW CAN USE nh3TransportRequiredMain
                const nh3SpecKwhPerTIn = getInput('nh3_spec_kwh_per_t_in') || 1.0;
                const nh3SpecKwhPerTOut = getInput('nh3_spec_kwh_per_t_out') || 1.0;
                const nh3CoolingKwhPerTPerDay = getInput('nh3_cooling_kwh_per_t_per_day') || 40.0;
                
                // NH3 storage energy: In/out operations
                const nh3StoredAnnual = ammoniaProduction * 365; // t/year (rough estimate)
                const nh3StorageInEnergy = nh3StoredAnnual * nh3SpecKwhPerTIn; // kWh
                const nh3StorageOutEnergy = nh3TransportRequiredMain * nh3SpecKwhPerTOut; // kWh
                
                // NH3 cooling energy (continuous)
                const nh3CoolingEnergy = nh3StorageCapacity * nh3CoolingKwhPerTPerDay * 365 / 24; // kWh/year
                
                const nh3StorageEnergyTotal = nh3StorageInEnergy + nh3StorageOutEnergy + nh3CoolingEnergy;
                const nh3StorageEnergyCost = electricityPrice * nh3StorageEnergyTotal;
                
                // Update storage costs with energy costs (waterReplacementCost already calculated in desalination section)
                const storageCostAnnual = storageCAPEXannual + storageOPEX + h2StorageEnergyCost + nh3StorageEnergyCost;
                
                // Continue Transport calculation (nh3TransportRequiredMain already calculated above)
                const transportDistanceMain = getInput('transport_distance');
                const onewayTimeMain = getInput('transport_time');
                const portTimeMain = getInput('port_time');
                
                // Validate transport parameters to avoid division by zero
                if (!onewayTimeMain || onewayTimeMain <= 0 || !portTimeMain || portTimeMain < 0) {
                    alert('Transport-Zeit-Parameter m√ºssen > 0 sein. Bitte transport_time und port_time pr√ºfen.');
                    return;
                }
                
                // Manual overrides (if user entered values > 0)
                const cycleTimeManualMain = getInput('cycle_time_days');
                const tripsPerShipManualMain = getInput('trips_per_ship_a');
                const shipPayloadManualMain = getInput('ship_payload_nh3');
                const numVesselsManualMain = getInput('num_vessels');
                
                // Cycle time / trips per ship
                let cycleTimeMain = cycleTimeManualMain;
                let tripsPerShipMain = tripsPerShipManualMain;
                if (!(tripsPerShipMain > 0 && isFinite(tripsPerShipMain))) {
                    if (!(cycleTimeMain > 0 && isFinite(cycleTimeMain))) {
                        cycleTimeMain = 2 * onewayTimeMain + portTimeMain;
                    }
                    tripsPerShipMain = (cycleTimeMain > 0 && isFinite(cycleTimeMain)) ? (365 / cycleTimeMain) : 0;
                }
                
                const vesselTankVolumeMain = getInput('vessel_tank_volume');
                const nh3DensityMain = getInput('nh3_density');
                const fillFactorMain = getInput('fill_factor');
                
                // Validate vessel parameters
                if (!vesselTankVolumeMain || vesselTankVolumeMain <= 0 || !nh3DensityMain || nh3DensityMain <= 0 || !fillFactorMain || fillFactorMain <= 0) {
                    alert('Schiffs-Parameter m√ºssen > 0 sein. Bitte vessel_tank_volume, nh3_density und fill_factor pr√ºfen.');
                    return;
                }
                
                let shipPayloadMain = shipPayloadManualMain;
                if (!(shipPayloadMain > 0 && isFinite(shipPayloadMain))) {
                    shipPayloadMain = vesselTankVolumeMain * nh3DensityMain * fillFactorMain;
                }
                
                if (!isFinite(tripsPerShipMain) || tripsPerShipMain <= 0 || !isFinite(shipPayloadMain) || shipPayloadMain <= 0) {
                    alert('Ung√ºltige Transport-Berechnung. Bitte Transport-Parameter pr√ºfen.');
                    return;
                }
                
                let numVesselsMain = 0;
                if (numVesselsManualMain > 0 && isFinite(numVesselsManualMain)) {
                    numVesselsMain = Math.ceil(numVesselsManualMain);
                } else {
                    // Calculate from transport requirements
                    const transportCapacityPerYear = shipPayloadMain * tripsPerShipMain;
                    if (transportCapacityPerYear > 0 && isFinite(transportCapacityPerYear)) {
                        numVesselsMain = Math.ceil(nh3TransportRequiredMain / transportCapacityPerYear);
                    } else {
                        alert('Ung√ºltige Transport-Kapazit√§t berechnet. Bitte Transport-Parameter pr√ºfen.');
                        return;
                    }
                }
                
                // Validate numVesselsMain
                if (!isFinite(numVesselsMain) || numVesselsMain <= 0) {
                    alert('Ung√ºltige Anzahl Schiffe berechnet. Bitte Transport-Parameter pr√ºfen.');
                    return;
                }
                
                const vesselCAPEXMain = getInput('vessel_capex') * 1000000;
                const vesselOPEXMain = getInput('vessel_opex') * 1000000;
                const vesselTotalCAPEXMain = vesselCAPEXMain * numVesselsMain;
                const vesselCAPEXannual = annualizeCAPEX(vesselTotalCAPEXMain, discountRate, lifetime);
                const vesselOPEXtotal = vesselOPEXMain * numVesselsMain;
                
                const shippingCostPerTMain = getInput('shipping_cost_per_t_nh3');
                const shippingCostPerTkmMain = getInput('shipping_cost_per_tkm');
                const fuelCostPerTripMain = getInput('fuel_cost_per_trip');
                const harborFeesPerTripMain = getInput('harbor_fees_per_trip');
                const insuranceRateMain = getInput('insurance_rate') / 100;
                
                let variableShippingCostMain = 0;
                if (shippingCostPerTMain > 0) {
                    variableShippingCostMain = nh3TransportRequiredMain * shippingCostPerTMain;
                } else if (shippingCostPerTkmMain > 0) {
                    variableShippingCostMain = nh3TransportRequiredMain * transportDistanceMain * shippingCostPerTkmMain;
                }
                
                const totalTripsMain = numVesselsMain * tripsPerShipMain;
                const fuelCostTotalMain = fuelCostPerTripMain * totalTripsMain;
                const harborFeesTotalMain = harborFeesPerTripMain * totalTripsMain;
                const insuranceCostMain = vesselTotalCAPEXMain * insuranceRateMain;
                
                let taxesCustomsMain = getInput('taxes_customs') * 1000000;
                const customsRateMain = getInput('customs_rate') / 100;
                const vatRateMain = getInput('vat_rate') / 100;
                
                if (customsRateMain > 0 || vatRateMain > 0) {
                    const nh3PricePerTMain = 500; // ‚Ç¨/t (placeholder)
                    const nh3ValueMain = nh3TransportRequiredMain * nh3PricePerTMain;
                    taxesCustomsMain = nh3ValueMain * (customsRateMain + vatRateMain);
                }
                
                const transportCostAnnual = vesselCAPEXannual + vesselOPEXtotal + variableShippingCostMain + 
                                           fuelCostTotalMain + harborFeesTotalMain + insuranceCostMain + taxesCustomsMain;

                // 8. Cracking (Ammonia Decomposition)
                // Reaction: 2 NH‚ÇÉ ‚Üí N‚ÇÇ + 3 H‚ÇÇ (endothermic, requires 850-1000¬∞C)
                // Thermal energy: ~1.2-1.5 MWh per tonne NH‚ÇÉ (if not using waste heat)
                // Conversion efficiency: typically 85-95% (some NH‚ÇÉ not decomposed)
                // H‚ÇÇ recovery: 95-98% (some H‚ÇÇ lost in separation)
                const crackingEfficiency = getInput('cracking_efficiency') / 100;
                const h2PurityLoss = getInput('h2_purity_loss') || 0;
                const h2RecoveryFraction = getInput('h2_recovery_fraction') || 1.0;
                
                // Validate cracking parameters
                if (!isFinite(crackingEfficiency) || crackingEfficiency <= 0 || crackingEfficiency > 1) {
                    alert('Cracking Efficiency muss zwischen 0% und 100% liegen. Bitte cracking_efficiency pr√ºfen.');
                    return;
                }
                if (!isFinite(h2PurityLoss) || h2PurityLoss < 0 || h2PurityLoss > 1) {
                    alert('H‚ÇÇ Purity Loss muss zwischen 0% und 100% liegen. Bitte h2_purity_loss pr√ºfen.');
                    return;
                }
                if (!isFinite(h2RecoveryFraction) || h2RecoveryFraction <= 0 || h2RecoveryFraction > 1) {
                    alert('H‚ÇÇ Recovery Fraction muss zwischen 0% und 100% liegen. Bitte h2_recovery_fraction pr√ºfen.');
                    return;
                }
                
                const effectiveCrackingEfficiency = crackingEfficiency * (1 - h2PurityLoss) * h2RecoveryFraction;
                
                // Validate effective cracking efficiency
                if (!isFinite(effectiveCrackingEfficiency) || effectiveCrackingEfficiency <= 0 || effectiveCrackingEfficiency > 1) {
                    alert('Ung√ºltige effektive Cracking-Effizienz berechnet: ' + effectiveCrackingEfficiency.toFixed(4) + 
                          '. Bitte Cracking-Parameter pr√ºfen.');
                    return;
                }
                
                // Thermal energy cost (if not using waste heat)
                const thermalEnergyPerTNH3 = 1.35; // MWh/t NH‚ÇÉ (average)
                
                // Validate nh3NeededTransport (should be defined earlier in transport section)
                if (typeof nh3NeededTransport === 'undefined' || !isFinite(nh3NeededTransport) || nh3NeededTransport <= 0) {
                    alert('NH‚ÇÉ-Menge f√ºr Cracking ist ung√ºltig. Bitte Transport-Berechnung pr√ºfen.');
                    return;
                }
                
                const nh3ForCracking = nh3NeededTransport; // t/a
                const thermalEnergyRequired = nh3ForCracking * thermalEnergyPerTNH3 * 1000; // kWh/a
                const eCrackGwh = getInput('cracking_electricity_gwh_year') || 0;
                const thermalEnergyCost = (eCrackGwh > 0) ? (electricityPrice * eCrackGwh * 1e6) : (electricityPrice * thermalEnergyRequired); // E_CRACK override
                
                // Validate crackingCAPEX and crackingOPEX (should be defined earlier)
                if (typeof crackingCAPEX === 'undefined' || !isFinite(crackingCAPEX)) {
                    alert('Cracking CAPEX ist nicht definiert. Bitte cracking_capex pr√ºfen.');
                    return;
                }
                if (typeof crackingOPEX === 'undefined' || !isFinite(crackingOPEX)) {
                    alert('Cracking OPEX ist nicht definiert. Bitte cracking_opex pr√ºfen.');
                    return;
                }
                
                const crackingCAPEXannual = annualizeCAPEX(crackingCAPEX, discountRate, lifetime);
                const crackingCostAnnual = crackingCAPEXannual + crackingOPEX + thermalEnergyCost;

                const storageLossRate = getInput('storage_loss_rate') / 100;
                const nh3ShippingLoss = getInput('nh3_shipping_loss') / 100;
                
                // Chain efficiency calculation
                // Haber-Bosch: typically 90-95% conversion efficiency
                const etaHB = 1 - haberBoschLoss;
                // Storage: annual loss rate (for cryogenic storage: 0.5-2% per year)
                const etaStorage = 1 - storageLossRate;
                // Shipping: loss per trip (boil-off, venting: typically 0.1-0.5% per trip)
                const etaShipping = 1 - nh3ShippingLoss;
                // Cracking: thermal decomposition efficiency (typically 85-95%)
                const etaCracking = effectiveCrackingEfficiency;
                
                // Overall chain efficiency (multiplicative)
                const chainEfficiency = etaHB * etaStorage * etaShipping * etaCracking;
                
                // Validate chain efficiency
                if (!isFinite(chainEfficiency) || chainEfficiency <= 0 || chainEfficiency > 1) {
                    alert('Ung√ºltige Ketteneffizienz berechnet: ' + chainEfficiency.toFixed(4) + 
                          '. Bitte Verluste pr√ºfen (m√ºssen zwischen 0% und 100% liegen).\n' +
                          'Haber-Bosch Loss: ' + (haberBoschLoss * 100).toFixed(2) + '%\n' +
                          'Storage Loss: ' + (storageLossRate * 100).toFixed(2) + '%\n' +
                          'Shipping Loss: ' + (nh3ShippingLoss * 100).toFixed(2) + '%\n' +
                          'Cracking Efficiency: ' + (effectiveCrackingEfficiency * 100).toFixed(2) + '%');
                    return;
                }
                
                // Validate h2Reference
                if (!isFinite(h2Reference) || h2Reference <= 0) {
                    alert('H‚ÇÇ-Referenzmenge ist ung√ºltig: ' + h2Reference + '. Bitte h2_import_target oder h2_steel_demand pr√ºfen.');
                    return;
                }
                
                const h2DeliveredAnnual = h2Reference * chainEfficiency; // kg

                if (!isFinite(h2DeliveredAnnual) || h2DeliveredAnnual <= 0) {
                    alert('Gelieferte H‚ÇÇ-Menge ist 0 oder ung√ºltig: ' + h2DeliveredAnnual + 
                          '. Bitte Eingaben pr√ºfen (Verluste, Effizienzen, Referenzmenge).');
                    console.error('h2Reference:', h2Reference, 'chainEfficiency:', chainEfficiency);
                    return;
                }

                const totalAnnualCost = windCostAnnualTotal + electrolysisCostAnnual + desalinationCostAnnual + 
                                       asuCostAnnual + haberBoschCostAnnual + storageCostAnnual + 
                                       transportCostAnnual + crackingCostAnnual;

                // Cost per kg delivered H‚ÇÇ (Levelized Cost of Hydrogen - LCOH)
                if (h2DeliveredAnnual <= 0) {
                    alert('Division durch 0: Gelieferte H‚ÇÇ-Menge ist 0. Bitte Verluste und Effizienzen pr√ºfen.');
                    return;
                }
                
                const costPerKg = totalAnnualCost / h2DeliveredAnnual;
                
                // Validate result
                if (!isFinite(costPerKg) || costPerKg <= 0 || costPerKg > 1000) {
                    alert('Berechnungsfehler: Kosten pro kg sind ung√ºltig: ' + costPerKg.toFixed(4) + ' ‚Ç¨/kg.\n' +
                          'Total Cost: ' + (totalAnnualCost / 1000000).toFixed(2) + ' M‚Ç¨/year\n' +
                          'H‚ÇÇ Delivered: ' + (h2DeliveredAnnual / 1000000).toFixed(2) + ' t/year\n' +
                          'Bitte Eingaben pr√ºfen.');
                    console.error('Invalid costPerKg:', costPerKg, 'totalAnnualCost:', totalAnnualCost, 'h2DeliveredAnnual:', h2DeliveredAnnual);
                    return;
                }

            // ========== DISPLAY RESULTS ==========
            const costPerKgText = costPerKg.toFixed(4) + ' ‚Ç¨/kg';
            document.getElementById('result_cost_per_kg').textContent = costPerKgText;
            document.getElementById('result_total_annual').textContent = (totalAnnualCost / 1000000).toFixed(2) + ' M‚Ç¨/year';
            document.getElementById('result_h2_delivered').textContent = (h2DeliveredAnnual / 1000000).toFixed(2) + ' t/year';

            // Plausibilit√§tscheck vs. Literatur (z.B. 4,8‚Äì6,2 ‚Ç¨/kg importierter H‚ÇÇ via NH‚ÇÉ)
            try {
                const badge = document.getElementById('plausibility_badge');
                if (badge) {
                    const litMin = 4.8;
                    const litMax = 6.2;
                    let cls = 'plausibility-ok';
                    let txt = '';

                    if (costPerKg < litMin * 0.8) {
                        cls = 'plausibility-low';
                        txt = 'Hinweis: Das Modell-Ergebnis (' + costPerKgText + ') liegt deutlich UNTER typischen Literaturwerten f√ºr importierten H‚ÇÇ via NH‚ÇÉ (ca. 4,8‚Äì6,2 ‚Ç¨/kg in 2030-Studien). Die Annahmen sind sehr optimistisch.';
                    } else if (costPerKg > litMax * 1.2) {
                        cls = 'plausibility-high';
                        txt = 'Hinweis: Das Modell-Ergebnis (' + costPerKgText + ') liegt deutlich √úBER typischen Literaturwerten f√ºr importierten H‚ÇÇ via NH‚ÇÉ (ca. 4,8‚Äì6,2 ‚Ç¨/kg in 2030-Studien). Bitte Annahmen pr√ºfen.';
                    } else {
                        cls = 'plausibility-ok';
                        txt = 'Plausibilit√§t: Das Modell-Ergebnis (' + costPerKgText + ') liegt im Bereich aktueller Studien f√ºr importierten H‚ÇÇ via NH‚ÇÉ (ca. 4,8‚Äì6,2 ‚Ç¨/kg in 2030-Analysen).';
                    }

                    badge.className = 'plausibility-badge ' + cls;
                    badge.textContent = txt;
                    badge.style.display = 'block';
                }
            } catch (e) {
                console.warn('Fehler beim Plausibilit√§ts-Update:', e);
            }

            // Update prediction page current cost
            document.getElementById('current_cost_per_kg').value = costPerKg.toFixed(4);
            
            // Update prediction page current cost (don't auto-calculate, user should click button)

            // Cost breakdown - separate CapEx, OpEx, and Variable costs
            const electrolysisVariableCost = electricityPrice * electrolysisElectricityDemand;
            const desalinationVariableCost = electricityPrice * desalinationElectricityDemand;
            const asuVariableCost = electricityPrice * asuElectricity;
            const haberBoschVariableCost = electricityPrice * haberBoschElectricity;
            
            // Calculate costs per kg H‚ÇÇ
            const costPerKgFactor = 1 / h2DeliveredAnnual;
            
            const breakdown = [
                {
                    name: 'Wind Farm',
                    // Nur dann in den Gesamtkosten, wenn includeWindInTotal = true
                    capex: includeWindInTotal ? (windCAPEXannual + windDepexAnnual) * costPerKgFactor : 0,
                    opex: includeWindInTotal ? windOPEX * costPerKgFactor : 0,
                    variable: 0
                },
                { 
                    name: 'Electrolysis', 
                    capex: electrolysisCAPEXannual * costPerKgFactor,
                    opex: electrolysisOPEX * costPerKgFactor,
                    variable: electrolysisVariableCost * costPerKgFactor
                },
                { 
                    name: 'Desalination', 
                    capex: desalinationCAPEXannual * costPerKgFactor,
                    opex: desalinationOPEX * costPerKgFactor,
                    variable: desalinationVariableCost * costPerKgFactor
                },
                { 
                    name: 'ASU (Nitrogen)', 
                    capex: asuCAPEXannual * costPerKgFactor,
                    opex: asuOPEX * costPerKgFactor,
                    variable: asuVariableCost * costPerKgFactor
                },
                { 
                    name: 'Haber-Bosch', 
                    capex: haberBoschCAPEXannual * costPerKgFactor,
                    opex: haberBoschOPEX * costPerKgFactor,
                    variable: haberBoschVariableCost * costPerKgFactor
                },
                { 
                    name: 'Storage', 
                    capex: storageCAPEXannual * costPerKgFactor,
                    opex: storageOPEX * costPerKgFactor,
                    variable: 0
                },
                { 
                    name: 'Transport', 
                    capex: vesselCAPEXannual * costPerKgFactor,
                    opex: (vesselOPEXtotal + taxesCustomsMain + insuranceCostMain) * costPerKgFactor,
                    variable: (variableShippingCostMain + fuelCostTotalMain + harborFeesTotalMain) * costPerKgFactor
                },
                {
                    name: 'Cracking',
                    capex: crackingCAPEXannual * costPerKgFactor,
                    opex: crackingOPEX * costPerKgFactor,
                    variable: 0
                }
            ];

            // Speichere Breakdown f√ºr sp√§teren Vergleich
            currentCostBreakdown = breakdown;

            // Calculate totals for display
            let breakdownHTML = '';
            breakdown.forEach(item => {
                const total = item.capex + item.opex + item.variable;
                const percentage = (total / costPerKg * 100).toFixed(1);
                breakdownHTML += `
                    <div class="cost-item">
                        <span>${item.name}</span>
                        <span style="font-weight: 700; color: #4A90E2; font-family: 'Courier New', monospace;">
                            ${total.toFixed(4)} ‚Ç¨/kg <span style="color: #6c757d; font-weight: 500;">(${percentage}%)</span>
                        </span>
                    </div>
                `;
            });
            document.getElementById('cost_breakdown_list').innerHTML = breakdownHTML;

            // Update chart - Stacked Bar Chart
            const costChartCanvas = document.getElementById('costChart');
            if (!costChartCanvas) {
                console.warn('costChart canvas element not found');
            } else {
                // Check if there's an existing chart and destroy it
                const existingChart = Chart.getChart(costChartCanvas);
                if (existingChart) {
                    existingChart.destroy();
                }
            }

            // Konsistente Farben f√ºr alle Komponenten (gleiche Farbe f√ºr alle CapEx, alle OpEx, etc.)
            const costTypeColors = {
                capex: '#2E7D32',      // Dunkelgr√ºn f√ºr alle CapEx
                opex: '#C62828',      // Dunkelrot f√ºr alle OpEx
                variable: '#F57C00'    // Orange f√ºr alle Variable Costs
            };
            
            // Color palette for different components (f√ºr X-Achsen-Labels)
            const componentColors = {
                'Wind Farm': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' },
                'Electrolysis': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' },
                'Desalination': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' },
                'ASU (Nitrogen)': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' },
                'Haber-Bosch': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' },
                'Storage': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' },
                'Transport': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' },
                'Cracking': { capex: '#2E7D32', opex: '#C62828', variable: '#F57C00' }
            };

            // Berechne Gurobi-Breakdown falls verf√ºgbar
            let gurobiBreakdown = null;
            if (window.gurobiOptBest && window.gurobiOptBest.costPerKg && window.gurobiOptDecision) {
                gurobiBreakdown = calculateGurobiBreakdown(window.gurobiOptBest, window.gurobiOptDecision, 
                    discountRate, lifetime, electricityPrice, h2DeliveredAnnual, costPerKgFactor);
            }

            const ctx = costChartCanvas ? costChartCanvas.getContext('2d') : null;
            if (!ctx) {
                console.error('Could not get canvas context for costChart');
            } else {
                // Erstelle grouped bars: Aktuell vs. Gurobi
                const labels = breakdown.map(item => item.name);
                const datasets = [];
                
                // Aktuelle Konfiguration - konsistente Farben
                datasets.push({
                    label: 'Aktuell: CapEx',
                    data: breakdown.map(item => item.capex),
                    backgroundColor: costTypeColors.capex,
                    stack: 'Aktuell'
                });
                datasets.push({
                    label: 'Aktuell: OpEx',
                    data: breakdown.map(item => item.opex),
                    backgroundColor: costTypeColors.opex,
                    stack: 'Aktuell'
                });
                datasets.push({
                    label: 'Aktuell: Variable',
                    data: breakdown.map(item => item.variable),
                    backgroundColor: costTypeColors.variable,
                    stack: 'Aktuell'
                });

                // Gurobi-optimierte Konfiguration (falls verf√ºgbar) - gleiche Farben mit Transparenz
                if (gurobiBreakdown) {
                    datasets.push({
                        label: 'Gurobi: CapEx',
                        data: gurobiBreakdown.map(item => item.capex),
                        backgroundColor: costTypeColors.capex + '80', // 50% opacity
                        stack: 'Gurobi'
                    });
                    datasets.push({
                        label: 'Gurobi: OpEx',
                        data: gurobiBreakdown.map(item => item.opex),
                        backgroundColor: costTypeColors.opex + '80',
                        stack: 'Gurobi'
                    });
                    datasets.push({
                        label: 'Gurobi: Variable',
                        data: gurobiBreakdown.map(item => item.variable),
                        backgroundColor: costTypeColors.variable + '80',
                        stack: 'Gurobi'
                    });
                }

                const costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#333333', /* dunkles Grau statt Blau */
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                usePointStyle: true,
                                pointStyle: 'line' /* Legende als Strich-Symbol statt gef√ºlltem Kasten */
                            }
                        },
                        title: {
                            display: true,
                            text: gurobiBreakdown ? 'Hydrogen Production Costs (‚Ç¨/kg) - Aktuell vs. Gurobi-Optimiert' : 'Hydrogen Production Costs (‚Ç¨/kg) - Stacked by Cost Type',
                            color: '#4A90E2',
                            font: {
                                size: 16,
                                weight: '700'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(4) + ' ‚Ç¨/kg';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            categoryPercentage: gurobiBreakdown ? 0.4 : 0.6,
                            barPercentage: 0.8,
                            ticks: {
                                color: '#4A90E2',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(74, 144, 226, 0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost (‚Ç¨/kg H‚ÇÇ)',
                                color: '#4A90E2',
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            },
                            ticks: {
                                color: '#4A90E2',
                                callback: function(value) {
                                    return value.toFixed(3) + ' ‚Ç¨/kg';
                                }
                            },
                            grid: {
                                color: 'rgba(74, 144, 226, 0.1)'
                            }
                        }
                    }
                }
                });

                // Aktualisiere Diagramme mit Gurobi-Vergleich, falls verf√ºgbar
                if (window.gurobiOptBest && window.gurobiOptBest.costPerKg && window.gurobiOptDecision && currentCostBreakdown) {
                    const electricityCostMethod = document.getElementById('electricity_cost_method').value;
                    let electricityPrice = 0;
                    if (electricityCostMethod === 'internal_LCOE') {
                        const windCapacity = getInput('wind_capacity') * 1000;
                        const windCapacityFactor = getInput('wind_capacity_factor') / 100;
                        const windCAPEX = getInput('wind_capex') * 1000000000;
                        const windOPEX = getInput('wind_opex') * 1000000;
                        const windDepex = getInput('wind_depex') * 1000000;
                        const windElectricityAnnual = windCapacity * 8760 * windCapacityFactor;
                        const windCAPEXannual = annualizeCAPEX(windCAPEX, discountRate, lifetime);
                        const windDepexAnnual = annualizeDepex(windDepex, discountRate, lifetime);
                        const windCostAnnual = windCAPEXannual + windOPEX + windDepexAnnual;
                        electricityPrice = windCostAnnual / (windElectricityAnnual * 1000);
                    } else {
                        electricityPrice = getInput('external_electricity_price') / 1000;
                    }
                    const costPerKgFactor = h2DeliveredAnnual > 0 ? 1 / h2DeliveredAnnual : 0;
                    updateCostChartsWithGurobi(window.gurobiOptBest, window.gurobiOptDecision, 
                        discountRate, lifetime, electricityPrice, h2DeliveredAnnual, costPerKgFactor);
                }
            }

            // Second Chart: Total CapEx vs Total OpEx vs Total Variable Costs
            const costTypeChartCanvas = document.getElementById('costTypeChart');
            if (costTypeChartCanvas) {
                // Check if there's an existing chart and destroy it
                const existingCostTypeChart = Chart.getChart(costTypeChartCanvas);
                if (existingCostTypeChart) {
                    existingCostTypeChart.destroy();
                }
            }

            // Calculate totals
            const totalCapEx = breakdown.reduce((sum, item) => sum + item.capex, 0);
            const totalOpEx = breakdown.reduce((sum, item) => sum + item.opex, 0);
            const totalVariable = breakdown.reduce((sum, item) => sum + item.variable, 0);

            // Gurobi totals (falls verf√ºgbar)
            let gurobiTotalCapEx = null;
            let gurobiTotalOpEx = null;
            let gurobiTotalVariable = null;
            if (gurobiBreakdown) {
                gurobiTotalCapEx = gurobiBreakdown.reduce((sum, item) => sum + item.capex, 0);
                gurobiTotalOpEx = gurobiBreakdown.reduce((sum, item) => sum + item.opex, 0);
                gurobiTotalVariable = gurobiBreakdown.reduce((sum, item) => sum + item.variable, 0);
            }

            if (costTypeChartCanvas) {
                const ctx2 = costTypeChartCanvas.getContext('2d');
                const datasets = [
                    {
                        label: 'Aktuell: Total CapEx (‚Ç¨/kg)',
                        data: [totalCapEx],
                        backgroundColor: '#2E7D32',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    },
                    {
                        label: 'Aktuell: Total OpEx (‚Ç¨/kg)',
                        data: [totalOpEx],
                        backgroundColor: '#C62828',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    },
                    {
                        label: 'Aktuell: Total Variable Costs (‚Ç¨/kg)',
                        data: [totalVariable],
                        backgroundColor: '#F57C00',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    }
                ];

                if (gurobiTotalCapEx !== null) {
                    datasets.push({
                        label: 'Gurobi: Total CapEx (‚Ç¨/kg)',
                        data: [gurobiTotalCapEx],
                        backgroundColor: '#2E7D3280',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                    datasets.push({
                        label: 'Gurobi: Total OpEx (‚Ç¨/kg)',
                        data: [gurobiTotalOpEx],
                        backgroundColor: '#C6282880',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                    datasets.push({
                        label: 'Gurobi: Total Variable Costs (‚Ç¨/kg)',
                        data: [gurobiTotalVariable],
                        backgroundColor: '#F57C0080',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                }

                // Erstelle zwei separate Labels f√ºr Abstand zwischen den Balken
                const chartLabels = gurobiTotalCapEx !== null ? ['Feste Kosten', 'Gurobi'] : ['Total Costs'];
                const chartDatasets = [];
                
                if (gurobiTotalCapEx !== null) {
                    // Separate Datasets f√ºr Aktuell und Gurobi
                    chartDatasets.push({
                        label: 'Feste Kosten: Total CapEx (‚Ç¨/kg)',
                        data: [totalCapEx, null],
                        backgroundColor: '#2E7D32',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                    chartDatasets.push({
                        label: 'Feste Kosten: Total OpEx (‚Ç¨/kg)',
                        data: [totalOpEx, null],
                        backgroundColor: '#C62828',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                    chartDatasets.push({
                        label: 'Feste Kosten: Total Variable Costs (‚Ç¨/kg)',
                        data: [totalVariable, null],
                        backgroundColor: '#F57C00',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                    chartDatasets.push({
                        label: 'Gurobi: Total CapEx (‚Ç¨/kg)',
                        data: [null, gurobiTotalCapEx],
                        backgroundColor: '#2E7D3280',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                    chartDatasets.push({
                        label: 'Gurobi: Total OpEx (‚Ç¨/kg)',
                        data: [null, gurobiTotalOpEx],
                        backgroundColor: '#C6282880',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                    chartDatasets.push({
                        label: 'Gurobi: Total Variable Costs (‚Ç¨/kg)',
                        data: [null, gurobiTotalVariable],
                        backgroundColor: '#F57C0080',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    });
                } else {
                    chartDatasets.push(...datasets);
                }

                const costTypeChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#333333', /* dunkles Grau statt Blau */
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                usePointStyle: true,
                                pointStyle: 'line' /* Legende als Strich-Symbol statt gef√ºlltem Kasten */
                            }
                        },
                        title: {
                            display: true,
                            text: gurobiBreakdown ? 'Total Hydrogen Production Costs by Type (‚Ç¨/kg) - Aktuell vs. Gurobi-Optimiert' : 'Total Hydrogen Production Costs by Type (‚Ç¨/kg)',
                            color: '#4A90E2',
                            font: {
                                size: 16,
                                weight: '700'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(4) + ' ‚Ç¨/kg';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            categoryPercentage: gurobiBreakdown ? 0.4 : 0.3,
                            barPercentage: 0.5,
                            ticks: {
                                color: '#4A90E2',
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(74, 144, 226, 0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost (‚Ç¨/kg H‚ÇÇ)',
                                color: '#4A90E2',
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            },
                            ticks: {
                                color: '#4A90E2',
                                callback: function(value) {
                                    return value.toFixed(3) + ' ‚Ç¨/kg';
                                }
                            },
                            grid: {
                                color: 'rgba(74, 144, 226, 0.1)'
                            }
                        }
                    }
                }
                });
            }
            } catch (error) {
                console.error('Error in calculateCosts():', error);
                alert('Berechnungsfehler: ' + error.message + '\n\nBitte Browser-Konsole (F12) f√ºr Details √∂ffnen.');
                return;
            }
        }

        // Aktualisiert die Kosten-Diagramme mit Gurobi-Vergleich
        function updateCostChartsWithGurobi(gurobiOptBest, gurobiOptDecision, discountRate, lifetime, electricityPrice, h2DeliveredAnnual, costPerKgFactor) {
            if (!gurobiOptBest || !gurobiOptDecision || !currentCostBreakdown) return;

            // Berechne Gurobi-Breakdown
            const gurobiBreakdown = calculateGurobiBreakdown(gurobiOptBest, gurobiOptDecision, 
                discountRate, lifetime, electricityPrice, h2DeliveredAnnual, costPerKgFactor);
            
            if (!gurobiBreakdown) return;

            // Aktualisiere das erste Diagramm (Komponenten-Breakdown)
            const costChartCanvas = document.getElementById('costChart');
            if (costChartCanvas) {
                const existingChart = Chart.getChart(costChartCanvas);
                if (existingChart) {
                    existingChart.destroy();
                }

                // Konsistente Farben f√ºr alle Komponenten
                const costTypeColors = {
                    capex: '#2E7D32',      // Dunkelgr√ºn f√ºr alle CapEx
                    opex: '#C62828',      // Dunkelrot f√ºr alle OpEx
                    variable: '#F57C00'    // Orange f√ºr alle Variable Costs
                };

                const labels = currentCostBreakdown.map(item => item.name);
                const datasets = [];
                
                // Aktuelle Konfiguration - konsistente Farben
                datasets.push({
                    label: 'Aktuell: CapEx',
                    data: currentCostBreakdown.map(item => item.capex),
                    backgroundColor: costTypeColors.capex,
                    stack: 'Aktuell'
                });
                datasets.push({
                    label: 'Aktuell: OpEx',
                    data: currentCostBreakdown.map(item => item.opex),
                    backgroundColor: costTypeColors.opex,
                    stack: 'Aktuell'
                });
                datasets.push({
                    label: 'Aktuell: Variable',
                    data: currentCostBreakdown.map(item => item.variable),
                    backgroundColor: costTypeColors.variable,
                    stack: 'Aktuell'
                });

                // Gurobi-optimierte Konfiguration - gleiche Farben mit Transparenz
                datasets.push({
                    label: 'Gurobi: CapEx',
                    data: gurobiBreakdown.map(item => item.capex),
                    backgroundColor: costTypeColors.capex + '80',
                    stack: 'Gurobi'
                });
                datasets.push({
                    label: 'Gurobi: OpEx',
                    data: gurobiBreakdown.map(item => item.opex),
                    backgroundColor: costTypeColors.opex + '80',
                    stack: 'Gurobi'
                });
                datasets.push({
                    label: 'Gurobi: Variable',
                    data: gurobiBreakdown.map(item => item.variable),
                    backgroundColor: costTypeColors.variable + '80',
                    stack: 'Gurobi'
                });

                const ctx = costChartCanvas.getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: {
                                display: true,
                                text: 'Hydrogen Production Costs (‚Ç¨/kg) - Aktuell vs. Gurobi-Optimiert',
                                color: '#4A90E2',
                                font: { size: 16, weight: '700' }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                categoryPercentage: 0.4,
                                barPercentage: 0.8
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: { display: true, text: 'Cost (‚Ç¨/kg H‚ÇÇ)' }
                            }
                        }
                    }
                });
            }

            // Aktualisiere das zweite Diagramm (Total Costs by Type)
            const costTypeChartCanvas = document.getElementById('costTypeChart');
            if (costTypeChartCanvas) {
                const existingChart = Chart.getChart(costTypeChartCanvas);
                if (existingChart) {
                    existingChart.destroy();
                }

                const totalCapEx = currentCostBreakdown.reduce((sum, item) => sum + item.capex, 0);
                const totalOpEx = currentCostBreakdown.reduce((sum, item) => sum + item.opex, 0);
                const totalVariable = currentCostBreakdown.reduce((sum, item) => sum + item.variable, 0);

                const gurobiTotalCapEx = gurobiBreakdown.reduce((sum, item) => sum + item.capex, 0);
                const gurobiTotalOpEx = gurobiBreakdown.reduce((sum, item) => sum + item.opex, 0);
                const gurobiTotalVariable = gurobiBreakdown.reduce((sum, item) => sum + item.variable, 0);

                // Erstelle zwei separate Labels f√ºr Abstand zwischen den Balken
                const chartLabels = ['Feste Kosten', 'Gurobi'];
                const chartDatasets = [
                    {
                        label: 'Feste Kosten: Total CapEx (‚Ç¨/kg)',
                        data: [totalCapEx, null],
                        backgroundColor: '#2E7D32',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    },
                    {
                        label: 'Feste Kosten: Total OpEx (‚Ç¨/kg)',
                        data: [totalOpEx, null],
                        backgroundColor: '#C62828',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    },
                    {
                        label: 'Feste Kosten: Total Variable Costs (‚Ç¨/kg)',
                        data: [totalVariable, null],
                        backgroundColor: '#F57C00',
                        stack: 'Aktuell',
                        barThickness: 60,
                        maxBarThickness: 80
                    },
                    {
                        label: 'Gurobi: Total CapEx (‚Ç¨/kg)',
                        data: [null, gurobiTotalCapEx],
                        backgroundColor: '#2E7D3280',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    },
                    {
                        label: 'Gurobi: Total OpEx (‚Ç¨/kg)',
                        data: [null, gurobiTotalOpEx],
                        backgroundColor: '#C6282880',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    },
                    {
                        label: 'Gurobi: Total Variable Costs (‚Ç¨/kg)',
                        data: [null, gurobiTotalVariable],
                        backgroundColor: '#F57C0080',
                        stack: 'Gurobi',
                        barThickness: 60,
                        maxBarThickness: 80
                    }
                ];

                const ctx2 = costTypeChartCanvas.getContext('2d');
                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: chartDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            title: {
                                display: true,
                                text: 'Total Hydrogen Production Costs by Type (‚Ç¨/kg) - Aktuell vs. Gurobi-Optimiert',
                                color: '#4A90E2',
                                font: { size: 16, weight: '700' }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                categoryPercentage: 0.4,
                                barPercentage: 0.5
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: { display: true, text: 'Cost (‚Ç¨/kg H‚ÇÇ)' }
                            }
                        }
                    }
                });
            }
        }

            // Add event listeners to all inputs for auto-calculation
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            loadTheme();
            // Load saved projects into dropdown
            refreshProjectSelect();
            
            const allInputs = document.querySelectorAll('.parameter-input');
            allInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const pages = document.querySelectorAll('.page-section');
                    const currentPage = Array.from(pages).findIndex(page => page.classList.contains('active'));
                    if (currentPage >= 0) {
                        calculatePageCosts(currentPage);
                        // Also recalculate total if needed
                        if (currentPage > 0 && currentPage !== 9) {
                            calculateCosts();
                        }
                    }
                });
            });


            // Add event listeners for prediction inputs
            const predictionInputs = ['capex_reduction_rate', 'opex_reduction_rate', 'learning_rate', 
                                     'inflation_rate', 'demand_growth', 'scale_efficiency'];
            predictionInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function() {
                        // Don't auto-calculate, wait for button click
                    });
                }
            });

            // Standard-Schiffstyp initial anwenden (falls ausgew√§hlt)
            const vesselTypeSelect = document.getElementById('vessel_type');
            if (vesselTypeSelect && vesselTypeSelect.value) {
                onVesselTypeChange(vesselTypeSelect.value);
            }

            // Calculate initial values
            calculatePageCosts(1);
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const pages = document.querySelectorAll('.page-section');
            const currentPage = Array.from(pages).findIndex(page => page.classList.contains('active'));
            
            if (e.key === 'ArrowRight' && currentPage < pages.length - 1) {
                showPage(currentPage + 1);
            } else if (e.key === 'ArrowLeft' && currentPage > 0) {
                showPage(currentPage - 1);
            }
        });
        // Optimization Function
        let optimizationChart = null;
        let currentCostBreakdown = null; // Speichert die aktuellen Kosten-Breakdowns f√ºr Vergleich

        function runOptimization() {
            // Show loading message
            const resultsDiv = document.getElementById('optimization_results');
            resultsDiv.style.display = 'block';
            
            // Show loading in results
            document.getElementById('opt_result_s').textContent = 'Berechne...';
            document.getElementById('opt_result_pel').textContent = 'Berechne...';
            document.getElementById('opt_result_h2_storage').textContent = 'Berechne...';
            document.getElementById('opt_result_nh3_storage').textContent = 'Berechne...';
            document.getElementById('opt_result_water_tank').textContent = 'Berechne...';
            document.getElementById('opt_result_cost').textContent = 'Berechne...';

            // Get optimization ranges (from Python Code_Final.py lines 887-892)
            const sMin = parseFloat(getInput('opt_s_min')) || 0.95;
            const sMax = parseFloat(getInput('opt_s_max')) || 1.0;
            const sStep = parseFloat(getInput('opt_s_step')) || 0.01;
            const pelMin = getInput('opt_pel_min') || 500;
            const pelMax = getInput('opt_pel_max') || 2500;
            const pelStep = getInput('opt_pel_step') || 100;
            const h2DaysMin = getInput('opt_h2_days_min') || 1;
            const h2DaysMax = getInput('opt_h2_days_max') || 2;
            const h2DaysStep = getInput('opt_h2_days_step') || 1;
            const nh3ShipsMin = getInput('opt_nh3_ships_min') || 3;
            const nh3ShipsMax = getInput('opt_nh3_ships_max') || 8;
            const nh3ShipsStep = getInput('opt_nh3_ships_step') || 1;
            const waterTankMin = getInput('opt_water_tank_min') || 500;
            const waterTankMax = getInput('opt_water_tank_max') || 4500;
            const waterTankStep = getInput('opt_water_tank_step') || 2000;

            // Get current values for comparison
            // Try to get from DOM first, but calculate if not available
            let currentCostPerKg = 0;
            const costElement = document.getElementById('result_cost_per_kg');
            if (costElement && costElement.textContent && costElement.textContent !== '-') {
                const costText = costElement.textContent.replace(' ‚Ç¨/kg', '').trim();
                currentCostPerKg = parseFloat(costText);
                if (isNaN(currentCostPerKg) || currentCostPerKg <= 0) {
                    // If not available, calculate it using current parameters
                    currentCostPerKg = 0; // Will be calculated below if needed
                }
            }
            
            // If currentCostPerKg is still 0, we need to calculate it
            // But for optimization, we can skip comparison if not available
            const currentPel = getInput('wind_capacity') || 2470; // MW
            const currentH2Storage = getInput('h2_storage_capacity') || 0; // t
            const currentNH3Storage = getInput('nh3_storage_capacity') || 0; // t

            // Store original values
            const originalPel = getInput('wind_capacity');
            const originalH2Storage = getInput('h2_storage_capacity');
            const originalNH3Storage = getInput('nh3_storage_capacity');
            const originalWaterTank = getInput('water_storage_capacity_storage') || getInput('water_storage_capacity');

            // Transport-/Schiffs-Parameter f√ºr Nebenbedingungen (physikalische Plausibilit√§t)
            const optNh3Density = getInput('nh3_density'); // t/m¬≥
            const optFillFactor = getInput('fill_factor');
            const optVesselTankVolume = getInput('vessel_tank_volume'); // m¬≥
            const optOneWayTime = getInput('transport_time'); // days
            const optPortTime = getInput('port_time'); // days
            const optNh3ShippingLoss = getInput('nh3_shipping_loss') / 100; // -

            // Generate parameter combinations
            const results = [];
            let iteration = 0;
            const totalIterations = Math.ceil((sMax - sMin) / sStep) * 
                                   Math.ceil((pelMax - pelMin) / pelStep) * 
                                   Math.ceil((h2DaysMax - h2DaysMin) / h2DaysStep) * 
                                   Math.ceil((nh3ShipsMax - nh3ShipsMin) / nh3ShipsStep) * 
                                   Math.ceil((waterTankMax - waterTankMin) / waterTankStep);

            // Show progress bar
            const progressDiv = document.getElementById('optimization_progress');
            const progressBar = document.getElementById('optimization_progress_bar');
            const progressText = document.getElementById('optimization_progress_text');
            const statusText = document.getElementById('optimization_status');
            progressDiv.style.display = 'block';

            // Generate all combinations first (including s parameter)
            const combinations = [];
            for (let s = sMin; s <= sMax + 0.0001; s += sStep) { // Add small epsilon for float comparison
                const sRounded = Math.round(s * 100) / 100; // Round to 2 decimals
                for (let pel = pelMin; pel <= pelMax; pel += pelStep) {
                    for (let h2Days = h2DaysMin; h2Days <= h2DaysMax; h2Days += h2DaysStep) {
                        for (let nh3Ships = nh3ShipsMin; nh3Ships <= nh3ShipsMax; nh3Ships += nh3ShipsStep) {
                            for (let waterTank = waterTankMin; waterTank <= waterTankMax; waterTank += waterTankStep) {
                                combinations.push({ s: sRounded, pel, h2Days, nh3Ships, waterTank });
                            }
                        }
                    }
                }
            }

            // Process combinations asynchronously
            let currentIndex = 0;
            const batchSize = 10; // Process 10 combinations per batch

            function processBatch() {
                const batchEnd = Math.min(currentIndex + batchSize, combinations.length);
                
                for (let i = currentIndex; i < batchEnd; i++) {
                    const combo = combinations[i];
                    iteration++;
                                
                                // Calculate H2 storage capacity from days (from Python Code_Final.py line 900)
                                // Note: h2_production is in kt/a, but Python uses t/a, so we need to convert
                                const annualH2ProdKt = getInput('h2_production') || 120.799; // kt/a (Excel m_H2_el)
                                if (!annualH2ProdKt || annualH2ProdKt <= 0) {
                                    console.warn('Invalid annualH2ProdKt:', annualH2ProdKt);
                                    continue; // Skip this combination
                                }
                                const annualH2ProdT = annualH2ProdKt * 1000; // Convert kt/a to t/a (120.799 kt/a = 120799 t/a)
                                const h2StorageCapacity = (annualH2ProdT / 365.0) * combo.h2Days; // t (same as Python: annual_h2_prod_t / 365.0 * h2_days)

                                // Einfache Plausibilit√§tspr√ºfung f√ºr NH3-Schiffsanzahl:
                                // Absch√§tzung der pro Jahr transportierten NH3-Menge pro Schiff
                                if (optVesselTankVolume > 0 && optNh3Density > 0 && optFillFactor > 0 &&
                                    optOneWayTime > 0 && optPortTime >= 0) {
                                    const payloadPerShipT = optVesselTankVolume * optNh3Density * optFillFactor; // t pro Reise
                                    const cycleTimeDays = 2 * optOneWayTime + optPortTime; // Hin- und R√ºckfahrt + Hafenzeit
                                    const tripsPerShipPerYear = 365 / cycleTimeDays;
                                    const annualPerShipT = payloadPerShipT * tripsPerShipPerYear;

                                    // Jahresbedarf an NH3 (ohne Verluste) basierend auf H2-Referenz
                                    const annualNh3ProdT = annualH2ProdT * (17/3); // t NH3/a
                                    const nh3RequiredTransportT = annualNh3ProdT / (1 - Math.min(Math.max(optNh3ShippingLoss, 0), 0.95));

                                    if (annualPerShipT > 0) {
                                        const minShipsPhysical = nh3RequiredTransportT / annualPerShipT;
                                        // Wenn vorgeschlagene Schiffsanzahl klar unter physikalischem Minimum liegt: Kombination verwerfen
                                        if (combo.nh3Ships + 1e-6 < minShipsPhysical) {
                                            continue;
                                        }
                                    }
                                }

                                // Calculate costs for this configuration
                                // Using cost_components_proxy logic from Python Code_Final.py (lines 757-880)
                                const params = getCommonParams();
                                const discountRate = (params.discountRate || 7) / 100; // Default 7%
                                const lifetime = params.lifetime || 20; // Default 20 years
                                const usdToEur = 0.92; // From Python code
                                
                                // Validate parameters
                                if (!isFinite(discountRate) || discountRate <= 0 || discountRate >= 1) {
                                    console.warn('Invalid discountRate:', discountRate);
                                    continue;
                                }
                                if (!isFinite(lifetime) || lifetime <= 0) {
                                    console.warn('Invalid lifetime:', lifetime);
                                    continue;
                                }

                                // Wind costs (fixed) - from Python Code_Final.py lines 769-780
                                const windCapacityMW = getInput('wind_capacity'); // MW (fixed: 2470 MW from Python)
                                const windCapacityKW = windCapacityMW * 1000;
                                const windCAPEXperMW = 2000000; // ‚Ç¨/MW from Python cost_params
                                const windOPEXperKWperYear = 60; // ‚Ç¨/kW/a from Python cost_params
                                const windCAPEX = windCAPEXperMW * windCapacityMW;
                                const windOPEX = windOPEXperKWperYear * windCapacityKW * lifetime; // Total OPEX over lifetime
                                const windCAPEXannual = annualizeCAPEX(windCAPEX, discountRate, lifetime);
                                const windOPEXannual = windOPEX / lifetime; // Annual OPEX
                                const windCostAnnual = windCAPEXannual + windOPEXannual;

                                // Electrolysis costs - from Python Code_Final.py lines 785-789
                                const electrolyzerTech = getInput('electrolyzer_technology') || 'AEL';
                                const elParams = electrolyzerTech === 'AEL' ? 
                                    { capex: 464, opex: 40.6, spec_kwh: 48.0 } : // AEL from Python
                                    { capex: 580, opex: 24.36, spec_kwh: 48.0 }; // PEM from Python
                                
                                const electrolysisPowerMW = combo.pel;
                                const electrolysisPowerKW = electrolysisPowerMW * 1000;
                                const electrolysisCAPEX = elParams.capex * electrolysisPowerKW * usdToEur; // USD to EUR
                                const electrolysisCAPEXannual = annualizeCAPEX(electrolysisCAPEX, discountRate, lifetime);
                                const electrolysisOPEX = elParams.opex * electrolysisPowerKW * lifetime * usdToEur; // Total OPEX over lifetime
                                const electrolysisOPEXannual = electrolysisOPEX / lifetime; // Annual OPEX
                                
                                // Electricity cost is included in wind costs (LCOE approach)
                                const electrolysisCostAnnual = electrolysisCAPEXannual + electrolysisOPEXannual;

                                // H2 Storage costs - from Python Code_Final.py lines 792-796
                                const h2StorageCAPEXperT = 33000 * usdToEur; // $/t to ‚Ç¨/t
                                const h2StorageCAPEX = h2StorageCapacity * h2StorageCAPEXperT;
                                const h2StorageCAPEXannual = annualizeCAPEX(h2StorageCAPEX, discountRate, lifetime);
                                const h2StorageOPEX = h2StorageCAPEX * 0.03 * lifetime; // 3% per year over lifetime
                                const h2StorageOPEXannual = h2StorageOPEX / lifetime;

                                // NH3 Storage costs - from Python Code_Final.py lines 799-803
                                // NH3 storage is calculated from ships, need to get actual capacity from simulation
                                // For optimization, use approximate: ships * target_per_ship
                                const nh3TargetPerShipT = (annualH2ProdT * 17/3) / 12; // Annual NH3 / ships_per_year
                                const nh3StorageCapacity = combo.nh3Ships * nh3TargetPerShipT;
                                const nh3StorageCAPEXperT = 810 * usdToEur; // $/t to ‚Ç¨/t
                                const nh3StorageCAPEX = nh3StorageCapacity * nh3StorageCAPEXperT;
                                const nh3StorageCAPEXannual = annualizeCAPEX(nh3StorageCAPEX, discountRate, lifetime);
                                const nh3StorageOPEX = nh3StorageCAPEX * 0.02 * lifetime; // 2% per year over lifetime
                                const nh3StorageOPEXannual = nh3StorageOPEX / lifetime;

                                // Water Tank costs - from Python Code_Final.py lines 848-854
                                const waterTankCAPEXperM3 = 50 * usdToEur; // $/m¬≥ to ‚Ç¨/m¬≥ (from Python line 850)
                                const waterTankCAPEX = combo.waterTank * waterTankCAPEXperM3;
                                const waterTankCAPEXannual = annualizeCAPEX(waterTankCAPEX, discountRate, lifetime);
                                const waterTankOPEX = waterTankCAPEX * 0.02 * lifetime; // 2% per year over lifetime
                                const waterTankOPEXannual = waterTankOPEX / lifetime;

                                const storageCostAnnual = h2StorageCAPEXannual + h2StorageOPEXannual + 
                                                         nh3StorageCAPEXannual + nh3StorageOPEXannual + 
                                                         waterTankCAPEXannual + waterTankOPEXannual;

                                // RO costs - from Python Code_Final.py lines 825-844
                                const roWaterKgPerKgH2 = 10.0; // From Python line 828
                                const roCAPEXperM3perDay = 1200 * usdToEur; // From Python line 829
                                const roOPEXfrac = 0.05; // From Python line 830
                                const roOPEXperM3 = 0; // From Python line 831
                                
                                const specKwhPerKgH2 = elParams.spec_kwh;
                                const h2KgPerHDesign = (electrolysisPowerMW * 1000) / specKwhPerKgH2;
                                const roM3PerHDesign = (h2KgPerHDesign * roWaterKgPerKgH2) / 1000.0;
                                const roM3PerDayDesign = roM3PerHDesign * 24.0;
                                
                                const roCAPEX = roCAPEXperM3perDay * roM3PerDayDesign;
                                const roCAPEXannual = annualizeCAPEX(roCAPEX, discountRate, lifetime);
                                const roOPEX = roCAPEX * roOPEXfrac * lifetime;
                                const annualWaterM3 = (annualH2ProdT * 1000 * roWaterKgPerKgH2) / 1000;
                                const roOPEXvar = roOPEXperM3 * annualWaterM3 * lifetime;
                                const roOPEXannual = (roOPEX + roOPEXvar) / lifetime;
                                const roCostAnnual = roCAPEXannual + roOPEXannual;

                                // Haber-Bosch costs - from Python Code_Final.py lines 806-811
                                const hbCapacityTNH3perDay = (annualH2ProdT * 17/3) / 365; // Approximate
                                const hbCapacityTNH3perYear = hbCapacityTNH3perDay * 365;
                                const hbCAPEXperTNH3perYear = 491.4 * usdToEur; // From Python (calculated)
                                const hbCAPEX = hbCAPEXperTNH3perYear * hbCapacityTNH3perYear;
                                const hbCAPEXannual = annualizeCAPEX(hbCAPEX, discountRate, lifetime);
                                const annualNH3ProdT = annualH2ProdT * 17/3;
                                const hbOPEXperTNH3 = 16.8 * 1000000 / annualNH3ProdT; // From Python
                                const hbOPEX = hbOPEXperTNH3 * annualNH3ProdT * lifetime;
                                const hbOPEXannual = hbOPEX / lifetime;
                                const hbCostAnnual = hbCAPEXannual + hbOPEXannual;

                                // N2 (ASU) costs - from Python Code_Final.py lines 813-822
                                const n2KgPerKgNH3 = 28.0 / 34.0;
                                const hbCapacityTNH3perH = hbCapacityTNH3perDay / 24.0;
                                const n2CapacityKgPerH = hbCapacityTNH3perH * 1000.0 * n2KgPerKgNH3;
                                const n2CAPEXperKgN2perH = 1700 * usdToEur; // From Python cost_params
                                const n2CAPEX = n2CAPEXperKgN2perH * n2CapacityKgPerH;
                                const n2CAPEXannual = annualizeCAPEX(n2CAPEX, discountRate, lifetime);
                                const n2OPEXfrac = 0.03; // From Python
                                const n2OPEX = n2CAPEX * n2OPEXfrac * lifetime;
                                const n2OPEXannual = n2OPEX / lifetime;
                                const n2CostAnnual = n2CAPEXannual + n2OPEXannual;

                                // Transport and Cracking costs (use current values as they don't depend on optimization params)
                                // Try to get from DOM, but use fallback calculation if not available
                                let transportCostAnnual = 0;
                                const transportCostElement = document.getElementById('transport_cost_annual');
                                if (transportCostElement && transportCostElement.textContent) {
                                    const transportCostText = transportCostElement.textContent.replace(' M‚Ç¨/year', '').replace(' M‚Ç¨/a', '').trim();
                                    transportCostAnnual = parseFloat(transportCostText) * 1000000;
                                    if (isNaN(transportCostAnnual)) transportCostAnnual = 0;
                                }
                                
                                let crackingCostAnnual = 0;
                                const crackingCostElement = document.getElementById('cracking_cost_annual');
                                if (crackingCostElement && crackingCostElement.textContent) {
                                    const crackingCostText = crackingCostElement.textContent.replace(' M‚Ç¨/year', '').replace(' M‚Ç¨/a', '').trim();
                                    crackingCostAnnual = parseFloat(crackingCostText) * 1000000;
                                    if (isNaN(crackingCostAnnual)) crackingCostAnnual = 0;
                                }
                                
                                // If both are 0, they might not be calculated yet - use 0 for now
                                // (These costs don't depend on optimization parameters anyway)

                                const totalAnnualCost = windCostAnnual + electrolysisCostAnnual + roCostAnnual + 
                                                       n2CostAnnual + hbCostAnnual + storageCostAnnual + 
                                                       transportCostAnnual + crackingCostAnnual;
                                
                                // Debug: Log cost components for first combination
                                if (iteration === 1) {
                                    console.log('=== COST COMPONENTS (First Combination) ===');
                                    console.log('Wind:', windCostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('Electrolysis:', electrolysisCostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('RO:', roCostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('N2:', n2CostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('HB:', hbCostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('Storage:', storageCostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('Transport:', transportCostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('Cracking:', crackingCostAnnual / 1000000, 'M‚Ç¨/a');
                                    console.log('Total:', totalAnnualCost / 1000000, 'M‚Ç¨/a');
                                }

                                // Calculate delivered H2 (with chain efficiency)
                                // Use annualH2ProdT directly - this is the production target
                                // annualH2ProdT is now in t/a (after conversion from kt/a), convert to kg/a: t ‚Üí kg = * 1000
                                const h2ReferenceKg = annualH2ProdT * 1000; // t to kg (t ‚Üí kg = * 1000)
                                
                                // Get chain efficiency parameters with safe defaults
                                // These should match the values from the input forms
                                let haberBoschLoss = parseFloat(getInput('haber_bosch_loss'));
                                if (isNaN(haberBoschLoss)) haberBoschLoss = 0;
                                
                                let storageLossRate = parseFloat(getInput('storage_loss_rate'));
                                if (isNaN(storageLossRate)) storageLossRate = 0;
                                
                                let nh3ShippingLoss = parseFloat(getInput('nh3_shipping_loss'));
                                if (isNaN(nh3ShippingLoss)) nh3ShippingLoss = 0;
                                
                                let crackingEfficiency = parseFloat(getInput('cracking_efficiency'));
                                if (isNaN(crackingEfficiency) || crackingEfficiency <= 0) crackingEfficiency = 100;
                                
                                // Calculate chain efficiency
                                const chainEfficiency = (1 - haberBoschLoss / 100) * 
                                                       (1 - storageLossRate / 100) * 
                                                       (1 - nh3ShippingLoss / 100) * 
                                                       (crackingEfficiency / 100);
                                
                                // Validate chain efficiency - must be positive and reasonable
                                if (!isFinite(chainEfficiency) || chainEfficiency <= 0 || chainEfficiency > 1) {
                                    console.warn('Invalid chainEfficiency:', chainEfficiency, 
                                               'haberBoschLoss:', haberBoschLoss,
                                               'storageLossRate:', storageLossRate,
                                               'nh3ShippingLoss:', nh3ShippingLoss,
                                               'crackingEfficiency:', crackingEfficiency,
                                               'for combo:', combo);
                                    continue; // Skip this combination
                                }
                                
                                const h2DeliveredAnnual = h2ReferenceKg * chainEfficiency;
                                
                                // Validate delivered H2 - must be positive
                                if (!isFinite(h2DeliveredAnnual) || h2DeliveredAnnual <= 0) {
                                    console.warn('Invalid h2DeliveredAnnual:', h2DeliveredAnnual, 
                                               'h2ReferenceKg:', h2ReferenceKg,
                                               'chainEfficiency:', chainEfficiency,
                                               'for combo:', combo);
                                    continue; // Skip this combination
                                }
                                
                                // Validate total cost - must be positive and finite
                                if (!isFinite(totalAnnualCost) || totalAnnualCost <= 0) {
                                    console.warn('Invalid totalAnnualCost:', totalAnnualCost, 'for combo:', combo);
                                    continue; // Skip this combination
                                }
                                
                                const costPerKg = totalAnnualCost / h2DeliveredAnnual;
                                
                                // Debug for first few combinations
                                if (iteration <= 3) {
                                    console.log(`=== Combination ${iteration} ===`);
                                    console.log('P_el:', combo.pel, 'MW');
                                    console.log('H2 Days:', combo.h2Days);
                                    console.log('NH3 Ships:', combo.nh3Ships);
                                    console.log('Water Tank:', combo.waterTank, 'm¬≥');
                                    console.log('H2 Reference:', h2ReferenceKg, 'kg/a');
                                    console.log('Chain Efficiency:', chainEfficiency);
                                    console.log('H2 Delivered:', h2DeliveredAnnual, 'kg/a');
                                    console.log('Total Annual Cost:', totalAnnualCost / 1000000, 'M‚Ç¨/a');
                                    console.log('Cost per kg:', costPerKg, '‚Ç¨/kg');
                                    console.log('Is Valid:', isFinite(costPerKg) && costPerKg > 0 && costPerKg < 1000);
                                }
                                
                                // Validate cost per kg - must be reasonable (0-1000 ‚Ç¨/kg)
                                if (isFinite(costPerKg) && costPerKg > 0 && costPerKg < 1000) {
                                    results.push({
                                        s: combo.s,
                                        pel: combo.pel,
                                        h2Days: combo.h2Days,
                                        h2Storage: h2StorageCapacity,
                                        nh3Ships: combo.nh3Ships,
                                        nh3Storage: nh3StorageCapacity,
                                        waterTank: combo.waterTank,
                                        windCapacity: windCapacityMW,
                                        costPerKg: costPerKg,
                                        totalAnnualCost: totalAnnualCost,
                                        h2Delivered: h2DeliveredAnnual,
                                        chainEfficiency: chainEfficiency
                                    });
                                } else {
                                    if (iteration <= 3) {
                                        console.warn('REJECTED - Invalid costPerKg:', costPerKg, 
                                                   'totalAnnualCost:', totalAnnualCost,
                                                   'h2DeliveredAnnual:', h2DeliveredAnnual);
                                    }
                                }
                }

                // Update progress
                const progress = (iteration / combinations.length) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
                statusText.textContent = 'Berechne... ' + iteration + ' / ' + combinations.length + ' Konfigurationen';

                currentIndex = batchEnd;

                // Continue with next batch or finish
                if (currentIndex < combinations.length) {
                    setTimeout(processBatch, 10); // Small delay to allow UI update
                } else {
                    // All combinations processed, now display results
                    finishOptimization();
                }
            }

            function finishOptimization() {
                statusText.textContent = 'Sortiere Ergebnisse...';
                
                console.log('=== OPTIMIERUNG ABGESCHLOSSEN ===');
                console.log('Total results found:', results.length);
                console.log('Total combinations processed:', iteration);
                
                if (results.length === 0) {
                    console.error('=== FEHLER: KEINE G√úLTIGEN ERGEBNISSE ===');
                    console.error('Bitte pr√ºfen Sie:');
                    console.error('1. H‚ÇÇ-Produktion (h2_production):', getInput('h2_production'));
                    console.error('2. Haber-Bosch Verlust:', getInput('haber_bosch_loss'));
                    console.error('3. Storage Verlust:', getInput('storage_loss_rate'));
                    console.error('4. NH‚ÇÉ Shipping Verlust:', getInput('nh3_shipping_loss'));
                    console.error('5. Cracking Effizienz:', getInput('cracking_efficiency'));
                    console.error('6. Discount Rate:', getInput('discount_rate'));
                    console.error('7. Lifetime:', getInput('project_lifetime'));
                    
                    // Try to calculate what went wrong
                    const testH2Prod = getInput('h2_production') || 120.799;
                    const testChainEff = (1 - (getInput('haber_bosch_loss') || 0) / 100) * 
                                        (1 - (getInput('storage_loss_rate') || 0) / 100) * 
                                        (1 - (getInput('nh3_shipping_loss') || 0) / 100) * 
                                        ((getInput('cracking_efficiency') || 100) / 100);
                    console.error('Test H‚ÇÇ Production:', testH2Prod, 'kt/a');
                    console.error('Test Chain Efficiency:', testChainEff);
                    console.error('Test H‚ÇÇ Delivered:', testH2Prod * 1000000 * testChainEff, 'kg/a'); // kt ‚Üí kg = * 1000000
                    
                    alert('Keine g√ºltigen Ergebnisse gefunden.\n\n' +
                          'M√∂gliche Ursachen:\n' +
                          '1. Ketteneffizienz ist 0 oder ung√ºltig\n' +
                          '2. H‚ÇÇ-Produktion ist 0\n' +
                          '3. Kostenberechnung fehlgeschlagen\n\n' +
                          'Bitte Browser-Konsole (F12) √∂ffnen f√ºr Details.\n' +
                          'Dort finden Sie alle Parameter-Werte.');
                    progressDiv.style.display = 'none';
                    return;
                }
                
                // Sort by cost
                results.sort((a, b) => a.costPerKg - b.costPerKg);
                
                console.log('Best result:', results[0]);
                console.log('Top 5 results:', results.slice(0, 5).map(r => ({
                    pel: r.pel,
                    cost: r.costPerKg.toFixed(4),
                    chainEff: r.chainEfficiency?.toFixed(4)
                })));
                
                const best = results[0];

                // Baue eine Liste von bis zu 20 deutlich unterschiedlichen Konfigurationen
                const maxRows = 20;
                const topConfigs = [];
                const seenKeys = new Set();
                for (const r of results) {
                    const key = [
                        r.pel.toFixed(0),
                        r.h2Days.toFixed(1),
                        r.nh3Ships.toFixed(2),
                        r.waterTank.toFixed(0)
                    ].join('|');
                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        topConfigs.push(r);
                    }
                    if (topConfigs.length >= maxRows) break;
                }

                statusText.textContent = 'Ergebnisse werden angezeigt...';

                // Display results
                document.getElementById('opt_result_s').textContent = best.s.toFixed(2) + ' (' + (best.s * 100).toFixed(0) + '% Windkapazit√§t)';
                document.getElementById('opt_result_pel').textContent = best.pel.toFixed(0) + ' MW';
                document.getElementById('opt_result_h2_storage').textContent = best.h2Days.toFixed(1) + ' Tage (' + best.h2Storage.toFixed(0) + ' t)';
                document.getElementById('opt_result_nh3_storage').textContent = best.nh3Ships.toFixed(2) + ' Schiffe (' + best.nh3Storage.toFixed(0) + ' t)';
                document.getElementById('opt_result_water_tank').textContent = best.waterTank.toFixed(0) + ' m¬≥';
                document.getElementById('opt_result_cost').textContent = best.costPerKg.toFixed(4) + ' ‚Ç¨/kg';

                // Hide progress bar
                progressDiv.style.display = 'none';
                statusText.textContent = 'Optimierung abgeschlossen!';

                // Aktuelles Szenario erfassen
                if (currentCostPerKg > 0 && isFinite(currentCostPerKg)) {
                    document.getElementById('comparison_current_cost').textContent = currentCostPerKg.toFixed(4) + ' ‚Ç¨/kg';
                } else {
                    document.getElementById('comparison_current_cost').textContent = 'Nicht verf√ºgbar';
                }
                document.getElementById('comparison_current_pel').textContent = currentPel.toFixed(0);
                document.getElementById('comparison_current_h2').textContent = currentH2Storage.toFixed(0) + ' t';
                document.getElementById('comparison_current_nh3').textContent = currentNH3Storage.toFixed(0) + ' t';

                // Ergebnis der internen Raster-Optimierung speichern und anzeigen
                window.internalOptBest = {
                    costPerKg: best.costPerKg,
                    pel: best.pel,
                    h2Storage: best.h2Storage,
                    nh3Ships: best.nh3Ships,
                    nh3Storage: best.nh3Storage
                };

                document.getElementById('comparison_internal_cost').textContent = best.costPerKg.toFixed(4) + ' ‚Ç¨/kg';
                document.getElementById('comparison_internal_pel').textContent = best.pel.toFixed(0);
                document.getElementById('comparison_internal_h2').textContent = best.h2Storage.toFixed(0) + ' t';
                document.getElementById('comparison_internal_nh3').textContent = best.nh3Storage.toFixed(0) + ' t';

                // Keine explizite Kosteneinsparung mehr ‚Äì es werden nur die absoluten Kosten je Konfiguration gezeigt.

                // Design-Empfehlungen nach neuer Optimierung aktualisieren
                try {
                    generateDesignRecommendations();
                } catch (e) {
                    console.warn('Design-Empfehlungen konnten nicht aktualisiert werden:', e);
                }

                // Populate table
                const tableBody = document.getElementById('optimizationTableBody');
                if (tableBody && topConfigs.length > 0) {
                    tableBody.innerHTML = '';
                    const bestCost = topConfigs[0].costPerKg;
                    
                    topConfigs.forEach((config, index) => {
                        const row = document.createElement('tr');
                        const deltaPercent = ((config.costPerKg - bestCost) / bestCost * 100).toFixed(3);
                        const deltaAbs = (config.costPerKg - bestCost).toFixed(6);
                        
                        // Calculate actual storage sizes
                        const h2StorageT = config.h2Storage.toFixed(0);
                        const nh3StorageT = config.nh3Storage.toFixed(0);
                        
                        row.style.background = index === 0 ? '#ffebee' : (index % 2 === 0 ? '#f9f9f9' : 'white');
                        row.innerHTML = `
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: ${index === 0 ? '700' : '400'};">${index + 1}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${config.s.toFixed(2)} (${(config.s * 100).toFixed(0)}%)</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${config.pel.toFixed(0)} MW</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${config.h2Days.toFixed(1)} Tage (${h2StorageT} t)</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${config.nh3Ships.toFixed(2)} Schiffe (${nh3StorageT} t)</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${config.waterTank.toFixed(0)} m¬≥</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: ${index === 0 ? '700' : '400'}; color: ${index === 0 ? '#DC143C' : 'inherit'};">${config.costPerKg.toFixed(4)} ‚Ç¨/kg</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${index === 0 ? '-' : '+' + deltaAbs + ' (+' + deltaPercent + '%)'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

                // Create chart
                if (optimizationChart) {
                    optimizationChart.destroy();
                }

                const ctx = document.getElementById('optimizationChart').getContext('2d');
                optimizationChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topConfigs.map((r, i) => 'Konfig. ' + (i + 1)),
                        datasets: [{
                            label: 'Kosten (‚Ç¨/kg H‚ÇÇ)',
                            data: topConfigs.map(r => r.costPerKg),
                            backgroundColor: topConfigs.map((r, i) => i === 0 ? '#DC143C' : '#FF6347'),
                            borderColor: topConfigs.map((r, i) => i === 0 ? '#8B0000' : '#DC143C'),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Top 20 Optimierungsergebnisse',
                                color: '#DC143C',
                                font: {
                                    size: 16,
                                    weight: '700'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Kosten: ' + context.parsed.y.toFixed(4) + ' ‚Ç¨/kg';
                                    },
                                    afterLabel: function(context) {
                                        const idx = context.dataIndex;
                                        const r = topConfigs[idx];
                                        return [
                                            's (Wind): ' + r.s.toFixed(2) + ' (' + (r.s * 100).toFixed(0) + '%)',
                                            'P_el: ' + r.pel.toFixed(0) + ' MW',
                                            'H‚ÇÇ Storage: ' + r.h2Days.toFixed(1) + ' Tage',
                                            'NH‚ÇÉ Storage: ' + r.nh3Ships.toFixed(2) + ' Schiffe',
                                            'Water Tank: ' + r.waterTank.toFixed(0) + ' m¬≥'
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Kosten (‚Ç¨/kg H‚ÇÇ)',
                                    color: '#DC143C',
                                    font: {
                                        size: 13,
                                        weight: '600'
                                    }
                                },
                                ticks: {
                                    color: '#DC143C',
                                    precision: 4,
                                    callback: function(value, index, ticks) {
                                        // Use the actual value, not a fixed one
                                        if (value === 0) return '0 ‚Ç¨/kg';
                                        return value.toFixed(4) + ' ‚Ç¨/kg';
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#DC143C'
                                }
                            }
                        }
                    }
                });

                // Results are already displayed above
            }

            // Start optimization
            processBatch();
        }
    </script>
</body>
</html>
